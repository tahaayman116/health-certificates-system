<!-- <!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>الشهادة الصحية</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .certificate-container {
            max-width: 800px;
            margin: 50px auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .certificate-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .certificate-body {
            padding: 40px;
        }
        
        .person-image {
            width: 120px;
            height: 120px;
            border-radius: 10px;
            object-fit: cover;
            border: 3px solid #667eea;
            margin-bottom: 20px;
        }
        
        .info-row {
            margin-bottom: 15px;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }
        
        .info-label {
            font-weight: 600;
            color: #495057;
            margin-bottom: 5px;
        }
        
        .info-value {
            color: #212529;
            font-size: 1.1rem;
        }
        
        .status-active {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            display: inline-block;
            font-weight: 600;
        }
        
        .status-expired {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            display: inline-block;
            font-weight: 600;
        }
        
        .loading-spinner {
            text-align: center;
            padding: 100px 0;
        }
        
        .error-message {
            text-align: center;
            padding: 100px 0;
            color: #dc3545;
        }
        
        .print-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            color: white;
            padding: 12px 30px;
            border-radius: 10px;
            font-weight: 600;
            margin: 20px 0;
        }
        
        @media print {
            .print-btn, .no-print {
                display: none !important;
            }
            
            body {
                background: white;
            }
            
            .certificate-container {
                box-shadow: none;
                margin: 0;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="loadingSpinner" class="loading-spinner">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">جاري التحميل...</span>
            </div>
            <p class="mt-3">جاري تحميل بيانات الشهادة...</p>
        </div>
        
        <div id="errorMessage" class="error-message" style="display: none;">
            <i class="fas fa-exclamation-triangle fa-3x mb-3"></i>
            <h3>عذراً، لم يتم العثور على الشهادة</h3>
            <p>يرجى التأكد من صحة الرابط أو الاتصال بالدعم الفني</p>
        </div>
        
        <div id="certificateContent" class="certificate-container" style="display: none;">
            <div class="certificate-header">
                <h1><i class="fas fa-certificate me-2"></i>الشهادة الصحية</h1>
                <p class="mb-0">وزارة البلديات والإسكان - المملكة العربية السعودية</p>
            </div>
            
            <div class="certificate-body">
                <div class="text-center mb-4">
                    <img id="personImage" class="person-image" src="" alt="صورة الشخص" style="display: none;">
                    <div id="noImage" class="text-center" style="display: none;">
                        <i class="fas fa-user-circle fa-5x text-muted"></i>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="info-row">
                            <div class="info-label">الأمانة</div>
                            <div class="info-value" id="amanah">-</div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="info-row">
                            <div class="info-label">البلدية</div>
                            <div class="info-value" id="municipality">-</div>
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="info-row">
                            <div class="info-label">الاسم</div>
                            <div class="info-value" id="fullName">-</div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="info-row">
                            <div class="info-label">رقم الهوية</div>
                            <div class="info-value" id="idNumber">-</div>
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="info-row">
                            <div class="info-label">الجنس</div>
                            <div class="info-value" id="gender">-</div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="info-row">
                            <div class="info-label">الجنسية</div>
                            <div class="info-value" id="nationality">-</div>
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="info-row">
                            <div class="info-label">رقم الشهادة الصحية</div>
                            <div class="info-value" id="certificateNumber">-</div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="info-row">
                            <div class="info-label">المهنة</div>
                            <div class="info-value" id="profession">-</div>
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="info-row">
                            <div class="info-label">تاريخ الإصدار</div>
                            <div class="info-value" id="issueDate">-</div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="info-row">
                            <div class="info-label">تاريخ الانتهاء</div>
                            <div class="info-value" id="expiryDate">-</div>
                        </div>
                    </div>
                </div>
                
                <div class="info-row">
                    <div class="info-label">نوع البرنامج التثقيفي</div>
                    <div class="info-value" id="programType">-</div>
                </div>
                
                <div class="row">
                    <div class="col-md-4">
                        <div class="info-row">
                            <div class="info-label">رقم الرخصة</div>
                            <div class="info-value" id="licenseNumber">-</div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="info-row">
                            <div class="info-label">اسم المنشأة</div>
                            <div class="info-value" id="facilityName">-</div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="info-row">
                            <div class="info-label">رقم المنشأة</div>
                            <div class="info-value" id="facilityNumber">-</div>
                        </div>
                    </div>
                </div>
                
                <div class="text-center mt-4">
                    <div id="certificateStatus"></div>
                    <button class="btn print-btn no-print" onclick="window.print()">
                        <i class="fas fa-print me-2"></i>
                        طباعة الشهادة
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, getDocs, query, where } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDOVmQ5HY0KrsaITu3Sl55-gjPwoKLPguE",
            authDomain: "certificates-8b2bb.firebaseapp.com",
            projectId: "certificates-8b2bb",
            storageBucket: "certificates-8b2bb.firebasestorage.app",
            messagingSenderId: "865099561039",
            appId: "1:865099561039:web:644ec7c3ffce81cd77523a",
            measurementId: "G-C2P94SNR6D"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Make Firebase available globally
        window.db = db;
        window.firebaseModules = {
            collection, getDocs, query, where
        };
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // الحصول على معرف الشهادة من URL
        function getCertificateId() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('id');
        }

        // تحميل بيانات الشهادة
        async function loadCertificate() {
            const certificateId = getCertificateId();
            
            if (!certificateId) {
                showError();
                return;
            }

            try {
                // محاولة تحميل البيانات من Firebase
                const q = window.firebaseModules.query(
                    window.firebaseModules.collection(window.db, 'certificates'),
                    window.firebaseModules.where('uniqueId', '==', certificateId)
                );
                
                const querySnapshot = await window.firebaseModules.getDocs(q);
                
                if (!querySnapshot.empty) {
                    const certificateData = querySnapshot.docs[0].data();
                    displayCertificate(certificateData);
                } else {
                    // إذا لم توجد البيانات في Firebase، جرب البيانات المحلية
                    loadLocalCertificate(certificateId);
                }
                
            } catch (error) {
                console.error('خطأ في تحميل البيانات من Firebase:', error);
                // في حالة فشل Firebase، استخدم البيانات المحلية
                loadLocalCertificate(certificateId);
            }
        }

        // تحميل البيانات المحلية
        function loadLocalCertificate(certificateId) {
            const localData = localStorage.getItem('certificates');
            if (localData) {
                const certificates = JSON.parse(localData);
                const certificate = certificates.find(cert => cert.uniqueId === certificateId);
                
                if (certificate) {
                    displayCertificate(certificate);
                } else {
                    showError();
                }
            } else {
                showError();
            }
        }

        // عرض بيانات الشهادة
        function displayCertificate(data) {
            document.getElementById('loadingSpinner').style.display = 'none';
            document.getElementById('certificateContent').style.display = 'block';
            
            // ملء البيانات
            document.getElementById('amanah').textContent = data.amanah || '-';
            document.getElementById('municipality').textContent = data.municipality || '-';
            document.getElementById('fullName').textContent = data.fullName || '-';
            document.getElementById('idNumber').textContent = data.idNumber || '-';
            document.getElementById('gender').textContent = data.gender || '-';
            document.getElementById('nationality').textContent = data.nationality || '-';
            document.getElementById('certificateNumber').textContent = data.certificateNumber || '-';
            document.getElementById('profession').textContent = data.profession || '-';
            document.getElementById('issueDate').textContent = formatDate(data.issueDate) || '-';
            document.getElementById('expiryDate').textContent = formatDate(data.expiryDate) || '-';
            document.getElementById('programType').textContent = data.programType || '-';
            document.getElementById('licenseNumber').textContent = data.licenseNumber || '-';
            document.getElementById('facilityName').textContent = data.facilityName || '-';
            document.getElementById('facilityNumber').textContent = data.facilityNumber || '-';
            
            // عرض الصورة
            if (data.imageBase64) {
                document.getElementById('personImage').src = data.imageBase64;
                document.getElementById('personImage').style.display = 'block';
                document.getElementById('noImage').style.display = 'none';
            } else if (data.imageUrl) {
                document.getElementById('personImage').src = data.imageUrl;
                document.getElementById('personImage').style.display = 'block';
                document.getElementById('noImage').style.display = 'none';
            } else {
                document.getElementById('personImage').style.display = 'none';
                document.getElementById('noImage').style.display = 'block';
            }
            
            // عرض حالة الشهادة
            const isActive = new Date(data.expiryDate) > new Date();
            const statusElement = document.getElementById('certificateStatus');
            
            if (isActive) {
                statusElement.innerHTML = '<span class="status-active"><i class="fas fa-check-circle me-2"></i>الشهادة سارية المفعول</span>';
            } else {
                statusElement.innerHTML = '<span class="status-expired"><i class="fas fa-times-circle me-2"></i>الشهادة منتهية الصلاحية</span>';
            }
        }

        // عرض رسالة خطأ
        function showError() {
            document.getElementById('loadingSpinner').style.display = 'none';
            document.getElementById('errorMessage').style.display = 'block';
        }

        // تنسيق التاريخ
        function formatDate(dateString) {
            if (!dateString) return '-';
            
            const date = new Date(dateString);
            const options = { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric',
                calendar: 'gregory'
            };
            
            return date.toLocaleDateString('ar-SA', options);
        }

        // تحميل البيانات عند بدء الصفحة
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                loadCertificate();
            }, 1000);
        });
    </script>
</body>
</html> -->
