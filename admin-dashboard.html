<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لوحة تحكم الإدارة - نظام الشهادات الصحية</title>
    
    <!-- إعدادات الأمان للمتصفح -->
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
    <meta name="theme-color" content="#498a69" media="(prefers-color-scheme: light)">
    <meta name="theme-color" content="#3d423d" media="(prefers-color-scheme: dark)">
    <link rel="canonical" href="https://health-certificates-system.netlify.app/admin-dashboard.html">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #3d423d;
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            color: #ffffff;
            font-size: 17px;
            line-height: 1.5;
        }
        
        .navbar {
            background: #498a69;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            border-bottom: 3px solid #708556;
        }
        
        .navbar-brand {
            font-weight: 600;
            font-size: 1.4rem;
            color: #fff !important;
        }
        
        .main-container {
            padding: 20px 0;
        }
        
        .card {
            border: none;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            background-color: #4a4f4a;
            color: #ffffff;
            margin-bottom: 20px;
        }
        
        .card-header {
            background: #708556;
            color: white;
            border-radius: 8px 8px 0 0 !important;
            padding: 15px 20px;
            border: none;
            font-weight: 500;
        }
        
        .form-control, .form-select {
            border-radius: 6px;
            border: 2px solid #e9ecef;
            padding: 12px 15px;
            transition: all 0.3s ease;
        }
        
        .form-control:focus, .form-select:focus {
            border-color: #007bff;
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
        }
        
        .btn-primary {
            background: #007bff;
            border: none;
            border-radius: 6px;
            padding: 12px 30px;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .btn-primary:hover {
            background: #0056b3;
            transform: translateY(-1px);
        }
        
        .btn-outline-danger {
            border-radius: 6px;
            padding: 8px 16px;
            font-size: 0.9rem;
        }
        
        .btn-outline-primary {
            border-radius: 6px;
            padding: 8px 16px;
            font-size: 0.9rem;
        }
        
        .table {
            background: #4a4f4a;
            border-radius: 8px;
            overflow: hidden;
            color: #ffffff;
        }
        
        .table th {
            background: #708556;
            border: none;
            font-weight: 600;
            color: #fff;
        }
        
        .table td {
            border: none;
            border-bottom: 1px solid #5a5f5a;
            vertical-align: middle;
            color: #ffffff;
        }
        
        .image-preview {
            max-width: 100px;
            max-height: 100px;
            border-radius: 6px;
            margin-top: 10px;
            border: 2px solid #e9ecef;
        }
        
        .form-label {
            font-weight: 500;
            color: #495057;
            margin-bottom: 8px;
        }
        
        .logout-btn {
            background: none;
            border: none;
            color: #dc3545;
            font-size: 0.9rem;
        }
        
        .logout-btn:hover {
            color: #c82333;
        }
        
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .btn-danger {
            border-radius: 10px;
            padding: 8px 20px;
            font-weight: 600;
        }
        
        .stats-card {
            background: linear-gradient(135deg, #498a69 0%, #3a6b52 100%);
            color: white;
            text-align: center;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
        }
        
        .stats-number {
            font-size: 3rem;
            font-weight: 700;
            margin-bottom: 10px;
        }
        
        .table {
            border-radius: 10px;
            overflow: hidden;
        }
        
        .table thead th {
            background-color: #708556;
            border: none;
            font-weight: 600;
            padding: 15px;
            color: #fff;
        }
        
        .table tbody td {
            padding: 15px;
            vertical-align: middle;
            border-color: #5a5f5a;
            color: #ffffff !important;
        }
        
        /* إصلاح النصوص السوداء في الجداول */
        .table td, .table th, .table tbody tr td {
            color: #ffffff !important;
        }
        
        /* تكبير الخطوط مثل الآيفون */
        .btn {
            font-size: 16px;
            font-weight: 500;
            padding: 12px 20px;
        }
        
        .card-header h5 {
            font-size: 20px;
            font-weight: 600;
        }
        
        .form-label {
            font-size: 16px;
            font-weight: 500;
        }
        
        .form-control {
            font-size: 16px;
            padding: 12px 16px;
        }
        
        .table th {
            font-size: 16px;
            font-weight: 600;
        }
        
        .table td {
            font-size: 15px;
        }
        
        .stats-number {
            font-size: 2.5rem;
            font-weight: 700;
        }
        
        .navbar-brand {
            font-size: 1.5rem;
            font-weight: 600;
        }
        
        .certificate-image {
            width: 50px;
            height: 50px;
            object-fit: cover;
            border-radius: 8px;
        }
        
        .status-badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }
        
        .image-preview {
            max-width: 200px;
            max-height: 200px;
            border-radius: 10px;
            margin-top: 10px;
        }
        
        .form-label {
            font-weight: 600;
            color: #495057;
            margin-bottom: 8px;
        }
        
        .required {
            color: #dc3545;
        }
        
        /* Responsive Design */
        @media (max-width: 768px) {
            .stats-card {
                margin-bottom: 15px;
            }
            
            .table-responsive {
                font-size: 0.85rem;
            }
            
            .btn-group .btn {
                padding: 4px 8px;
                font-size: 0.75rem;
            }
            
            .certificate-image {
                width: 35px;
                height: 35px;
            }
            
            .card-body {
                padding: 15px;
            }
            
            .form-control, .form-select {
                padding: 8px 12px;
                font-size: 0.9rem;
            }
        }
        
        @media (max-width: 576px) {
            .main-container {
                padding: 10px 0;
            }
            
            .card {
                margin-bottom: 15px;
            }
            
            .stats-number {
                font-size: 1.5rem;
            }
            
            .table th, .table td {
                padding: 8px 4px;
                font-size: 0.8rem;
            }
            
            .btn-group {
                flex-direction: column;
                width: 100%;
            }
            
            .btn-group .btn {
                margin-bottom: 2px;
                border-radius: 4px !important;
            }
        }
        
        /* تحسين الجدول */
        .table-hover tbody tr:hover {
            background-color: #5a5f5a;
        }
        
        /* ألوان النصوص المحسنة */
        .text-muted {
            color: #d0d0d0 !important;
        }
        
        .small, small {
            color: #e0e0e0 !important;
        }
        
        h1, h2, h3, h4, h5, h6 {
            color: #ffffff !important;
        }
        
        /* ألوان الأزرار المحسنة */
        .btn-primary {
            background-color: #708556;
            border-color: #708556;
        }
        
        .btn-primary:hover {
            background-color: #5a6b44;
            border-color: #5a6b44;
        }
        
        .btn-outline-primary {
            color: #708556;
            border-color: #708556;
        }
        
        .btn-outline-primary:hover {
            background-color: #708556;
            border-color: #708556;
            color: #fff;
        }
        
        /* ألوان التبويبات */
        .nav-tabs .nav-link {
            color: #ffffff;
            border-color: transparent;
        }
        
        .nav-tabs .nav-link.active {
            color: #fff;
            background-color: #708556;
            border-color: #708556;
        }
        
        .nav-tabs .nav-link:hover {
            color: #ffffff;
            border-color: #5a5f5a;
            background-color: rgba(112, 133, 86, 0.2);
        }
        
        /* ألوان الأزرار الجديدة */
        .btn-warning {
            background-color: #f39c12;
            border-color: #f39c12;
            color: #fff;
        }
        
        .btn-warning:hover {
            background-color: #e67e22;
            border-color: #e67e22;
            color: #fff;
        }
        
        .btn-info {
            background-color: #3498db;
            border-color: #3498db;
            color: #fff;
        }
        
        .btn-info:hover {
            background-color: #2980b9;
            border-color: #2980b9;
            color: #fff;
        }
        
        /* تحسين ألوان الفورم */
        .form-label {
            color: #ffffff !important;
            font-weight: 500;
        }
        
        .form-control {
            background-color: #5a5f5a;
            border-color: #708556;
            color: #ffffff;
        }
        
        .form-control:focus {
            background-color: #5a5f5a;
            border-color: #708556;
            color: #ffffff;
            box-shadow: 0 0 0 0.2rem rgba(112, 133, 86, 0.25);
        }
        
        .form-control::placeholder {
            color: #d0d0d0;
        }
        
        /* إخفاء الأقسام حسب الاختيار من البداية */
        body.certificates-only .medical-leaves-section,
        body.certificates-only .medical-leaves-stats {
            display: none !important;
        }
        
        body.medical-leaves-only .certificates-section,
        body.medical-leaves-only .certificates-stats {
            display: none !important;
        }
        
        /* تخصيص لون رابط الإجازات المرضية */
        .navbar-nav a[href="/medical-leaves.html"] {
            color: #8c515b !important;
            font-weight: bold !important;
        }
        
        .navbar-nav a[href="/medical-leaves.html"]:hover {
            color: #a85d68 !important;
            background-color: rgba(140, 81, 91, 0.1) !important;
        }
        
        .btn-group .btn {
            margin: 0 1px;
        }
        
        .badge {
            font-size: 0.75rem;
        }
        
        /* Toast notification */
        .toast-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            opacity: 0.95;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            animation: slideInRight 0.3s ease-out;
        }
        
        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 0.95;
            }
        }
        
        /* Modern Search Bar */
        .search-container {
            flex-shrink: 0;
        }
        
        .search-box {
            position: relative;
            width: 320px;
            background: linear-gradient(145deg, #ffffff 0%, #f8f9fa 100%);
            border-radius: 25px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1), inset 0 1px 0 rgba(255,255,255,0.6);
            border: 2px solid #e9ecef;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            overflow: hidden;
        }
        
        .search-box:hover {
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
            border-color: #007bff;
        }
        
        .search-box:focus-within {
            box-shadow: 0 4px 20px rgba(0, 123, 255, 0.3);
            border-color: #007bff;
            transform: translateY(-1px);
        }
        
        .search-box:focus-within .search-icon {
            color: #007bff;
            transform: translateY(-50%) scale(1.1);
        }
        
        .search-input {
            width: 100%;
            border: none;
            outline: none;
            padding: 12px 50px 12px 45px;
            font-size: 14px;
            background: transparent;
            color: #333;
        }
        
        .search-input::placeholder {
            color: #adb5bd;
            font-style: italic;
        }
        
        .search-icon {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #6c757d;
            font-size: 16px;
            z-index: 2;
            transition: all 0.3s ease;
        }
        
        .clear-btn {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: linear-gradient(145deg, #ff6b6b, #ee5a52);
            border: none;
            border-radius: 50%;
            width: 26px;
            height: 26px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 3;
            box-shadow: 0 2px 8px rgba(238, 90, 82, 0.3);
        }
        
        .clear-btn:hover {
            background: linear-gradient(145deg, #ff5252, #d32f2f);
            transform: translateY(-50%) scale(1.15);
            box-shadow: 0 4px 12px rgba(238, 90, 82, 0.4);
        }
        
        .clear-btn:active {
            transform: translateY(-50%) scale(0.9);
            box-shadow: 0 1px 4px rgba(238, 90, 82, 0.2);
        }
        
        /* Responsive Search */
        @media (max-width: 768px) {
            .card-header .d-flex {
                flex-direction: column;
                gap: 15px;
                align-items: stretch !important;
            }
            
            .search-box {
                width: 100%;
                max-width: none;
            }
            
            .search-input {
                padding: 14px 50px 14px 45px;
                font-size: 16px;
            }
        }
        
        @media (max-width: 576px) {
            .search-box {
                border-radius: 20px;
            }
            
            .search-input {
                padding: 12px 45px 12px 40px;
            }
            
            .search-icon {
                left: 12px;
                font-size: 14px;
            }
            
            .clear-btn {
                right: 8px;
                width: 22px;
                height: 22px;
                font-size: 9px;
            }
        }
        
        /* Highlight search results */
        .highlight {
            background-color: #fff3cd;
            padding: 1px 3px;
            border-radius: 3px;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container">
            <a class="navbar-brand" href="#">
                <i class="fas fa-certificate me-2"></i>
                نظام الشهادات الصحية
            </a>
            <div class="navbar-nav ms-auto">
                <button type="button" class="btn btn-warning me-2" onclick="window.location.href='work-selection.html'">
                    <i class="fas fa-exchange-alt me-2"></i>
                    تغيير القسم
                </button>
                <button type="button" class="btn btn-info me-2" onclick="window.location.href='/medical-leaves.html'">
                    <i class="fas fa-calendar-alt me-2"></i>
                    الإجازات المرضية
                </button>
                <button type="button" class="btn btn-danger" onclick="logout()">
                    <i class="fas fa-sign-out-alt me-2"></i>
                    تسجيل الخروج
                </button>
            </div>
        </div>
    </nav>

    <div class="container main-container">
        <!-- Statistics -->
        <div class="row mb-4 certificates-stats">
            <div class="col-md-6">
                <div class="stats-card">
                    <div class="stats-number" id="totalCertificates">0</div>
                    <div>إجمالي الشهادات</div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="stats-card" style="background: linear-gradient(135deg, #708556 0%, #5a6b44 100%);">
                    <div class="stats-number" id="todayCertificates">0</div>
                    <div>شهادات اليوم</div>
                </div>
            </div>
        </div>

        <!-- Medical Leaves Statistics -->
        <div class="row mb-4 medical-leaves-stats">
            <div class="col-md-6">
                <div class="stats-card" style="background: linear-gradient(135deg, #6ba085 0%, #5a8a70 100%);">
                    <div class="stats-number" id="totalMedicalLeaves">0</div>
                    <div>إجمالي الإجازات المرضية</div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="stats-card" style="background: linear-gradient(135deg, #8c515b 0%, #6d3e47 100%);">
                    <div class="stats-number" id="todayMedicalLeaves">0</div>
                    <div>إجازات مرضية اليوم</div>
                </div>
            </div>
        </div>

        <!-- Navigation Tabs -->
        <div class="row mb-4">
            <div class="col-12">
                <ul class="nav nav-tabs" id="managementTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="active-tab" data-bs-toggle="tab" data-bs-target="#active-content" type="button" role="tab">
                            <i class="fas fa-certificate me-2"></i>الشهادات النشطة
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="deleted-tab" data-bs-toggle="tab" data-bs-target="#deleted-content" type="button" role="tab" onclick="loadDeletedItems()">
                            <i class="fas fa-trash-restore me-2"></i>المحذوفات
                        </button>
                    </li>
                </ul>
            </div>
        </div>

        <div class="tab-content" id="managementTabsContent">
            <!-- Active Content Tab -->
            <div class="tab-pane fade show active" id="active-content" role="tabpanel">

        <!-- Add Certificate Form -->
        <div class="row mb-4 certificates-section">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-plus-circle me-2"></i>
                            إضافة شهادة صحية جديدة
                        </h5>
                    </div>
                    <div class="card-body">
                        <form id="certificateForm">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">الأمانة</label>
                                    <input type="text" class="form-control" id="amanah">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">البلدية</label>
                                    <input type="text" class="form-control" id="municipality">
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">الاسم</label>
                                    <input type="text" class="form-control" id="fullName">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">رقم الهوية</label>
                                    <input type="text" class="form-control" id="idNumber">
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">الجنس</label>
                                    <select class="form-select" id="gender">
                                        <option value="">اختر الجنس</option>
                                        <option value="ذكر">ذكر</option>
                                        <option value="أنثى">أنثى</option>
                                    </select>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">الجنسية</label>
                                    <input type="text" class="form-control" id="nationality">
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">رقم الشهادة الصحية</label>
                                    <input type="text" class="form-control" id="certificateNumber">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">المهنة</label>
                                    <input type="text" class="form-control" id="profession">
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">تاريخ الإصدار (ميلادي)</label>
                                    <input type="text" class="form-control" id="issueDate" placeholder="مثال: 2024/03/15" onchange="calculateExpiryDate()">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">تاريخ الانتهاء (ميلادي)</label>
                                    <input type="text" class="form-control" id="expiryDate" placeholder="مثال: 2025/03/15">
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">نوع الشهادة</label>
                                    <select class="form-select" id="certificateType" title="اختر نوع الشهادة">
                                        <option value="الشهادة الصحية الموحدة">الشهادة الصحية الموحدة</option>
                                        <option value="شهادة صحية">شهادة صحية</option>
                                        <option value="الشهادة الصحية السنوية">الشهادة الصحية السنوية</option>
                                    </select>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">نوع البرنامج التثقيفي</label>
                                    <input type="text" class="form-control" id="programType" placeholder="أدخل نوع البرنامج التثقيفي">
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">رقم الرخصة</label>
                                    <input type="text" class="form-control" id="licenseNumber">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">اسم المنشأة</label>
                                    <input type="text" class="form-control" id="facilityName">
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">رقم المنشأة</label>
                                <input type="text" class="form-control" id="facilityNumber">
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">تاريخ إصدار الشهادة الصحية (هجري)</label>
                                    <input type="text" class="form-control" id="issueDateHijri" placeholder="مثال: 1445/03/15">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">تاريخ نهاية الشهادة الصحية (هجري)</label>
                                    <input type="text" class="form-control" id="expiryDateHijri" placeholder="مثال: 1446/03/15">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">تاريخ انتهاء البرنامج التثقيفي</label>
                                    <input type="text" class="form-control" id="educationalProgramExpiry" placeholder="مثال: 2025/03/15">
                                </div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">صورة الشخص</label>
                                <input type="file" class="form-control" id="personImage" accept="image/*">
                                <img id="imagePreview" class="image-preview" style="display: none;">
                            </div>
                            
                            <button type="submit" class="btn btn-primary w-100">
                                <i class="fas fa-save me-2"></i>
                                حفظ الشهادة
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Add Medical Leave Form -->
        <div class="row mb-4 medical-leaves-section">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-calendar-alt me-2"></i>
                            إضافة إجازة مرضية جديدة
                        </h5>
                    </div>
                    <div class="card-body">
                        <form id="medicalLeaveForm">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">رمز الخدمة <span class="required">*</span></label>
                                    <input type="text" class="form-control" id="serviceCode" maxlength="14" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">رقم الهوية / الإقامة <span class="required">*</span></label>
                                    <input type="text" class="form-control" id="medicalIdNumber" maxlength="10" pattern="\d*" required>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">الاسم</label>
                                    <input type="text" class="form-control" id="patientName">
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">تاريخ إصدار تقرير الإجازة</label>
                                    <input type="date" class="form-control" id="reportIssueDate" value="">
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">تبدأ من</label>
                                    <input type="date" class="form-control" id="leaveStart">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">وحتى</label>
                                    <input type="date" class="form-control" id="leaveEnd">
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">المدة بالأيام</label>
                                    <input type="number" class="form-control" id="leaveDuration" min="1">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">اسم الممارس</label>
                                    <input type="text" class="form-control" id="doctorName">
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">المسمى الوظيفي</label>
                                <input type="text" class="form-control" id="jobTitle">
                            </div>
                            
                            <button type="submit" class="btn btn-primary w-100">
                                <i class="fas fa-save me-2"></i>
                                حفظ الإجازة المرضية
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Medical Leaves List -->
        <div class="row mb-4 medical-leaves-section">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">
                                <i class="fas fa-list me-2"></i>
                                قائمة الإجازات المرضية المحفوظة
                            </h5>
                            <button class="btn btn-outline-primary btn-sm" onclick="loadMedicalLeaves()">
                                <i class="fas fa-refresh me-1"></i>
                                تحديث
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div id="medicalLeavesList">
                            <div class="text-center text-muted py-4">
                                <i class="fas fa-calendar-alt fa-3x mb-3"></i>
                                <p>لا توجد إجازات مرضية محفوظة</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Certificates List -->
        <div class="row certificates-section">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">
                                <i class="fas fa-certificate me-2"></i>
                                قائمة الشهادات المحفوظة
                            </h5>
                            <div class="search-container">
                                <div class="search-box">
                                    <i class="fas fa-search search-icon"></i>
                                    <input type="text" class="search-input" id="searchInput" placeholder="ابحث في الشهادات..." onkeyup="searchCertificates()" oninput="searchCertificates()">
                                    <button class="clear-btn" type="button" id="clearSearch" onclick="clearSearch()" style="display: none;" title="مسح البحث">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <small class="text-muted">
                                <span id="certificatesCount">0</span> شهادة
                                <span id="searchResults" style="display: none;"> - <span id="filteredCount">0</span> نتيجة بحث</span>
                            </small>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th><i class="fas fa-image me-1"></i> الصورة</th>
                                        <th><i class="fas fa-user me-1"></i> الاسم</th>
                                        <th><i class="fas fa-id-card me-1"></i> رقم الشهادة</th>
                                        <th><i class="fas fa-calendar me-1"></i> تاريخ الإصدار</th>
                                        <th><i class="fas fa-cogs me-1"></i> الإجراءات</th>
                                    </tr>
                                </thead>
                                <tbody id="certificatesTable">
                                    <!-- سيتم ملء البيانات هنا -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

            </div> <!-- End Active Content Tab -->

            <!-- Deleted Content Tab -->
            <div class="tab-pane fade" id="deleted-content" role="tabpanel">
                <div class="row">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">
                                    <i class="fas fa-trash-restore me-2"></i>
                                    الشهادات والإجازات المحذوفة
                                </h5>
                                <button class="btn btn-primary" onclick="loadDeletedItems()">
                                    <i class="fas fa-sync-alt me-2"></i>تحديث
                                </button>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-striped">
                                        <thead>
                                            <tr>
                                                <th><i class="fas fa-hashtag me-1"></i> #</th>
                                                <th><i class="fas fa-user me-1"></i> الاسم</th>
                                                <th><i class="fas fa-id-card me-1"></i> رقم الهوية</th>
                                                <th><i class="fas fa-tag me-1"></i> النوع</th>
                                                <th><i class="fas fa-calendar me-1"></i> تاريخ الحذف</th>
                                                <th><i class="fas fa-cogs me-1"></i> الإجراءات</th>
                                            </tr>
                                        </thead>
                                        <tbody id="deletedItemsTable">
                                            <!-- سيتم ملء البيانات هنا -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div> <!-- End Deleted Content Tab -->

        </div> <!-- End Tab Content -->
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, query, orderBy, where, updateDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        // تم إزالة Storage لتوفير الخطة المجانية

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDOVmQ5HY0KrsaITu3Sl55-gjPwoKLPguE",
            authDomain: "certificates-8b2bb.firebaseapp.com",
            projectId: "certificates-8b2bb",
            storageBucket: "certificates-8b2bb.firebasestorage.app",
            messagingSenderId: "865099561039",
            appId: "1:865099561039:web:644ec7c3ffce81cd77523a",
            measurementId: "G-C2P94SNR6D"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Make Firebase available globally
        window.db = db;
        window.firebaseModules = {
            collection, addDoc, getDocs, deleteDoc, doc, query, orderBy, where, updateDoc
        };
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // تأمين قوي للوحة التحكم
        function checkAuthentication() {
            const isLoggedIn = localStorage.getItem('adminLoggedIn');
            const loginTime = localStorage.getItem('loginTime');
            const currentTime = new Date().getTime();
            
            // التحقق من انتهاء الجلسة (24 ساعة)
            if (isLoggedIn !== 'true' || !loginTime || (currentTime - parseInt(loginTime)) > 24 * 60 * 60 * 1000) {
                localStorage.clear();
                sessionStorage.clear();
                window.location.replace('admin-login.html');
                return false;
            }
            return true;
        }

        // فحص التوثيق عند تحميل الصفحة
        if (!checkAuthentication()) {
            throw new Error('Unauthorized access');
        }

        // فحص دوري كل 30 ثانية
        setInterval(checkAuthentication, 30000);

        // منع الوصول عبر التاريخ
        window.addEventListener('beforeunload', function() {
            if (localStorage.getItem('adminLoggedIn') !== 'true') {
                window.location.replace('admin-login.html');
            }
        });

        // منع الرجوع للخلف بعد تسجيل الخروج
        window.addEventListener('pageshow', function(event) {
            if (event.persisted || window.performance && window.performance.navigation.type === 2) {
                if (!checkAuthentication()) {
                    window.location.replace('admin-login.html');
                }
            }
        });

        // متغيرات عامة
        let certificates = [];
        let filteredCertificates = [];

        // تسجيل الخروج
        function logout() {
            localStorage.removeItem('adminLoggedIn');
            localStorage.removeItem('loginTime');
            window.location.href = 'admin-login.html';
        }

        // معاينة الصورة
        document.getElementById('personImage').addEventListener('change', function(e) {
            const file = e.target.files[0];
            const preview = document.getElementById('imagePreview');
            
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    preview.src = e.target.result;
                    preview.style.display = 'block';
                };
                reader.readAsDataURL(file);
            } else {
                preview.style.display = 'none';
            }
        });

        // تحويل الصورة إلى Base64
        function convertImageToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        // ضغط الصورة لتوفير مساحة التخزين
        function compressImage(file, maxWidth = 300, quality = 0.8) {
            return new Promise((resolve) => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const img = new Image();
                
                img.onload = () => {
                    // حساب الأبعاد الجديدة
                    const ratio = Math.min(maxWidth / img.width, maxWidth / img.height);
                    canvas.width = img.width * ratio;
                    canvas.height = img.height * ratio;
                    
                    // رسم الصورة المضغوطة
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    
                    // تحويل إلى Base64
                    const compressedDataUrl = canvas.toDataURL('image/jpeg', quality);
                    resolve(compressedDataUrl);
                };
                
                img.src = URL.createObjectURL(file);
            });
        }

        // إضافة شهادة جديدة
        document.getElementById('certificateForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            try {
                const certificateData = {
                    amanah: document.getElementById('amanah').value,
                    municipality: document.getElementById('municipality').value,
                    fullName: document.getElementById('fullName').value,
                    idNumber: document.getElementById('idNumber').value,
                    gender: document.getElementById('gender').value,
                    nationality: document.getElementById('nationality').value,
                    certificateNumber: document.getElementById('certificateNumber').value,
                    profession: document.getElementById('profession').value,
                    issueDate: document.getElementById('issueDate').value,
                    expiryDate: document.getElementById('expiryDate').value,
                    certificateType: document.getElementById('certificateType').value,
                    programType: document.getElementById('programType').value,
                    licenseNumber: document.getElementById('licenseNumber').value,
                    facilityName: document.getElementById('facilityName').value,
                    facilityNumber: document.getElementById('facilityNumber').value,
                    issueDateHijri: document.getElementById('issueDateHijri').value,
                    expiryDateHijri: document.getElementById('expiryDateHijri').value,
                    educationalProgramExpiry: document.getElementById('educationalProgramExpiry').value,
                    createdAt: new Date().toISOString(),
                    uniqueId: generateUniqueId()
                };

                // معالجة الصورة إذا تم اختيارها
                const imageFile = document.getElementById('personImage').files[0];
                if (imageFile) {
                    // التحقق من حجم الصورة (أقل من 5MB)
                    if (imageFile.size > 5 * 1024 * 1024) {
                        alert('حجم الصورة كبير جداً. يرجى اختيار صورة أصغر من 5MB');
                        return;
                    }
                    
                    // ضغط وتحويل الصورة إلى Base64
                    certificateData.imageBase64 = await compressImage(imageFile);
                }

                // حفظ البيانات في Firestore
                await window.firebaseModules.addDoc(window.firebaseModules.collection(window.db, 'certificates'), certificateData);
                
                // حفظ نسخة محلية احتياطية
                const localCertificates = JSON.parse(localStorage.getItem('certificates') || '[]');
                localCertificates.push(certificateData);
                localStorage.setItem('certificates', JSON.stringify(localCertificates));
                
                alert('تم حفظ الشهادة بنجاح!');
                this.reset();
                document.getElementById('imagePreview').style.display = 'none';
                loadCertificates();
                
            } catch (error) {
                console.error('خطأ في حفظ الشهادة:', error);
                
                // في حالة فشل Firebase، احفظ محلياً فقط
                const certificateData = {
                    amanah: document.getElementById('amanah').value,
                    municipality: document.getElementById('municipality').value,
                    fullName: document.getElementById('fullName').value,
                    idNumber: document.getElementById('idNumber').value,
                    gender: document.getElementById('gender').value,
                    nationality: document.getElementById('nationality').value,
                    certificateNumber: document.getElementById('certificateNumber').value,
                    profession: document.getElementById('profession').value,
                    issueDate: document.getElementById('issueDate').value,
                    expiryDate: document.getElementById('expiryDate').value,
                    certificateType: document.getElementById('certificateType').value,
                    programType: document.getElementById('programType').value,
                    licenseNumber: document.getElementById('licenseNumber').value,
                    facilityName: document.getElementById('facilityName').value,
                    facilityNumber: document.getElementById('facilityNumber').value,
                    issueDateHijri: document.getElementById('issueDateHijri').value,
                    expiryDateHijri: document.getElementById('expiryDateHijri').value,
                    educationalProgramExpiry: document.getElementById('educationalProgramExpiry').value,
                    createdAt: new Date().toISOString(),
                    uniqueId: generateUniqueId(),
                    id: 'local_' + Date.now()
                };

                const imageFile = document.getElementById('personImage').files[0];
                if (imageFile && imageFile.size <= 5 * 1024 * 1024) {
                    certificateData.imageBase64 = await compressImage(imageFile);
                }

                const localCertificates = JSON.parse(localStorage.getItem('certificates') || '[]');
                localCertificates.push(certificateData);
                localStorage.setItem('certificates', JSON.stringify(localCertificates));
                
                alert('تم حفظ الشهادة محلياً (Firebase غير متاح حالياً)');
                this.reset();
                document.getElementById('imagePreview').style.display = 'none';
                loadCertificates();
            }
        });

        // توليد معرف فريد
        function generateUniqueId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }

        // تحميل الشهادات المحلية
        function loadLocalCertificates() {
            try {
                console.log('📁 تحميل الشهادات من localStorage...');
                const localData = localStorage.getItem('certificates');
                if (localData) {
                    const allCertificates = JSON.parse(localData);
                    // فلترة الشهادات غير المحذوفة
                    certificates = allCertificates.filter(cert => !cert.deleted);
                    console.log(`✅ تم تحميل ${certificates.length} شهادة من localStorage`);
                } else {
                    certificates = [];
                    console.log('📭 لا توجد شهادات في localStorage');
                }
                displayCertificates();
                updateStatistics(); // تحديث الإحصائيات
            } catch (error) {
                console.error('❌ خطأ في تحميل الشهادات المحلية:', error);
                certificates = [];
                displayCertificates();
                updateStatistics(); // تحديث الإحصائيات حتى لو كانت فارغة
            }
        }
        
        // تحميل الإجازات المرضية المحلية
        function loadLocalMedicalLeaves() {
            try {
                console.log('🏥 تحميل الإجازات المرضية من localStorage...');
                medicalLeaves = [];
                
                // البحث في جميع مفاتيح localStorage عن الإجازات المرضية
                const allKeys = Object.keys(localStorage);
                const medicalLeaveKeys = allKeys.filter(key => key.startsWith('medical-leave-'));
                
                medicalLeaveKeys.forEach(key => {
                    try {
                        const medicalLeaveData = localStorage.getItem(key);
                        if (medicalLeaveData) {
                            const medicalLeave = JSON.parse(medicalLeaveData);
                            // إضافة الإجازات غير المحذوفة فقط
                            if (!medicalLeave.deleted) {
                                medicalLeaves.push(medicalLeave);
                            }
                        }
                    } catch (error) {
                        console.error(`خطأ في تحميل الإجازة المرضية ${key}:`, error);
                    }
                });
                
                console.log(`✅ تم تحميل ${medicalLeaves.length} إجازة مرضية من localStorage`);
                window.medicalLeaves = medicalLeaves; // حفظ في المتغير العام
                displayMedicalLeaves();
                updateMedicalLeavesStatistics(); // تحديث الإحصائيات
            } catch (error) {
                console.error('❌ خطأ في تحميل الإجازات المرضية المحلية:', error);
                medicalLeaves = [];
                window.medicalLeaves = medicalLeaves;
                displayMedicalLeaves();
                updateMedicalLeavesStatistics(); // تحديث الإحصائيات حتى لو كانت فارغة
            }
        }
        
        // تحديث الإحصائيات المحلية
        function updateLocalStatistics() {
            try {
                console.log('📊 تحديث الإحصائيات من البيانات المحلية...');
                
                const today = new Date().toDateString();
                let totalCertificates = 0;
                let todayCertificates = 0;
                let totalMedicalLeaves = 0;
                let todayMedicalLeaves = 0;
                
                // حساب إحصائيات الشهادات
                if (certificates && certificates.length > 0) {
                    totalCertificates = certificates.filter(cert => !cert.deleted).length;
                    todayCertificates = certificates.filter(cert => {
                        if (cert.deleted) return false;
                        const certDate = new Date(cert.createdAt || cert.created_at);
                        return certDate.toDateString() === today;
                    }).length;
                }
                
                // حساب إحصائيات الإجازات المرضية
                if (medicalLeaves && medicalLeaves.length > 0) {
                    totalMedicalLeaves = medicalLeaves.filter(leave => !leave.deleted).length;
                    todayMedicalLeaves = medicalLeaves.filter(leave => {
                        if (leave.deleted) return false;
                        const leaveDate = new Date(leave.created_at);
                        return leaveDate.toDateString() === today;
                    }).length;
                }
                
                // تحديث العرض
                document.getElementById('totalCertificates').textContent = totalCertificates;
                document.getElementById('todayCertificates').textContent = todayCertificates;
                document.getElementById('totalMedicalLeaves').textContent = totalMedicalLeaves;
                document.getElementById('todayMedicalLeaves').textContent = todayMedicalLeaves;
                
                console.log(`📈 الإحصائيات: شهادات (${totalCertificates}/${todayCertificates}) - إجازات (${totalMedicalLeaves}/${todayMedicalLeaves})`);
                
            } catch (error) {
                console.error('❌ خطأ في تحديث الإحصائيات المحلية:', error);
            }
        }
        
        // تحديث إحصائيات الإجازات المرضية من localStorage
        function updateLocalMedicalLeavesStatistics() {
            try {
                console.log('📊 حساب إحصائيات الإجازات المرضية من localStorage...');
                
                const today = new Date().toDateString();
                let totalMedicalLeaves = 0;
                let todayMedicalLeaves = 0;
                
                // البحث في جميع مفاتيح localStorage عن الإجازات المرضية
                const allKeys = Object.keys(localStorage);
                const medicalLeaveKeys = allKeys.filter(key => key.startsWith('medical-leave-'));
                
                medicalLeaveKeys.forEach(key => {
                    try {
                        const medicalLeaveData = localStorage.getItem(key);
                        if (medicalLeaveData) {
                            const medicalLeave = JSON.parse(medicalLeaveData);
                            // عد الإجازات غير المحذوفة فقط
                            if (!medicalLeave.deleted) {
                                totalMedicalLeaves++;
                                
                                // إحصائيات اليوم
                                const leaveDate = new Date(medicalLeave.created_at);
                                if (leaveDate.toDateString() === today) {
                                    todayMedicalLeaves++;
                                }
                            }
                        }
                    } catch (error) {
                        console.error(`خطأ في قراءة الإجازة المرضية ${key}:`, error);
                    }
                });
                
                // تحديث العرض
                document.getElementById('totalMedicalLeaves').textContent = totalMedicalLeaves;
                document.getElementById('todayMedicalLeaves').textContent = todayMedicalLeaves;
                
                console.log(`✅ إحصائيات الإجازات المرضية المحلية: إجمالي ${totalMedicalLeaves} - اليوم ${todayMedicalLeaves}`);
                
            } catch (error) {
                console.error('❌ خطأ في حساب إحصائيات الإجازات المرضية المحلية:', error);
                document.getElementById('totalMedicalLeaves').textContent = '0';
                document.getElementById('todayMedicalLeaves').textContent = '0';
            }
        }

        // تحميل الشهادات من Firebase فقط - سريع البرق!
        async function loadCertificatesFromFirebase() {
            try {
                console.log('🔥 تحميل الشهادات من Firebase - سريع جداً!');
                
                // timeout سريع جداً - 3 ثوان فقط!
                const timeoutPromise = new Promise((_, reject) => 
                    setTimeout(() => reject(new Error('Firebase timeout')), 3000)
                );
                
                // استعلام سريع بدون ترتيب - أسرع ما يمكن!
                const queryPromise = window.firebaseModules.getDocs(
                    window.firebaseModules.collection(window.db, 'certificates')
                );
                
                const querySnapshot = await Promise.race([queryPromise, timeoutPromise]);
                
                const firebaseCertificates = [];
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    // تجاهل الشهادات المحذوفة وتأكد أنها شهادة صحية وليس إجازة مرضية
                    const isHealthCertificate = data.amanah || data.uniqueId || (!data.idNumber && data.serviceCode);
                    const isMedicalLeave = data.serviceCode && data.idNumber && !data.amanah && !data.uniqueId;
                    
                    if (!data.deleted && isHealthCertificate && !isMedicalLeave) {
                        firebaseCertificates.push({ id: doc.id, ...data });
                    }
                });
                
                // تحديث البيانات دائماً - Firebase هو المصدر الوحيد!
                certificates = firebaseCertificates;
                displayCertificates();
                updateStatistics();
                console.log(`🚀 تم تحميل ${certificates.length} شهادة من Firebase بسرعة البرق!`);
                
            } catch (error) {
                console.error('❌ خطأ في تحديث الشهادات من Firebase:', error);
                
                // معالجة خاصة لخطأ 400
                if (error.toString().includes('400') || error.message.includes('Bad Request')) {
                    console.log('🚨 خطأ 400 في تحميل الشهادات - إعادة تهيئة Firebase...');
                    setTimeout(() => {
                        reinitializeFirebase();
                    }, 2000);
                }
            }
        }

        // تحميل الشهادات (الدالة الأصلية)
        async function loadCertificates() {
            try {
                console.log('🔄 بدء تحميل الشهادات...');
                
                // التحقق من توفر Firebase
                if (!window.firebaseModules || !window.db) {
                    console.log('⚠️ Firebase غير متاح، سيتم تحميل البيانات المحلية فقط');
                    loadLocalCertificates();
                    return;
                }
                
                // إضافة timeout للاستعلام
                const timeoutPromise = new Promise((_, reject) => 
                    setTimeout(() => reject(new Error('Firebase timeout')), 10000)
                );
                
                const queryPromise = window.firebaseModules.getDocs(
                    window.firebaseModules.query(
                        window.firebaseModules.collection(window.db, 'certificates'),
                        window.firebaseModules.orderBy('createdAt', 'desc')
                    )
                );
                
                const querySnapshot = await Promise.race([queryPromise, timeoutPromise]);
                
                certificates = [];
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    // تجاهل الشهادات المحذوفة
                    if (!data.deleted) {
                        certificates.push({ id: doc.id, ...data });
                    }
                });
                
                console.log(`✅ تم تحميل ${certificates.length} شهادة من Firebase`);
                displayCertificates();
                updateStatistics(); // تحديث الإحصائيات فوراً
                
            } catch (error) {
                console.error('❌ خطأ في تحميل الشهادات من Firebase:', error);
                console.log('🔄 التحميل من البيانات المحلية كبديل...');
                // في حالة عدم توفر Firebase، استخدم البيانات المحلية
                loadLocalCertificates();
            }
        }


        // عرض الشهادات
        function displayCertificates(certsToDisplay = certificates) {
            const tbody = document.getElementById('certificatesTable');
            tbody.innerHTML = '';
            
            // تحديث عداد الشهادات
            document.getElementById('certificatesCount').textContent = certificates.length;
            
            if (certsToDisplay.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" class="text-center text-muted py-4">
                            <i class="fas fa-search fa-2x mb-2"></i>
                            <div>لا توجد شهادات تطابق البحث</div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            certsToDisplay.forEach(cert => {
                const row = document.createElement('tr');
                const issueDate = cert.issueDate ? new Date(cert.issueDate).toLocaleDateString('ar-SA') : 'غير محدد';
                
                // إنشاء معرف آمن للشهادة
                const safeUniqueId = cert.uniqueId || cert.serviceCode || cert.id || `cert_${Date.now()}`;
                console.log('🔍 معرف الشهادة:', { uniqueId: cert.uniqueId, serviceCode: cert.serviceCode, id: cert.id, safeUniqueId });
                
                row.innerHTML = `
                    <td>
                        ${cert.imageBase64 ? 
                            `<img src="${cert.imageBase64}" class="certificate-image" alt="صورة">` : 
                            cert.imageUrl ? 
                            `<img src="${cert.imageUrl}" class="certificate-image" alt="صورة">` : 
                            '<i class="fas fa-user-circle fa-2x text-muted"></i>'
                        }
                    </td>
                    <td>
                        <div class="fw-bold">${cert.fullName || 'غير محدد'}</div>
                        <small class="text-muted">${cert.profession || ''}</small>
                    </td>
                    <td>
                        <span class="badge bg-primary">${cert.certificateNumber || 'غير محدد'}</span>
                    </td>
                    <td>
                        <small class="text-muted">${issueDate}</small>
                    </td>
                    <td>
                        <div class="btn-group" role="group">
                            <button class="btn btn-sm btn-outline-primary" onclick="viewCertificate('${safeUniqueId}')" title="عرض الشهادة">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-success" onclick="copyLink('${safeUniqueId}', this)" title="نسخ الرابط">
                                <i class="fas fa-link"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteCertificate('${safeUniqueId}', '${cert.id || ''}')" title="حذف الشهادة">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // البحث في الشهادات
        function searchCertificates() {
            const searchInput = document.getElementById('searchInput');
            const searchTerm = searchInput.value.toLowerCase().trim();
            const searchResults = document.getElementById('searchResults');
            const filteredCount = document.getElementById('filteredCount');
            const clearButton = document.getElementById('clearSearch');
            
            // إظهار/إخفاء زر المسح
            if (searchTerm === '') {
                clearButton.style.display = 'none';
                // إذا كان البحث فارغ، اعرض جميع الشهادات
                filteredCertificates = certificates;
                searchResults.style.display = 'none';
                displayCertificates(certificates);
            } else {
                clearButton.style.display = 'block';
                // فلترة الشهادات بناءً على البحث
                filteredCertificates = certificates.filter(cert => {
                    return (
                        (cert.fullName && cert.fullName.toLowerCase().includes(searchTerm)) ||
                        (cert.certificateNumber && cert.certificateNumber.toLowerCase().includes(searchTerm)) ||
                        (cert.idNumber && cert.idNumber.toLowerCase().includes(searchTerm)) ||
                        (cert.profession && cert.profession.toLowerCase().includes(searchTerm)) ||
                        (cert.amanah && cert.amanah.toLowerCase().includes(searchTerm)) ||
                        (cert.municipality && cert.municipality.toLowerCase().includes(searchTerm)) ||
                        (cert.nationality && cert.nationality.toLowerCase().includes(searchTerm)) ||
                        (cert.certificateType && cert.certificateType.toLowerCase().includes(searchTerm))
                    );
                });
                
                // عرض نتائج البحث
                filteredCount.textContent = filteredCertificates.length;
                searchResults.style.display = 'inline';
                displayCertificates(filteredCertificates);
            }
        }

        // مسح البحث
        function clearSearch() {
            const searchInput = document.getElementById('searchInput');
            const clearButton = document.getElementById('clearSearch');
            
            searchInput.value = '';
            clearButton.style.display = 'none';
            searchCertificates();
            searchInput.focus();
        }

        // عرض الشهادة
        function viewCertificate(uniqueId) {
            const url = `1.html?id=${uniqueId}`;
            window.open(url, '_blank');
        }

        // نسخ رابط الشهادة
        function copyLink(uniqueId, buttonElement) {
            const url = `${window.location.origin}/1.html?id=${uniqueId}`;
            navigator.clipboard.writeText(url).then(() => {
                // إظهار رسالة نجاح
                const btn = buttonElement || event.target.closest('button');
                const originalIcon = btn.innerHTML;
                const originalClass = btn.className;
                
                btn.innerHTML = '<i class="fas fa-check"></i>';
                btn.className = 'btn btn-sm btn-success';
                
                setTimeout(() => {
                    btn.innerHTML = originalIcon;
                    btn.className = originalClass;
                }, 2000);
                
                // إظهار رسالة نجاح مؤقتة
                const toast = document.createElement('div');
                toast.className = 'alert alert-success toast-notification';
                toast.innerHTML = '<i class="fas fa-check me-2"></i>تم نسخ الرابط بنجاح!';
                document.body.appendChild(toast);
                
                setTimeout(() => {
                    if (document.body.contains(toast)) {
                        document.body.removeChild(toast);
                    }
                }, 3000);
                
            }).catch(err => {
                console.error('فشل في نسخ الرابط:', err);
                alert('فشل في نسخ الرابط. يرجى المحاولة مرة أخرى.');
            });
        }

        // إخفاء شهادة (soft delete)
        async function deleteCertificate(uniqueId, firebaseId = '') {
            console.log('🔥 محاولة إخفاء الشهادة:', { uniqueId, firebaseId });
            
            if (!uniqueId || uniqueId === 'undefined') {
                console.error('❌ معرف الشهادة غير صحيح:', uniqueId);
                alert('خطأ: معرف الشهادة غير صحيح');
                return;
            }
            
            if (confirm('هل أنت متأكد من إخفاء هذه الشهادة؟ (يمكن استعادتها لاحقاً)')) {
                try {
                    let updated = false;
                    
                    // إذا كان لدينا معرف Firebase، حدث مباشرة
                    if (firebaseId && firebaseId !== '' && !firebaseId.startsWith('local_') && !firebaseId.startsWith('cert_')) {
                        try {
                            console.log('🔥 محاولة التحديث بـ Firebase ID:', firebaseId);
                            
                            // التأكد من وجود Firebase modules
                            if (!window.firebaseModules || !window.db) {
                                throw new Error('Firebase غير متاح');
                            }
                            
                            const docRef = window.firebaseModules.doc(window.db, 'certificates', firebaseId);
                            
                            // إضافة timeout للعملية
                            const updatePromise = window.firebaseModules.updateDoc(docRef, {
                                deleted: true,
                                deletedAt: new Date().toISOString()
                            });
                            
                            const timeoutPromise = new Promise((_, reject) => 
                                setTimeout(() => reject(new Error('Firebase update timeout')), 5000)
                            );
                            
                            await Promise.race([updatePromise, timeoutPromise]);
                            updated = true;
                            console.log('✅ تم إخفاء الشهادة في Firebase باستخدام المعرف المباشر');
                        } catch (error) {
                            console.error('❌ فشل الحذف بالمعرف المباشر:', error);
                            console.log('🔄 سأحاول البحث بـ uniqueId...');
                        }
                    }
                    
                    // إذا لم ينجح التحديث المباشر، ابحث بـ uniqueId
                    if (!updated) {
                        console.log('🔍 البحث بـ uniqueId:', uniqueId);
                        let q = window.firebaseModules.query(
                            window.firebaseModules.collection(window.db, 'certificates'),
                            window.firebaseModules.where('uniqueId', '==', uniqueId)
                        );
                        
                        // إضافة timeout للبحث
                        const searchPromise = window.firebaseModules.getDocs(q);
                        const searchTimeout = new Promise((_, reject) => 
                            setTimeout(() => reject(new Error('Firebase search timeout')), 5000)
                        );
                        
                        let querySnapshot = await Promise.race([searchPromise, searchTimeout]);
                        
                        // إذا لم يجد بـ uniqueId، جرب البحث بـ serviceCode (للشهادات فقط)
                        if (querySnapshot.empty) {
                            console.log('🔍 البحث بـ serviceCode للشهادات فقط:', uniqueId);
                            q = window.firebaseModules.query(
                                window.firebaseModules.collection(window.db, 'certificates'),
                                window.firebaseModules.where('serviceCode', '==', uniqueId),
                                window.firebaseModules.where('amanah', '!=', null) // فقط الشهادات الصحية
                            );
                            
                            const searchPromise2 = window.firebaseModules.getDocs(q);
                            const searchTimeout2 = new Promise((_, reject) => 
                                setTimeout(() => reject(new Error('Firebase search timeout')), 5000)
                            );
                            
                            querySnapshot = await Promise.race([searchPromise2, searchTimeout2]);
                        }
                        
                        if (!querySnapshot.empty) {
                            // التحقق من أن هذا شهادة صحية وليس إجازة مرضية
                            const docData = querySnapshot.docs[0].data();
                            const isHealthCertificate = docData.amanah || docData.uniqueId || !docData.idNumber;
                            
                            if (isHealthCertificate) {
                                const docRef = querySnapshot.docs[0].ref;
                                
                                console.log('✅ تأكيد: هذا شهادة صحية، يمكن حذفها');
                                
                                // إضافة timeout للتحديث
                                const updatePromise = window.firebaseModules.updateDoc(docRef, {
                                    deleted: true,
                                    deletedAt: new Date().toISOString()
                                });
                                
                                const updateTimeout = new Promise((_, reject) => 
                                    setTimeout(() => reject(new Error('Firebase update timeout')), 5000)
                                );
                                
                                await Promise.race([updatePromise, updateTimeout]);
                                updated = true;
                                console.log('✅ تم إخفاء الشهادة الصحية في Firebase باستخدام البحث');
                            } else {
                                console.log('⚠️ هذا إجازة مرضية وليس شهادة صحية - لن يتم حذفها');
                            }
                        } else {
                            console.log('⚠️ لم يتم العثور على الشهادة في Firebase');
                        }
                    }
                    
                    // Firebase فقط - إعادة تحميل البيانات
                    if (updated) {
                        console.log('🔥 تم إخفاء الشهادة من Firebase بنجاح!');
                        alert('تم إخفاء الشهادة بنجاح! يمكن استعادتها من قسم المحذوفات.');
                        
                        // إعادة تحميل البيانات من Firebase (الشهادات والإجازات منفصلة)
                        loadCertificatesFromFirebase();
                        loadMedicalLeavesFromFirebase(); // تحديث الإجازات أيضاً للتأكد من العدادات
                        loadDeletedItems(); // تحديث المحذوفات
                    } else {
                        console.log('❌ فشل في إخفاء الشهادة');
                        alert('فشل في إخفاء الشهادة. يرجى المحاولة مرة أخرى.');
                    }
                    
                } catch (error) {
                    console.error('❌ خطأ في إخفاء الشهادة:', error);
                    
                    // معالجة خاصة لأخطاء Firebase
                    let errorMessage = 'حدث خطأ في إخفاء الشهادة.';
                    
                    if (error.message.includes('timeout')) {
                        errorMessage = 'انتهت مهلة الاتصال بـ Firebase. يرجى المحاولة مرة أخرى.';
                    } else if (error.message.includes('400') || error.message.includes('Bad Request') || error.toString().includes('400')) {
                        errorMessage = 'خطأ في الاتصال بـ Firebase (400). جاري إعادة المحاولة...';
                        console.log('🔄 خطأ 400 - محاولة إعادة الاتصال بـ Firebase...');
                        
                        // إعادة تهيئة Firebase
                        reinitializeFirebase();
                        
                        // محاولة إعادة تحميل البيانات بعد تأخير
                        setTimeout(() => {
                            console.log('🔄 إعادة محاولة تحميل البيانات...');
                            loadCertificatesFromFirebase();
                        }, 3000);
                    } else if (error.message.includes('permission')) {
                        errorMessage = 'ليس لديك صلاحية لتعديل هذه الشهادة.';
                    }
                    
                    alert(errorMessage);
                    
                    // في حالة فشل Firebase، لا نفعل شيء (Firebase فقط)
                    console.log('🔥 Firebase فقط - لا fallback إلى localStorage');
                }
            }
        }

        // تحديث الإحصائيات
        function updateStatistics() {
            try {
                console.log('📊 تحديث إحصائيات الشهادات...');
                
                const total = certificates ? certificates.length : 0;
                const today = new Date().toDateString();
                const todayCount = certificates ? certificates.filter(cert => {
                    const certDate = new Date(cert.createdAt || cert.created_at);
                    return certDate.toDateString() === today;
                }).length : 0;
                
                document.getElementById('totalCertificates').textContent = total;
                document.getElementById('todayCertificates').textContent = todayCount;
                
                console.log(`✅ إحصائيات الشهادات: إجمالي ${total} - اليوم ${todayCount}`);
                
                // إحصائيات الإجازات المرضية
                updateMedicalLeavesStatistics();
                
            } catch (error) {
                console.error('❌ خطأ في تحديث إحصائيات الشهادات:', error);
                document.getElementById('totalCertificates').textContent = '0';
                document.getElementById('todayCertificates').textContent = '0';
            }
        }

        // تحديث إحصائيات الإجازات المرضية من Firebase
        async function updateMedicalLeavesStatistics() {
            try {
                console.log('📊 تحديث إحصائيات الإجازات المرضية...');
                
                // إذا كانت البيانات متاحة في المتغير العام، استخدمها
                if (window.medicalLeaves && window.medicalLeaves.length > 0) {
                    const total = window.medicalLeaves.length;
                    const today = new Date().toDateString();
                    const todayCount = window.medicalLeaves.filter(leave => {
                        const leaveDate = new Date(leave.created_at);
                        return leaveDate.toDateString() === today;
                    }).length;
                    
                    document.getElementById('totalMedicalLeaves').textContent = total;
                    document.getElementById('todayMedicalLeaves').textContent = todayCount;
                    
                    console.log(`✅ إحصائيات الإجازات المرضية: إجمالي ${total} - اليوم ${todayCount}`);
                    return;
                }
                
                if (!window.firebaseModules || !window.db) {
                    console.log('⚠️ Firebase غير متاح، حساب الإحصائيات من localStorage...');
                    updateLocalMedicalLeavesStatistics();
                    return;
                }

                const { collection, getDocs } = window.firebaseModules;
                
                // جلب جميع البيانات من Firebase
                const querySnapshot = await getDocs(collection(window.db, 'certificates'));
                let totalMedicalLeaves = 0;
                let todayMedicalLeaves = 0;
                const today = new Date().toDateString();
                
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    // التأكد أن هذا إجازة مرضية وليس شهادة صحية وأنها غير محذوفة
                    if (data.serviceCode && data.idNumber && !data.amanah && !data.deleted) {
                        totalMedicalLeaves++;
                        
                        // إحصائيات اليوم
                        const leaveDate = new Date(data.created_at);
                        if (leaveDate.toDateString() === today) {
                            todayMedicalLeaves++;
                        }
                    }
                });
                
                document.getElementById('totalMedicalLeaves').textContent = totalMedicalLeaves;
                document.getElementById('todayMedicalLeaves').textContent = todayMedicalLeaves;
                
            } catch (error) {
                console.error('خطأ في تحديث إحصائيات الإجازات المرضية:', error);
                document.getElementById('totalMedicalLeaves').textContent = '0';
                document.getElementById('todayMedicalLeaves').textContent = '0';
            }
        }

        // دالة إخفاء الإجازة المرضية (soft delete)
        async function deleteMedicalLeaveFromFirebase(docId, serviceCode, idNumber) {
            console.log('🔥 محاولة إخفاء الإجازة المرضية:', { docId, serviceCode, idNumber });
            if (confirm('هل أنت متأكد من إخفاء هذه الإجازة المرضية؟ (يمكن استعادتها لاحقاً)')) {
                try {
                    console.log('🔍 البحث في جميع المستندات للعثور على الإجازة المرضية...');
                    
                    // جلب جميع المستندات والبحث عن الإجازة المرضية
                    const querySnapshot = await window.firebaseModules.getDocs(
                        window.firebaseModules.collection(window.db, 'certificates')
                    );
                    
                    let foundDoc = null;
                    let docToDelete = null;
                    
                    querySnapshot.forEach((doc) => {
                        const data = doc.data();
                        console.log('📄 فحص المستند:', doc.id, data);
                        
                        // البحث عن الإجازة المرضية بعدة طرق
                        if (
                            (data.serviceCode === serviceCode && data.idNumber === idNumber) ||
                            (data.serviceCode === serviceCode && data.medicalIdNumber === idNumber) ||
                            (doc.id === docId)
                        ) {
                            // التأكد أنها إجازة مرضية وليس شهادة صحية
                            if (data.serviceCode && !data.amanah && !data.municipality) {
                                foundDoc = data;
                                docToDelete = doc;
                                console.log('✅ تم العثور على الإجازة المرضية:', doc.id);
                            }
                        }
                    });
                    
                    if (docToDelete) {
                        console.log('🗑️ إخفاء الإجازة المرضية في Firebase...');
                        await window.firebaseModules.updateDoc(docToDelete.ref, {
                            deleted: true,
                            deletedAt: new Date().toISOString()
                        });
                        console.log('✅ تم إخفاء الإجازة المرضية في Firebase بنجاح!');
                        
                        // تحديث localStorage
                        const localKey = `medical-leave-${serviceCode}-${idNumber}`;
                        const localData = localStorage.getItem(localKey);
                        if (localData) {
                            const medicalLeave = JSON.parse(localData);
                            medicalLeave.deleted = true;
                            medicalLeave.deletedAt = new Date().toISOString();
                            localStorage.setItem(localKey, JSON.stringify(medicalLeave));
                        }
                        
                        // تحديث فوري للقوائم
                        setTimeout(async () => {
                            await loadMedicalLeaves();
                            await updateStatistics();
                        }, 1000);
                        
                        alert('تم إخفاء الإجازة المرضية بنجاح! يمكن استعادتها من قسم المحذوفات.');
                        
                    } else {
                        console.log('❌ لم يتم العثور على الإجازة المرضية في Firebase');
                        
                        // إخفاء من localStorage على الأقل
                        const localKey = `medical-leave-${serviceCode}-${idNumber}`;
                        const localData = localStorage.getItem(localKey);
                        if (localData) {
                            const medicalLeave = JSON.parse(localData);
                            medicalLeave.deleted = true;
                            medicalLeave.deletedAt = new Date().toISOString();
                            localStorage.setItem(localKey, JSON.stringify(medicalLeave));
                        }
                        
                        loadMedicalLeaves();
                        updateStatistics();
                        
                        alert('لم يتم العثور على الإجازة المرضية في Firebase، تم الإخفاء محلياً');
                    }
                    
                } catch (error) {
                    console.error('❌ خطأ في حذف الإجازة المرضية:', error);
                    alert('حدث خطأ في حذف الإجازة المرضية: ' + error.message);
                }
            }
        }

        // إضافة إجازة مرضية جديدة
        document.getElementById('medicalLeaveForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const serviceCode = document.getElementById('serviceCode').value.trim();
            const idNumber = document.getElementById('medicalIdNumber').value.trim();
            const name = document.getElementById('patientName').value.trim();
            const reportIssueDate = document.getElementById('reportIssueDate').value;
            const leaveStart = document.getElementById('leaveStart').value;
            const leaveEnd = document.getElementById('leaveEnd').value;
            const leaveDuration = document.getElementById('leaveDuration').value;
            const doctorName = document.getElementById('doctorName').value.trim();
            const jobTitle = document.getElementById('jobTitle').value.trim();
            
            if (!serviceCode || !idNumber || !name || !reportIssueDate || !leaveStart || !leaveEnd || !leaveDuration || !doctorName || !jobTitle) {
                alert('يرجى ملء جميع الحقول المطلوبة');
                return;
            }
            
            const medicalLeaveData = {
                name: name,
                report_issue_date: reportIssueDate,
                leave_start: leaveStart,
                leave_end: leaveEnd,
                time: leaveDuration,
                doctor_name: doctorName,
                role: jobTitle,
                created_at: new Date().toISOString()
            };
            
            try {
                // إضافة معرف فريد للإجازة المرضية
                medicalLeaveData.id = `${serviceCode}_${idNumber}`;
                medicalLeaveData.serviceCode = serviceCode;
                medicalLeaveData.idNumber = idNumber;
                
                // الحفظ في Firebase أولاً (مثل الشهادات تماماً)
                try {
                    const { collection, addDoc } = window.firebaseModules;
                    const docRef = await addDoc(collection(window.db, 'certificates'), medicalLeaveData);
                    console.log('✅ تم حفظ الإجازة المرضية في Firebase بنجاح:', docRef.id);
                    
                    // حفظ محلي للسرعة فقط
                    const localKey = `medical-leave-${serviceCode}-${idNumber}`;
                    localStorage.setItem(localKey, JSON.stringify(medicalLeaveData));
                    
                } catch (error) {
                    console.error('❌ خطأ في حفظ Firebase:', error);
                    throw error; // رمي الخطأ لإيقاف العملية
                }
                
                // تحديث القوائم والإحصائيات
                loadMedicalLeaves();
                updateStatistics();
                
                // إعادة تعيين النموذج
                document.getElementById('medicalLeaveForm').reset();
                
                alert('تم حفظ الإجازة المرضية بنجاح!');
                
            } catch (error) {
                console.error('خطأ في حفظ الإجازة المرضية:', error);
                alert('حدث خطأ في حفظ الإجازة المرضية');
            }
        });

        // تحميل الإجازات المرضية من Firebase فقط - سريع البرق!
        async function loadMedicalLeavesFromFirebase() {
            try {
                console.log('🔥 تحميل الإجازات المرضية من Firebase - سريع جداً!');
                
                const { collection, getDocs, orderBy, query } = window.firebaseModules;
                
                // timeout سريع جداً - 3 ثوان فقط!
                const timeoutPromise = new Promise((_, reject) => 
                    setTimeout(() => reject(new Error('Firebase timeout')), 3000)
                );
                
                // استعلام سريع بدون ترتيب - أسرع ما يمكن!
                const queryPromise = getDocs(collection(window.db, 'certificates'));
                const querySnapshot = await Promise.race([queryPromise, timeoutPromise]);
                const firebaseMedicalLeaves = [];
                
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    // التأكد أن هذا إجازة مرضية وليس شهادة صحية وأنها غير محذوفة
                    const isHealthCertificate = data.amanah || data.uniqueId || (!data.idNumber && data.serviceCode);
                    const isMedicalLeave = data.serviceCode && data.idNumber && !data.amanah && !data.uniqueId;
                    
                    if (!data.deleted && isMedicalLeave && !isHealthCertificate) {
                        firebaseMedicalLeaves.push({
                            id: doc.id,
                            ...data
                        });
                    }
                });

                // تحديث البيانات دائماً - Firebase هو المصدر الوحيد!
                window.medicalLeaves = firebaseMedicalLeaves;
                displayMedicalLeaves();
                updateMedicalLeavesStatistics();
                console.log(`🚀 تم تحميل ${firebaseMedicalLeaves.length} إجازة مرضية من Firebase بسرعة البرق!`);
                
            } catch (error) {
                console.error('❌ خطأ في تحديث الإجازات المرضية من Firebase:', error);
                
                // معالجة خاصة لخطأ 400
                if (error.toString().includes('400') || error.message.includes('Bad Request')) {
                    console.log('🚨 خطأ 400 في تحميل الإجازات المرضية - إعادة تهيئة Firebase...');
                    setTimeout(() => {
                        reinitializeFirebase();
                    }, 2000);
                }
            }
        }

        // دالة تحميل قائمة الإجازات المرضية من Firebase (الدالة الأصلية)
        async function loadMedicalLeaves() {
            const medicalLeavesList = document.getElementById('medicalLeavesList');
            
            try {
                console.log('🔄 بدء تحميل الإجازات المرضية...');
                
                if (!window.firebaseModules || !window.db) {
                    console.log('⚠️ Firebase غير متاح، سيتم تحميل البيانات المحلية فقط');
                    loadLocalMedicalLeaves();
                    return;
                }

                const { collection, getDocs, orderBy, query } = window.firebaseModules;
                
                // إضافة timeout للاستعلام
                const timeoutPromise = new Promise((_, reject) => 
                    setTimeout(() => reject(new Error('Firebase timeout')), 10000)
                );
                
                // جلب جميع البيانات من Firebase (بدون فلترة معقدة)
                const q = query(
                    collection(window.db, 'certificates'),
                    orderBy('created_at', 'desc')
                );
                
                const queryPromise = getDocs(q);
                const querySnapshot = await Promise.race([queryPromise, timeoutPromise]);
                const medicalLeaves = [];
                
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    // التأكد أن هذا إجازة مرضية وليس شهادة صحية وأنها غير محذوفة
                    if (data.serviceCode && data.idNumber && !data.amanah && !data.deleted) {
                        medicalLeaves.push({
                            id: doc.id,
                            ...data
                        });
                    }
                });

                console.log(`✅ تم تحميل ${medicalLeaves.length} إجازة مرضية من Firebase`);
                
                // حفظ البيانات في المتغير العام
                window.medicalLeaves = medicalLeaves;
                displayMedicalLeaves();
                updateMedicalLeavesStatistics(); // تحديث الإحصائيات فوراً
                
            } catch (error) {
                console.error('❌ خطأ في تحميل الإجازات المرضية من Firebase:', error);
                console.log('🔄 التحميل من البيانات المحلية كبديل...');
                // في حالة عدم توفر Firebase، استخدم البيانات المحلية
                loadLocalMedicalLeaves();
            }
        }
        
        // عرض الإجازات المرضية
        function displayMedicalLeaves() {
            const medicalLeavesList = document.getElementById('medicalLeavesList');
            const medicalLeavesToDisplay = window.medicalLeaves || [];
            
            if (medicalLeavesToDisplay.length === 0) {
                medicalLeavesList.innerHTML = `
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-calendar-alt fa-3x mb-3"></i>
                        <p>لا توجد إجازات مرضية محفوظة</p>
                    </div>
                `;
                return;
            }

            let html = '<div class="table-responsive"><table class="table table-striped"><thead><tr><th>رمز الخدمة</th><th>رقم الهوية</th><th>الاسم</th><th>تاريخ الحفظ</th><th>الإجراءات</th></tr></thead><tbody>';
            
            medicalLeavesToDisplay.forEach(leave => {
                const date = new Date(leave.created_at).toLocaleDateString('ar-SA');
                
                html += `
                    <tr>
                        <td>${leave.serviceCode}</td>
                        <td>${leave.idNumber}</td>
                        <td>${leave.name || leave.fullName || 'غير محدد'}</td>
                        <td>${date}</td>
                        <td>
                            <button class="btn btn-danger btn-sm" onclick="deleteMedicalLeaveFromFirebase('${leave.id}', '${leave.serviceCode}', '${leave.idNumber}')" title="حذف الإجازة المرضية">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            html += '</tbody></table></div>';
            medicalLeavesList.innerHTML = html;
        }

        // دالة حذف الإجازة المرضية
        function deleteMedicalLeave(serviceCode, idNumber) {
            if (confirm('هل أنت متأكد من حذف هذه الإجازة المرضية؟')) {
                // حذف البيانات
                const localKey = `medical-leave-${serviceCode}-${idNumber}`;
                localStorage.removeItem(localKey);
                
                // تحديث الفهرس
                const medicalLeavesIndex = JSON.parse(localStorage.getItem('medical-leaves-index') || '[]');
                const updatedIndex = medicalLeavesIndex.filter(item => 
                    !(item.serviceCode === serviceCode && item.idNumber === idNumber)
                );
                localStorage.setItem('medical-leaves-index', JSON.stringify(updatedIndex));
                
                // تحديث القائمة
                loadMedicalLeaves();
                
                alert('تم حذف الإجازة المرضية بنجاح!');
            }
        }

        // تحديث المدة تلقائياً عند تغيير التواريخ
        document.getElementById('leaveStart').addEventListener('change', calculateLeaveDuration);
        document.getElementById('leaveEnd').addEventListener('change', calculateLeaveDuration);

        function calculateLeaveDuration() {
            const startDate = document.getElementById('leaveStart').value;
            const endDate = document.getElementById('leaveEnd').value;
            
            if (startDate && endDate) {
                const start = new Date(startDate);
                const end = new Date(endDate);
                
                // التأكد من أن التواريخ صحيحة
                if (isNaN(start.getTime()) || isNaN(end.getTime())) {
                    document.getElementById('leaveDuration').value = '';
                    return;
                }
                
                const timeDiff = end.getTime() - start.getTime();
                const daysDiff = Math.floor(timeDiff / (1000 * 3600 * 24)) + 1; // +1 لتضمين اليوم الأول
                
                if (daysDiff >= 1) {
                    document.getElementById('leaveDuration').value = daysDiff;
                } else {
                    document.getElementById('leaveDuration').value = '';
                }
            }
        }

        // دالة حساب تاريخ الانتهاء تلقائياً (+1 سنة)
        function calculateExpiryDate() {
            const issueDateInput = document.getElementById('issueDate');
            const expiryDateInput = document.getElementById('expiryDate');
            
            if (issueDateInput.value) {
                try {
                    // تحويل التاريخ من صيغة YYYY/MM/DD أو YYYY-MM-DD
                    let dateStr = issueDateInput.value.replace(/\//g, '-');
                    let issueDate = new Date(dateStr);
                    
                    // إضافة سنة واحدة
                    let expiryDate = new Date(issueDate);
                    expiryDate.setFullYear(expiryDate.getFullYear() + 1);
                    
                    // تنسيق التاريخ بصيغة YYYY/MM/DD
                    let year = expiryDate.getFullYear();
                    let month = String(expiryDate.getMonth() + 1).padStart(2, '0');
                    let day = String(expiryDate.getDate()).padStart(2, '0');
                    
                    expiryDateInput.value = `${year}/${month}/${day}`;
                } catch (error) {
                    console.log('خطأ في حساب تاريخ الانتهاء:', error);
                }
            }
        }

        // متغير لتتبع محاولات التحميل
        let initializationAttempts = 0;
        const MAX_ATTEMPTS = 3; // أقصى 3 محاولات (3 ثوان) - أسرع
        let dataLoaded = false; // لتجنب التحميل المتكرر
        
        // إظهار رسالة التحميل
        function showLoadingMessage() {
            // تحديث العدادات برسالة التحميل
            document.getElementById('totalCertificates').textContent = '...';
            document.getElementById('todayCertificates').textContent = '...';
            document.getElementById('totalMedicalLeaves').textContent = '...';
            document.getElementById('todayMedicalLeaves').textContent = '...';
        }
        
        // إخفاء رسالة التحميل
        function hideLoadingMessage() {
            // سيتم تحديث العدادات بالقيم الفعلية في دوال التحديث
        }
        
        // تحميل الشهادات والإجازات المرضية عند تحميل الصفحة - Firebase فقط!
        function initializeData() {
            if (dataLoaded) {
                console.log('✅ البيانات محملة بالفعل');
                return;
            }
            
            console.log(`🔥 Firebase ONLY - محاولة التحميل رقم ${initializationAttempts + 1}`);
            
            // تعيين التاريخ الافتراضي لحقول التاريخ (يعمل دائماً)
            setDefaultDates();
            
            // إضافة مستمعات الأحداث لحساب المدة تلقائياً (يعمل دائماً)
            setupDateCalculation();
            
            // Firebase فقط - بسرعة البرق! تحميل متوازي
            if (window.firebaseModules && window.db) {
                console.log('🚀 Firebase متاح - تحميل متوازي سريع جداً!');
                
                // تحميل متوازي - كل شيء في نفس الوقت!
                Promise.all([
                    loadCertificatesFromFirebase(),
                    loadMedicalLeavesFromFirebase(),
                    loadDeletedItems()
                ]).then(() => {
                    console.log('🔥 تم تحميل جميع البيانات من Firebase بسرعة البرق!');
                }).catch(error => {
                    console.error('❌ خطأ في التحميل المتوازي:', error);
                });
                
                dataLoaded = true;
            } else {
                initializationAttempts++;
                
                if (initializationAttempts < MAX_ATTEMPTS) {
                    console.log(`⏳ انتظار Firebase... (${initializationAttempts}/${MAX_ATTEMPTS})`);
                    setTimeout(initializeData, 200); // محاولة كل 0.2 ثانية - سريع جداً!
                } else {
                    console.log('❌ Firebase غير متاح نهائياً');
                    // عرض رسالة خطأ
                    document.getElementById('totalCertificates').textContent = 'خطأ';
                    document.getElementById('todayCertificates').textContent = 'خطأ';
                    document.getElementById('totalMedicalLeaves').textContent = 'خطأ';
                    document.getElementById('todayMedicalLeaves').textContent = 'خطأ';
                }
            }
        }
        
        // تعيين التاريخ الافتراضي
        function setDefaultDates() {
            const today = new Date().toISOString().split('T')[0]; // تنسيق YYYY-MM-DD
            
            // تعيين تاريخ اليوم كافتراضي لتاريخ إصدار التقرير
            const reportIssueDateField = document.getElementById('reportIssueDate');
            if (reportIssueDateField && !reportIssueDateField.value) {
                reportIssueDateField.value = today;
            }
        }
        
        // إعداد حساب المدة تلقائياً
        function setupDateCalculation() {
            const leaveStartField = document.getElementById('leaveStart');
            const leaveEndField = document.getElementById('leaveEnd');
            const leaveDurationField = document.getElementById('leaveDuration');
            
            function calculateDuration() {
                const startDate = leaveStartField.value;
                const endDate = leaveEndField.value;
                
                if (startDate && endDate) {
                    const start = new Date(startDate);
                    const end = new Date(endDate);
                    
                    if (end >= start) {
                        const diffTime = Math.abs(end - start);
                        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1; // +1 لتضمين يوم البداية
                        leaveDurationField.value = diffDays;
                    } else {
                        leaveDurationField.value = '';
                        alert('تاريخ النهاية يجب أن يكون بعد تاريخ البداية');
                    }
                }
            }
            
            if (leaveStartField && leaveEndField && leaveDurationField) {
                leaveStartField.addEventListener('change', calculateDuration);
                leaveEndField.addEventListener('change', calculateDuration);
            }
        }
        
        // إضافة class للـ body حسب القسم المختار قبل تحميل الصفحة
        (function() {
            const selectedSection = localStorage.getItem('selectedSection');
            const urlParams = new URLSearchParams(window.location.search);
            const sectionParam = urlParams.get('section');
            const currentSection = sectionParam || selectedSection;
            
            if (currentSection === 'certificates') {
                document.body.classList.add('certificates-only');
                console.log('🏥 تم تطبيق class للشهادات فقط');
            } else if (currentSection === 'medical-leaves') {
                document.body.classList.add('medical-leaves-only');
                console.log('🏥 تم تطبيق class للإجازات المرضية فقط');
            }
        })();

        // تحميل فوري عند تحميل الصفحة
        document.addEventListener('DOMContentLoaded', function() {
            console.log('📄 الصفحة جاهزة، بدء التحميل الفوري...');
            
            // التحقق من القسم المختار وإخفاء الآخر
            const selectedSection = localStorage.getItem('selectedSection');
            const urlParams = new URLSearchParams(window.location.search);
            const sectionParam = urlParams.get('section');
            
            const currentSection = sectionParam || selectedSection;
            
            // الآن CSS يتولى الإخفاء من البداية
            console.log(`🏥 القسم المختار: ${currentSection}`);
            
            initializeData();
        });
        
        // تحميل احتياطي إذا لم يتم تحميل DOMContentLoaded
        if (document.readyState === 'loading') {
            // الصفحة لا تزال تحمل
            document.addEventListener('DOMContentLoaded', initializeData);
        } else {
            // الصفحة محملة بالفعل
            console.log('📄 الصفحة محملة بالفعل، بدء التحميل...');
            initializeData();
        }
        
        // Firebase فقط - لا حاجة للتحديث الدوري!
        console.log('🔥 Firebase ONLY - لا تحديث دوري، Firebase هو المصدر الوحيد!');
        
        // تسجيل Service Worker للأمان
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/sw.js')
                .then(function(registration) {
                    console.log('✅ Service Worker مسجل بنجاح:', registration.scope);
                })
                .catch(function(error) {
                    console.log('❌ فشل تسجيل Service Worker:', error);
                });
        }
        
        // دالة لإعادة تهيئة Firebase في حالة الأخطاء
        function reinitializeFirebase() {
            console.log('🔄 إعادة تهيئة Firebase...');
            
            // إعادة تعيين متغير التحميل
            dataLoaded = false;
            initializationAttempts = 0;
            
            // محاولة إعادة التحميل
            setTimeout(() => {
                initializeData();
            }, 1000);
        }
        
        // مراقبة أخطاء Firebase
        window.addEventListener('error', function(event) {
            if (event.message && event.message.includes('firestore')) {
                console.log('🚨 تم اكتشاف خطأ Firebase، محاولة إعادة التهيئة...');
                reinitializeFirebase();
            }
        });

        // تنظيف localStorage من الشهادات المحذوفة
        async function cleanupLocalStorage() {
            try {
                const localData = localStorage.getItem('certificates');
                if (!localData) return;

                const localCertificates = JSON.parse(localData);
                const validCertificates = [];

                // التحقق من كل شهادة في localStorage
                for (const cert of localCertificates) {
                    try {
                        const q = window.firebaseModules.query(
                            window.firebaseModules.collection(window.db, 'certificates'),
                            window.firebaseModules.where('uniqueId', '==', cert.uniqueId)
                        );
                        
                        const querySnapshot = await window.firebaseModules.getDocs(q);
                        
                        // إذا كانت الشهادة موجودة في Firebase، احتفظ بها
                        if (!querySnapshot.empty) {
                            validCertificates.push(cert);
                        }
                    } catch (error) {
                        // في حالة خطأ، احتفظ بالشهادة
                        validCertificates.push(cert);
                    }
                }

                // تحديث localStorage بالشهادات الصالحة فقط
                localStorage.setItem('certificates', JSON.stringify(validCertificates));
                
                console.log(`تم تنظيف localStorage: ${localCertificates.length - validCertificates.length} شهادة محذوفة`);
            } catch (error) {
                console.error('خطأ في تنظيف localStorage:', error);
            }
        }

        // تحميل العناصر المحذوفة
        async function loadDeletedItems() {
            console.log('🔄 تحميل العناصر المحذوفة...');
            const deletedItems = [];
            
            try {
                // تحميل من Firebase
                if (window.firebaseModules && window.db) {
                    console.log('📡 جلب البيانات من Firebase...');
                    const querySnapshot = await window.firebaseModules.getDocs(
                        window.firebaseModules.collection(window.db, 'certificates')
                    );
                    
                    querySnapshot.forEach((doc) => {
                        const data = doc.data();
                        // جلب العناصر المحذوفة فقط
                        if (data.deleted) {
                            deletedItems.push({ id: doc.id, ...data });
                            console.log('🗑️ عنصر محذوف:', data.name || data.fullName);
                        }
                    });
                } else {
                    console.log('⚠️ Firebase غير متاح، جلب من localStorage...');
                }

                // تحميل من localStorage كبديل
                const localData = localStorage.getItem('certificates');
                if (localData) {
                    const localCertificates = JSON.parse(localData);
                    localCertificates.forEach(cert => {
                        if (cert.deleted) {
                            // تجنب التكرار
                            const exists = deletedItems.find(item => 
                                (item.uniqueId && item.uniqueId === cert.uniqueId) ||
                                (item.serviceCode && item.serviceCode === cert.serviceCode)
                            );
                            if (!exists) {
                                deletedItems.push(cert);
                                console.log('🗑️ عنصر محذوف محلي:', cert.name || cert.fullName);
                            }
                        }
                    });
                }

                // تحميل الإجازات المرضية المحذوفة من localStorage المنفصل
                const allKeys = Object.keys(localStorage);
                const medicalLeaveKeys = allKeys.filter(key => key.startsWith('medical-leave-'));
                
                medicalLeaveKeys.forEach(key => {
                    const medicalLeaveData = localStorage.getItem(key);
                    if (medicalLeaveData) {
                        const medicalLeave = JSON.parse(medicalLeaveData);
                        if (medicalLeave.deleted) {
                            // تجنب التكرار
                            const exists = deletedItems.find(item => 
                                item.serviceCode === medicalLeave.serviceCode
                            );
                            if (!exists) {
                                deletedItems.push(medicalLeave);
                                console.log('🗑️ إجازة مرضية محذوفة محلية:', medicalLeave.fullName);
                            }
                        }
                    }
                });

                console.log(`📊 إجمالي العناصر المحذوفة: ${deletedItems.length}`);
                displayDeletedItems(deletedItems);
                
            } catch (error) {
                console.error('❌ خطأ في تحميل العناصر المحذوفة:', error);
                displayDeletedItems([]);
            }
        }

        // عرض العناصر المحذوفة
        function displayDeletedItems(items) {
            console.log('📋 عرض العناصر المحذوفة:', items);
            const tbody = document.getElementById('deletedItemsTable');
            
            if (!tbody) {
                console.error('❌ لم يتم العثور على جدول المحذوفات');
                return;
            }
            
            tbody.innerHTML = '';
            
            if (items.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center text-muted py-4">
                            <i class="fas fa-inbox fa-3x mb-3"></i>
                            <br>لا توجد عناصر محذوفة
                        </td>
                    </tr>
                `;
                console.log('📭 لا توجد عناصر محذوفة للعرض');
                return;
            }

            console.log(`📊 عرض ${items.length} عنصر محذوف`);
            items.forEach((item, index) => {
                // تحديد نوع العنصر بدقة أكبر
                const isHealthCertificate = item.amanah || item.uniqueId || (!item.idNumber && item.serviceCode);
                const isMedicalLeave = item.serviceCode && item.idNumber && !item.amanah && !item.uniqueId;
                
                const itemType = isMedicalLeave ? 'إجازة مرضية' : 'شهادة صحية';
                const itemName = item.name || item.fullName || '-';
                const itemId = isMedicalLeave ? item.idNumber : (item.medicalIdNumber || item.idNumber || '-');
                const deletedDate = item.deletedAt ? new Date(item.deletedAt).toLocaleDateString('ar-SA') : '-';
                const uniqueIdentifier = item.uniqueId || item.serviceCode;
                
                console.log(`📄 عنصر ${index + 1}: ${itemName} (${itemType}) - معرف: ${uniqueIdentifier}`, {
                    isHealthCertificate,
                    isMedicalLeave,
                    hasAmanah: !!item.amanah,
                    hasUniqueId: !!item.uniqueId,
                    hasIdNumber: !!item.idNumber,
                    hasServiceCode: !!item.serviceCode
                });
                
                const row = `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${itemName}</td>
                        <td>${itemId}</td>
                        <td>
                            <span class="badge ${isMedicalLeave ? 'bg-warning' : 'bg-info'}">
                                ${itemType}
                            </span>
                        </td>
                        <td>${deletedDate}</td>
                        <td>
                            <button class="btn btn-sm btn-success" onclick="restoreItem('${uniqueIdentifier}', '${item.id || ''}')" title="استعادة">
                                <i class="fas fa-undo"></i> استعادة
                            </button>
                            <button class="btn btn-sm btn-danger ms-2" onclick="permanentDelete('${uniqueIdentifier}', '${item.id || ''}')" title="حذف نهائي">
                                <i class="fas fa-trash"></i> حذف نهائي
                            </button>
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }

        // استعادة عنصر
        async function restoreItem(uniqueId, firebaseId) {
            console.log('🔄 محاولة استعادة العنصر:', { uniqueId, firebaseId });
            if (confirm('هل أنت متأكد من استعادة هذا العنصر؟')) {
                try {
                    let restored = false;
                    
                    // استعادة من Firebase
                    if (window.firebaseModules && window.db) {
                        try {
                            console.log('📡 البحث عن العنصر في Firebase...', uniqueId);
                            
                            // جرب البحث بـ uniqueId أولاً (للشهادات)
                            let q = window.firebaseModules.query(
                                window.firebaseModules.collection(window.db, 'certificates'),
                                window.firebaseModules.where('uniqueId', '==', uniqueId)
                            );
                            
                            let querySnapshot = await window.firebaseModules.getDocs(q);
                            
                            // إذا لم يتم العثور عليه، جرب البحث بـ serviceCode
                            if (querySnapshot.empty) {
                                console.log('🔄 لم يتم العثور بـ uniqueId، جرب serviceCode...');
                                q = window.firebaseModules.query(
                                    window.firebaseModules.collection(window.db, 'certificates'),
                                    window.firebaseModules.where('serviceCode', '==', uniqueId)
                                );
                                querySnapshot = await window.firebaseModules.getDocs(q);
                            }
                            
                            if (!querySnapshot.empty) {
                                // التحقق من نوع العنصر قبل الاستعادة
                                const docData = querySnapshot.docs[0].data();
                                const docRef = querySnapshot.docs[0].ref;
                                
                                // تحديد نوع العنصر
                                const isHealthCertificate = docData.amanah || docData.uniqueId || !docData.idNumber;
                                const isMedicalLeave = docData.serviceCode && docData.idNumber && !docData.amanah;
                                
                                console.log('🔍 نوع العنصر:', { 
                                    isHealthCertificate, 
                                    isMedicalLeave, 
                                    hasAmanah: !!docData.amanah,
                                    hasUniqueId: !!docData.uniqueId,
                                    hasIdNumber: !!docData.idNumber 
                                });
                                
                                await window.firebaseModules.updateDoc(docRef, {
                                    deleted: false,
                                    deletedAt: null,
                                    restoredAt: new Date().toISOString()
                                });
                                restored = true;
                                
                                if (isHealthCertificate) {
                                    console.log('✅ تم استعادة الشهادة الصحية في Firebase');
                                    // إعادة تحميل الشهادات فقط
                                    setTimeout(() => loadCertificatesFromFirebase(), 500);
                                } else if (isMedicalLeave) {
                                    console.log('✅ تم استعادة الإجازة المرضية في Firebase');
                                    // إعادة تحميل الإجازات المرضية فقط
                                    setTimeout(() => loadMedicalLeavesFromFirebase(), 500);
                                } else {
                                    console.log('✅ تم استعادة العنصر في Firebase');
                                    // إعادة تحميل كل شيء
                                    setTimeout(() => {
                                        loadCertificatesFromFirebase();
                                        loadMedicalLeavesFromFirebase();
                                    }, 500);
                                }
                            } else {
                                console.log('⚠️ لم يتم العثور على العنصر في Firebase');
                            }
                        } catch (error) {
                            console.error('❌ فشل في استعادة العنصر من Firebase:', error);
                        }
                    }
                    
                    // استعادة من localStorage
                    console.log('💾 استعادة من localStorage...');
                    const localData = localStorage.getItem('certificates');
                    if (localData) {
                        const certificates = JSON.parse(localData);
                        let foundInCertificates = false;
                        const updatedCertificates = certificates.map(cert => {
                            if (cert.uniqueId === uniqueId || cert.serviceCode === uniqueId) {
                                foundInCertificates = true;
                                console.log('✅ تم العثور على الشهادة في localStorage:', cert.name || cert.fullName);
                                return { 
                                    ...cert, 
                                    deleted: false, 
                                    deletedAt: null,
                                    restoredAt: new Date().toISOString()
                                };
                            }
                            return cert;
                        });
                        localStorage.setItem('certificates', JSON.stringify(updatedCertificates));
                        if (foundInCertificates) {
                            console.log('✅ تم تحديث الشهادة في localStorage');
                        }
                    }
                    
                    // استعادة الإجازات المرضية من localStorage المنفصل
                    console.log('🏥 البحث عن الإجازات المرضية في localStorage...');
                    const allKeys = Object.keys(localStorage);
                    const medicalLeaveKeys = allKeys.filter(key => key.startsWith('medical-leave-'));
                    console.log(`🔍 تم العثور على ${medicalLeaveKeys.length} إجازة مرضية في localStorage`);
                    
                    let foundMedicalLeave = false;
                    medicalLeaveKeys.forEach(key => {
                        const medicalLeaveData = localStorage.getItem(key);
                        if (medicalLeaveData) {
                            const medicalLeave = JSON.parse(medicalLeaveData);
                            console.log(`🔍 فحص الإجازة المرضية: ${key} - serviceCode: ${medicalLeave.serviceCode} - deleted: ${medicalLeave.deleted}`);
                            if (medicalLeave.serviceCode === uniqueId && medicalLeave.deleted) {
                                foundMedicalLeave = true;
                                medicalLeave.deleted = false;
                                medicalLeave.deletedAt = null;
                                medicalLeave.restoredAt = new Date().toISOString();
                                localStorage.setItem(key, JSON.stringify(medicalLeave));
                                console.log('✅ تم استعادة الإجازة المرضية من localStorage:', key);
                            }
                        }
                    });
                    
                    if (!foundMedicalLeave) {
                        console.log('⚠️ لم يتم العثور على إجازة مرضية محذوفة بهذا المعرف');
                    }
                    
                    // تحديث العرض - المحذوفات فقط (البيانات الأخرى تتحدث في Firebase)
                    loadDeletedItems();
                    
                    alert('تم استعادة العنصر بنجاح!');
                    
                } catch (error) {
                    console.error('خطأ في استعادة العنصر:', error);
                    alert('حدث خطأ في استعادة العنصر.');
                }
            }
        }

        // حذف نهائي
        async function permanentDelete(uniqueId, firebaseId) {
            if (confirm('هل أنت متأكد من الحذف النهائي؟ لا يمكن التراجع عن هذا الإجراء!')) {
                try {
                    let deleted = false;
                    
                    // حذف من Firebase
                    if (window.firebaseModules && window.db) {
                        try {
                            console.log('📡 البحث عن العنصر في Firebase للحذف النهائي...', uniqueId);
                            
                            // جرب البحث بـ uniqueId أولاً (للشهادات)
                            let q = window.firebaseModules.query(
                                window.firebaseModules.collection(window.db, 'certificates'),
                                window.firebaseModules.where('uniqueId', '==', uniqueId)
                            );
                            
                            let querySnapshot = await window.firebaseModules.getDocs(q);
                            
                            // إذا لم يتم العثور عليه، جرب البحث بـ serviceCode (للإجازات المرضية)
                            if (querySnapshot.empty) {
                                console.log('🔄 لم يتم العثور بـ uniqueId، جرب serviceCode...');
                                q = window.firebaseModules.query(
                                    window.firebaseModules.collection(window.db, 'certificates'),
                                    window.firebaseModules.where('serviceCode', '==', uniqueId)
                                );
                                querySnapshot = await window.firebaseModules.getDocs(q);
                            }
                            
                            if (!querySnapshot.empty) {
                                const docRef = querySnapshot.docs[0].ref;
                                await window.firebaseModules.deleteDoc(docRef);
                                deleted = true;
                                console.log('✅ تم الحذف النهائي من Firebase');
                            } else {
                                console.log('⚠️ لم يتم العثور على العنصر في Firebase');
                            }
                        } catch (error) {
                            console.error('❌ فشل في الحذف النهائي من Firebase:', error);
                        }
                    }
                    
                    // حذف من localStorage
                    const localData = localStorage.getItem('certificates');
                    if (localData) {
                        const certificates = JSON.parse(localData);
                        const updatedCertificates = certificates.filter(cert => 
                            cert.uniqueId !== uniqueId && cert.serviceCode !== uniqueId
                        );
                        localStorage.setItem('certificates', JSON.stringify(updatedCertificates));
                    }
                    
                    // حذف الإجازات المرضية من localStorage المنفصل
                    const allKeys = Object.keys(localStorage);
                    const medicalLeaveKeys = allKeys.filter(key => key.startsWith('medical-leave-'));
                    
                    medicalLeaveKeys.forEach(key => {
                        const medicalLeaveData = localStorage.getItem(key);
                        if (medicalLeaveData) {
                            const medicalLeave = JSON.parse(medicalLeaveData);
                            if (medicalLeave.serviceCode === uniqueId) {
                                localStorage.removeItem(key);
                                console.log('✅ تم حذف الإجازة المرضية نهائياً من localStorage:', key);
                            }
                        }
                    });
                    
                    // تحديث العرض
                    loadDeletedItems();
                    
                    alert('تم الحذف النهائي بنجاح!');
                    
                } catch (error) {
                    console.error('خطأ في الحذف النهائي:', error);
                    alert('حدث خطأ في الحذف النهائي.');
                }
            }
        }
    </script>
</body>
</html>
