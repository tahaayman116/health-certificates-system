<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ø£Ø¯Ù…Ù† - Ù†Ø¸Ø§Ù… Ø§Ù„Ø´Ù‡Ø§Ø¯Ø§Øª Ø§Ù„ØµØ­ÙŠØ©</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f5f7fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: #333;
        }
        
        .navbar {
            background: #fff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border-bottom: 3px solid #007bff;
        }
        
        .navbar-brand {
            font-weight: 600;
            font-size: 1.4rem;
            color: #007bff !important;
        }
        
        .main-container {
            padding: 20px 0;
        }
        
        .card {
            border: none;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .card-header {
            background: #007bff;
            color: white;
            border-radius: 8px 8px 0 0 !important;
            padding: 15px 20px;
            border: none;
            font-weight: 500;
        }
        
        .form-control, .form-select {
            border-radius: 6px;
            border: 2px solid #e9ecef;
            padding: 12px 15px;
            transition: all 0.3s ease;
        }
        
        .form-control:focus, .form-select:focus {
            border-color: #007bff;
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
        }
        
        .btn-primary {
            background: #007bff;
            border: none;
            border-radius: 6px;
            padding: 12px 30px;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .btn-primary:hover {
            background: #0056b3;
            transform: translateY(-1px);
        }
        
        .btn-outline-danger {
            border-radius: 6px;
            padding: 8px 16px;
            font-size: 0.9rem;
        }
        
        .btn-outline-primary {
            border-radius: 6px;
            padding: 8px 16px;
            font-size: 0.9rem;
        }
        
        .table {
            background: white;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .table th {
            background: #f8f9fa;
            border: none;
            font-weight: 600;
            color: #495057;
        }
        
        .table td {
            border: none;
            border-bottom: 1px solid #f1f3f4;
            vertical-align: middle;
        }
        
        .image-preview {
            max-width: 100px;
            max-height: 100px;
            border-radius: 6px;
            margin-top: 10px;
            border: 2px solid #e9ecef;
        }
        
        .form-label {
            font-weight: 500;
            color: #495057;
            margin-bottom: 8px;
        }
        
        .logout-btn {
            background: none;
            border: none;
            color: #dc3545;
            font-size: 0.9rem;
        }
        
        .logout-btn:hover {
            color: #c82333;
        }
        
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .btn-danger {
            border-radius: 10px;
            padding: 8px 20px;
            font-weight: 600;
        }
        
        .stats-card {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            text-align: center;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
        }
        
        .stats-number {
            font-size: 3rem;
            font-weight: 700;
            margin-bottom: 10px;
        }
        
        .table {
            border-radius: 10px;
            overflow: hidden;
        }
        
        .table thead th {
            background-color: #f8f9fa;
            border: none;
            font-weight: 600;
            padding: 15px;
        }
        
        .table tbody td {
            padding: 15px;
            vertical-align: middle;
            border-color: #f1f3f4;
        }
        
        .certificate-image {
            width: 50px;
            height: 50px;
            object-fit: cover;
            border-radius: 8px;
        }
        
        .status-badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }
        
        .image-preview {
            max-width: 200px;
            max-height: 200px;
            border-radius: 10px;
            margin-top: 10px;
        }
        
        .form-label {
            font-weight: 600;
            color: #495057;
            margin-bottom: 8px;
        }
        
        .required {
            color: #dc3545;
        }
        
        /* Responsive Design */
        @media (max-width: 768px) {
            .stats-card {
                margin-bottom: 15px;
            }
            
            .table-responsive {
                font-size: 0.85rem;
            }
            
            .btn-group .btn {
                padding: 4px 8px;
                font-size: 0.75rem;
            }
            
            .certificate-image {
                width: 35px;
                height: 35px;
            }
            
            .card-body {
                padding: 15px;
            }
            
            .form-control, .form-select {
                padding: 8px 12px;
                font-size: 0.9rem;
            }
        }
        
        @media (max-width: 576px) {
            .main-container {
                padding: 10px 0;
            }
            
            .card {
                margin-bottom: 15px;
            }
            
            .stats-number {
                font-size: 1.5rem;
            }
            
            .table th, .table td {
                padding: 8px 4px;
                font-size: 0.8rem;
            }
            
            .btn-group {
                flex-direction: column;
                width: 100%;
            }
            
            .btn-group .btn {
                margin-bottom: 2px;
                border-radius: 4px !important;
            }
        }
        
        /* ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø¬Ø¯ÙˆÙ„ */
        .table-hover tbody tr:hover {
            background-color: #f8f9fa;
        }
        
        .btn-group .btn {
            margin: 0 1px;
        }
        
        .badge {
            font-size: 0.75rem;
        }
        
        /* Toast notification */
        .toast-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            opacity: 0.95;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            animation: slideInRight 0.3s ease-out;
        }
        
        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 0.95;
            }
        }
        
        /* Modern Search Bar */
        .search-container {
            flex-shrink: 0;
        }
        
        .search-box {
            position: relative;
            width: 320px;
            background: linear-gradient(145deg, #ffffff 0%, #f8f9fa 100%);
            border-radius: 25px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1), inset 0 1px 0 rgba(255,255,255,0.6);
            border: 2px solid #e9ecef;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            overflow: hidden;
        }
        
        .search-box:hover {
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
            border-color: #007bff;
        }
        
        .search-box:focus-within {
            box-shadow: 0 4px 20px rgba(0, 123, 255, 0.3);
            border-color: #007bff;
            transform: translateY(-1px);
        }
        
        .search-box:focus-within .search-icon {
            color: #007bff;
            transform: translateY(-50%) scale(1.1);
        }
        
        .search-input {
            width: 100%;
            border: none;
            outline: none;
            padding: 12px 50px 12px 45px;
            font-size: 14px;
            background: transparent;
            color: #333;
        }
        
        .search-input::placeholder {
            color: #adb5bd;
            font-style: italic;
        }
        
        .search-icon {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #6c757d;
            font-size: 16px;
            z-index: 2;
            transition: all 0.3s ease;
        }
        
        .clear-btn {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: linear-gradient(145deg, #ff6b6b, #ee5a52);
            border: none;
            border-radius: 50%;
            width: 26px;
            height: 26px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 3;
            box-shadow: 0 2px 8px rgba(238, 90, 82, 0.3);
        }
        
        .clear-btn:hover {
            background: linear-gradient(145deg, #ff5252, #d32f2f);
            transform: translateY(-50%) scale(1.15);
            box-shadow: 0 4px 12px rgba(238, 90, 82, 0.4);
        }
        
        .clear-btn:active {
            transform: translateY(-50%) scale(0.9);
            box-shadow: 0 1px 4px rgba(238, 90, 82, 0.2);
        }
        
        /* Responsive Search */
        @media (max-width: 768px) {
            .card-header .d-flex {
                flex-direction: column;
                gap: 15px;
                align-items: stretch !important;
            }
            
            .search-box {
                width: 100%;
                max-width: none;
            }
            
            .search-input {
                padding: 14px 50px 14px 45px;
                font-size: 16px;
            }
        }
        
        @media (max-width: 576px) {
            .search-box {
                border-radius: 20px;
            }
            
            .search-input {
                padding: 12px 45px 12px 40px;
            }
            
            .search-icon {
                left: 12px;
                font-size: 14px;
            }
            
            .clear-btn {
                right: 8px;
                width: 22px;
                height: 22px;
                font-size: 9px;
            }
        }
        
        /* Highlight search results */
        .highlight {
            background-color: #fff3cd;
            padding: 1px 3px;
            border-radius: 3px;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container">
            <a class="navbar-brand" href="#">
                <i class="fas fa-certificate me-2"></i>
                Ù†Ø¸Ø§Ù… Ø§Ù„Ø´Ù‡Ø§Ø¯Ø§Øª Ø§Ù„ØµØ­ÙŠØ©
            </a>
            <div class="navbar-nav ms-auto">
                <a href="/medical-leaves.html" class="btn btn-outline-primary me-2">
                    <i class="fas fa-calendar-alt me-2"></i>
                    Ø§Ù„Ø¥Ø¬Ø§Ø²Ø§Øª Ø§Ù„Ù…Ø±Ø¶ÙŠØ©
                </a>
                <button type="button" class="btn btn-danger" onclick="logout()">
                    <i class="fas fa-sign-out-alt me-2"></i>
                    ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
                </button>
            </div>
        </div>
    </nav>

    <div class="container main-container">
        <!-- Statistics -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="stats-card">
                    <div class="stats-number" id="totalCertificates">0</div>
                    <div>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø§Øª</div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="stats-card" style="background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);">
                    <div class="stats-number" id="todayCertificates">0</div>
                    <div>Ø´Ù‡Ø§Ø¯Ø§Øª Ø§Ù„ÙŠÙˆÙ…</div>
                </div>
            </div>
        </div>

        <!-- Medical Leaves Statistics -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="stats-card" style="background: linear-gradient(135deg, #28a745 0%, #1e7e34 100%);">
                    <div class="stats-number" id="totalMedicalLeaves">0</div>
                    <div>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¥Ø¬Ø§Ø²Ø§Øª Ø§Ù„Ù…Ø±Ø¶ÙŠØ©</div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="stats-card" style="background: linear-gradient(135deg, #dc3545 0%, #a71e2a 100%);">
                    <div class="stats-number" id="todayMedicalLeaves">0</div>
                    <div>Ø¥Ø¬Ø§Ø²Ø§Øª Ù…Ø±Ø¶ÙŠØ© Ø§Ù„ÙŠÙˆÙ…</div>
                </div>
            </div>
        </div>

        <!-- Navigation Tabs -->
        <div class="row mb-4">
            <div class="col-12">
                <ul class="nav nav-tabs" id="managementTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="active-tab" data-bs-toggle="tab" data-bs-target="#active-content" type="button" role="tab">
                            <i class="fas fa-certificate me-2"></i>Ø§Ù„Ø´Ù‡Ø§Ø¯Ø§Øª Ø§Ù„Ù†Ø´Ø·Ø©
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="deleted-tab" data-bs-toggle="tab" data-bs-target="#deleted-content" type="button" role="tab" onclick="loadDeletedItems()">
                            <i class="fas fa-trash-restore me-2"></i>Ø§Ù„Ù…Ø­Ø°ÙˆÙØ§Øª
                        </button>
                    </li>
                </ul>
            </div>
        </div>

        <div class="tab-content" id="managementTabsContent">
            <!-- Active Content Tab -->
            <div class="tab-pane fade show active" id="active-content" role="tabpanel">

        <!-- Add Certificate Form -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-plus-circle me-2"></i>
                            Ø¥Ø¶Ø§ÙØ© Ø´Ù‡Ø§Ø¯Ø© ØµØ­ÙŠØ© Ø¬Ø¯ÙŠØ¯Ø©
                        </h5>
                    </div>
                    <div class="card-body">
                        <form id="certificateForm">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Ø§Ù„Ø£Ù…Ø§Ù†Ø©</label>
                                    <input type="text" class="form-control" id="amanah">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Ø§Ù„Ø¨Ù„Ø¯ÙŠØ©</label>
                                    <input type="text" class="form-control" id="municipality">
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Ø§Ù„Ø§Ø³Ù…</label>
                                    <input type="text" class="form-control" id="fullName">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ©</label>
                                    <input type="text" class="form-control" id="idNumber">
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Ø§Ù„Ø¬Ù†Ø³</label>
                                    <select class="form-select" id="gender">
                                        <option value="">Ø§Ø®ØªØ± Ø§Ù„Ø¬Ù†Ø³</option>
                                        <option value="Ø°ÙƒØ±">Ø°ÙƒØ±</option>
                                        <option value="Ø£Ù†Ø«Ù‰">Ø£Ù†Ø«Ù‰</option>
                                    </select>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Ø§Ù„Ø¬Ù†Ø³ÙŠØ©</label>
                                    <input type="text" class="form-control" id="nationality">
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Ø±Ù‚Ù… Ø§Ù„Ø´Ù‡Ø§Ø¯Ø© Ø§Ù„ØµØ­ÙŠØ©</label>
                                    <input type="text" class="form-control" id="certificateNumber">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Ø§Ù„Ù…Ù‡Ù†Ø©</label>
                                    <input type="text" class="form-control" id="profession">
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥ØµØ¯Ø§Ø± (Ù…ÙŠÙ„Ø§Ø¯ÙŠ)</label>
                                    <input type="text" class="form-control" id="issueDate" placeholder="Ù…Ø«Ø§Ù„: 2024/03/15" onchange="calculateExpiryDate()">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ (Ù…ÙŠÙ„Ø§Ø¯ÙŠ)</label>
                                    <input type="text" class="form-control" id="expiryDate" placeholder="Ù…Ø«Ø§Ù„: 2025/03/15">
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Ù†ÙˆØ¹ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø©</label>
                                    <select class="form-select" id="certificateType" title="Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø©">
                                        <option value="Ø§Ù„Ø´Ù‡Ø§Ø¯Ø© Ø§Ù„ØµØ­ÙŠØ© Ø§Ù„Ù…ÙˆØ­Ø¯Ø©">Ø§Ù„Ø´Ù‡Ø§Ø¯Ø© Ø§Ù„ØµØ­ÙŠØ© Ø§Ù„Ù…ÙˆØ­Ø¯Ø©</option>
                                        <option value="Ø´Ù‡Ø§Ø¯Ø© ØµØ­ÙŠØ©">Ø´Ù‡Ø§Ø¯Ø© ØµØ­ÙŠØ©</option>
                                        <option value="Ø§Ù„Ø´Ù‡Ø§Ø¯Ø© Ø§Ù„ØµØ­ÙŠØ© Ø§Ù„Ø³Ù†ÙˆÙŠØ©">Ø§Ù„Ø´Ù‡Ø§Ø¯Ø© Ø§Ù„ØµØ­ÙŠØ© Ø§Ù„Ø³Ù†ÙˆÙŠØ©</option>
                                    </select>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Ù†ÙˆØ¹ Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬ Ø§Ù„ØªØ«Ù‚ÙŠÙÙŠ</label>
                                    <input type="text" class="form-control" id="programType" placeholder="Ø£Ø¯Ø®Ù„ Ù†ÙˆØ¹ Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬ Ø§Ù„ØªØ«Ù‚ÙŠÙÙŠ">
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Ø±Ù‚Ù… Ø§Ù„Ø±Ø®ØµØ©</label>
                                    <input type="text" class="form-control" id="licenseNumber">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Ø§Ø³Ù… Ø§Ù„Ù…Ù†Ø´Ø£Ø©</label>
                                    <input type="text" class="form-control" id="facilityName">
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Ø±Ù‚Ù… Ø§Ù„Ù…Ù†Ø´Ø£Ø©</label>
                                <input type="text" class="form-control" id="facilityNumber">
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">ØªØ§Ø±ÙŠØ® Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ø´Ù‡Ø§Ø¯Ø© Ø§Ù„ØµØ­ÙŠØ© (Ù‡Ø¬Ø±ÙŠ)</label>
                                    <input type="text" class="form-control" id="issueDateHijri" placeholder="Ù…Ø«Ø§Ù„: 1445/03/15">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">ØªØ§Ø±ÙŠØ® Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø´Ù‡Ø§Ø¯Ø© Ø§Ù„ØµØ­ÙŠØ© (Ù‡Ø¬Ø±ÙŠ)</label>
                                    <input type="text" class="form-control" id="expiryDateHijri" placeholder="Ù…Ø«Ø§Ù„: 1446/03/15">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">ØªØ§Ø±ÙŠØ® Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬ Ø§Ù„ØªØ«Ù‚ÙŠÙÙŠ</label>
                                    <input type="text" class="form-control" id="educationalProgramExpiry" placeholder="Ù…Ø«Ø§Ù„: 2025/03/15">
                                </div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">ØµÙˆØ±Ø© Ø§Ù„Ø´Ø®Øµ</label>
                                <input type="file" class="form-control" id="personImage" accept="image/*">
                                <img id="imagePreview" class="image-preview" style="display: none;">
                            </div>
                            
                            <button type="submit" class="btn btn-primary w-100">
                                <i class="fas fa-save me-2"></i>
                                Ø­ÙØ¸ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø©
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Add Medical Leave Form -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-calendar-alt me-2"></i>
                            Ø¥Ø¶Ø§ÙØ© Ø¥Ø¬Ø§Ø²Ø© Ù…Ø±Ø¶ÙŠØ© Ø¬Ø¯ÙŠØ¯Ø©
                        </h5>
                    </div>
                    <div class="card-body">
                        <form id="medicalLeaveForm">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Ø±Ù…Ø² Ø§Ù„Ø®Ø¯Ù…Ø© <span class="required">*</span></label>
                                    <input type="text" class="form-control" id="serviceCode" maxlength="14" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ© / Ø§Ù„Ø¥Ù‚Ø§Ù…Ø© <span class="required">*</span></label>
                                    <input type="text" class="form-control" id="medicalIdNumber" maxlength="10" pattern="\d*" required>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Ø§Ù„Ø§Ø³Ù…</label>
                                    <input type="text" class="form-control" id="patientName">
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">ØªØ§Ø±ÙŠØ® Ø¥ØµØ¯Ø§Ø± ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø¥Ø¬Ø§Ø²Ø©</label>
                                    <input type="date" class="form-control" id="reportIssueDate" value="">
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">ØªØ¨Ø¯Ø£ Ù…Ù†</label>
                                    <input type="date" class="form-control" id="leaveStart">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">ÙˆØ­ØªÙ‰</label>
                                    <input type="date" class="form-control" id="leaveEnd">
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Ø§Ù„Ù…Ø¯Ø© Ø¨Ø§Ù„Ø£ÙŠØ§Ù…</label>
                                    <input type="number" class="form-control" id="leaveDuration" min="1">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Ø§Ø³Ù… Ø§Ù„Ù…Ù…Ø§Ø±Ø³</label>
                                    <input type="text" class="form-control" id="doctorName">
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Ø§Ù„Ù…Ø³Ù…Ù‰ Ø§Ù„ÙˆØ¸ÙŠÙÙŠ</label>
                                <input type="text" class="form-control" id="jobTitle">
                            </div>
                            
                            <button type="submit" class="btn btn-primary w-100">
                                <i class="fas fa-save me-2"></i>
                                Ø­ÙØ¸ Ø§Ù„Ø¥Ø¬Ø§Ø²Ø© Ø§Ù„Ù…Ø±Ø¶ÙŠØ©
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Medical Leaves List -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">
                                <i class="fas fa-list me-2"></i>
                                Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¥Ø¬Ø§Ø²Ø§Øª Ø§Ù„Ù…Ø±Ø¶ÙŠØ© Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©
                            </h5>
                            <button class="btn btn-outline-primary btn-sm" onclick="loadMedicalLeaves()">
                                <i class="fas fa-refresh me-1"></i>
                                ØªØ­Ø¯ÙŠØ«
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div id="medicalLeavesList">
                            <div class="text-center text-muted py-4">
                                <i class="fas fa-calendar-alt fa-3x mb-3"></i>
                                <p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø¬Ø§Ø²Ø§Øª Ù…Ø±Ø¶ÙŠØ© Ù…Ø­ÙÙˆØ¸Ø©</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Certificates List -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">
                                <i class="fas fa-certificate me-2"></i>
                                Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø´Ù‡Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©
                            </h5>
                            <div class="search-container">
                                <div class="search-box">
                                    <i class="fas fa-search search-icon"></i>
                                    <input type="text" class="search-input" id="searchInput" placeholder="Ø§Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø§Øª..." onkeyup="searchCertificates()" oninput="searchCertificates()">
                                    <button class="clear-btn" type="button" id="clearSearch" onclick="clearSearch()" style="display: none;" title="Ù…Ø³Ø­ Ø§Ù„Ø¨Ø­Ø«">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <small class="text-muted">
                                <span id="certificatesCount">0</span> Ø´Ù‡Ø§Ø¯Ø©
                                <span id="searchResults" style="display: none;"> - <span id="filteredCount">0</span> Ù†ØªÙŠØ¬Ø© Ø¨Ø­Ø«</span>
                            </small>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th><i class="fas fa-image me-1"></i> Ø§Ù„ØµÙˆØ±Ø©</th>
                                        <th><i class="fas fa-user me-1"></i> Ø§Ù„Ø§Ø³Ù…</th>
                                        <th><i class="fas fa-id-card me-1"></i> Ø±Ù‚Ù… Ø§Ù„Ø´Ù‡Ø§Ø¯Ø©</th>
                                        <th><i class="fas fa-calendar me-1"></i> ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥ØµØ¯Ø§Ø±</th>
                                        <th><i class="fas fa-cogs me-1"></i> Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                                    </tr>
                                </thead>
                                <tbody id="certificatesTable">
                                    <!-- Ø³ÙŠØªÙ… Ù…Ù„Ø¡ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù‡Ù†Ø§ -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

            </div> <!-- End Active Content Tab -->

            <!-- Deleted Content Tab -->
            <div class="tab-pane fade" id="deleted-content" role="tabpanel">
                <div class="row">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">
                                    <i class="fas fa-trash-restore me-2"></i>
                                    Ø§Ù„Ø´Ù‡Ø§Ø¯Ø§Øª ÙˆØ§Ù„Ø¥Ø¬Ø§Ø²Ø§Øª Ø§Ù„Ù…Ø­Ø°ÙˆÙØ©
                                </h5>
                                <button class="btn btn-primary" onclick="loadDeletedItems()">
                                    <i class="fas fa-sync-alt me-2"></i>ØªØ­Ø¯ÙŠØ«
                                </button>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-striped">
                                        <thead>
                                            <tr>
                                                <th><i class="fas fa-hashtag me-1"></i> #</th>
                                                <th><i class="fas fa-user me-1"></i> Ø§Ù„Ø§Ø³Ù…</th>
                                                <th><i class="fas fa-id-card me-1"></i> Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ©</th>
                                                <th><i class="fas fa-tag me-1"></i> Ø§Ù„Ù†ÙˆØ¹</th>
                                                <th><i class="fas fa-calendar me-1"></i> ØªØ§Ø±ÙŠØ® Ø§Ù„Ø­Ø°Ù</th>
                                                <th><i class="fas fa-cogs me-1"></i> Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                                            </tr>
                                        </thead>
                                        <tbody id="deletedItemsTable">
                                            <!-- Ø³ÙŠØªÙ… Ù…Ù„Ø¡ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù‡Ù†Ø§ -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div> <!-- End Deleted Content Tab -->

        </div> <!-- End Tab Content -->
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, query, orderBy, where, updateDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        // ØªÙ… Ø¥Ø²Ø§Ù„Ø© Storage Ù„ØªÙˆÙÙŠØ± Ø§Ù„Ø®Ø·Ø© Ø§Ù„Ù…Ø¬Ø§Ù†ÙŠØ©

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDOVmQ5HY0KrsaITu3Sl55-gjPwoKLPguE",
            authDomain: "certificates-8b2bb.firebaseapp.com",
            projectId: "certificates-8b2bb",
            storageBucket: "certificates-8b2bb.firebasestorage.app",
            messagingSenderId: "865099561039",
            appId: "1:865099561039:web:644ec7c3ffce81cd77523a",
            measurementId: "G-C2P94SNR6D"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Make Firebase available globally
        window.db = db;
        window.firebaseModules = {
            collection, addDoc, getDocs, deleteDoc, doc, query, orderBy, where, updateDoc
        };
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // ØªØ£Ù…ÙŠÙ† Ù‚ÙˆÙŠ Ù„Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…
        function checkAuthentication() {
            const isLoggedIn = localStorage.getItem('adminLoggedIn');
            const loginTime = localStorage.getItem('loginTime');
            const currentTime = new Date().getTime();
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø¬Ù„Ø³Ø© (24 Ø³Ø§Ø¹Ø©)
            if (isLoggedIn !== 'true' || !loginTime || (currentTime - parseInt(loginTime)) > 24 * 60 * 60 * 1000) {
                localStorage.clear();
                sessionStorage.clear();
                window.location.replace('admin-login.html');
                return false;
            }
            return true;
        }

        // ÙØ­Øµ Ø§Ù„ØªÙˆØ«ÙŠÙ‚ Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
        if (!checkAuthentication()) {
            throw new Error('Unauthorized access');
        }

        // ÙØ­Øµ Ø¯ÙˆØ±ÙŠ ÙƒÙ„ 30 Ø«Ø§Ù†ÙŠØ©
        setInterval(checkAuthentication, 30000);

        // Ù…Ù†Ø¹ Ø§Ù„ÙˆØµÙˆÙ„ Ø¹Ø¨Ø± Ø§Ù„ØªØ§Ø±ÙŠØ®
        window.addEventListener('beforeunload', function() {
            if (localStorage.getItem('adminLoggedIn') !== 'true') {
                window.location.replace('admin-login.html');
            }
        });

        // Ù…Ù†Ø¹ Ø§Ù„Ø±Ø¬ÙˆØ¹ Ù„Ù„Ø®Ù„Ù Ø¨Ø¹Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
        window.addEventListener('pageshow', function(event) {
            if (event.persisted || window.performance && window.performance.navigation.type === 2) {
                if (!checkAuthentication()) {
                    window.location.replace('admin-login.html');
                }
            }
        });

        // Ù…ØªØºÙŠØ±Ø§Øª Ø¹Ø§Ù…Ø©
        let certificates = [];
        let filteredCertificates = [];

        // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
        function logout() {
            localStorage.removeItem('adminLoggedIn');
            localStorage.removeItem('loginTime');
            window.location.href = 'admin-login.html';
        }

        // Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ØµÙˆØ±Ø©
        document.getElementById('personImage').addEventListener('change', function(e) {
            const file = e.target.files[0];
            const preview = document.getElementById('imagePreview');
            
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    preview.src = e.target.result;
                    preview.style.display = 'block';
                };
                reader.readAsDataURL(file);
            } else {
                preview.style.display = 'none';
            }
        });

        // ØªØ­ÙˆÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø© Ø¥Ù„Ù‰ Base64
        function convertImageToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        // Ø¶ØºØ· Ø§Ù„ØµÙˆØ±Ø© Ù„ØªÙˆÙÙŠØ± Ù…Ø³Ø§Ø­Ø© Ø§Ù„ØªØ®Ø²ÙŠÙ†
        function compressImage(file, maxWidth = 300, quality = 0.8) {
            return new Promise((resolve) => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const img = new Image();
                
                img.onload = () => {
                    // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø£Ø¨Ø¹Ø§Ø¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
                    const ratio = Math.min(maxWidth / img.width, maxWidth / img.height);
                    canvas.width = img.width * ratio;
                    canvas.height = img.height * ratio;
                    
                    // Ø±Ø³Ù… Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ù…Ø¶ØºÙˆØ·Ø©
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    
                    // ØªØ­ÙˆÙŠÙ„ Ø¥Ù„Ù‰ Base64
                    const compressedDataUrl = canvas.toDataURL('image/jpeg', quality);
                    resolve(compressedDataUrl);
                };
                
                img.src = URL.createObjectURL(file);
            });
        }

        // Ø¥Ø¶Ø§ÙØ© Ø´Ù‡Ø§Ø¯Ø© Ø¬Ø¯ÙŠØ¯Ø©
        document.getElementById('certificateForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            try {
                const certificateData = {
                    amanah: document.getElementById('amanah').value,
                    municipality: document.getElementById('municipality').value,
                    fullName: document.getElementById('fullName').value,
                    idNumber: document.getElementById('idNumber').value,
                    gender: document.getElementById('gender').value,
                    nationality: document.getElementById('nationality').value,
                    certificateNumber: document.getElementById('certificateNumber').value,
                    profession: document.getElementById('profession').value,
                    issueDate: document.getElementById('issueDate').value,
                    expiryDate: document.getElementById('expiryDate').value,
                    certificateType: document.getElementById('certificateType').value,
                    programType: document.getElementById('programType').value,
                    licenseNumber: document.getElementById('licenseNumber').value,
                    facilityName: document.getElementById('facilityName').value,
                    facilityNumber: document.getElementById('facilityNumber').value,
                    issueDateHijri: document.getElementById('issueDateHijri').value,
                    expiryDateHijri: document.getElementById('expiryDateHijri').value,
                    educationalProgramExpiry: document.getElementById('educationalProgramExpiry').value,
                    createdAt: new Date().toISOString(),
                    uniqueId: generateUniqueId()
                };

                // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØµÙˆØ±Ø© Ø¥Ø°Ø§ ØªÙ… Ø§Ø®ØªÙŠØ§Ø±Ù‡Ø§
                const imageFile = document.getElementById('personImage').files[0];
                if (imageFile) {
                    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø¬Ù… Ø§Ù„ØµÙˆØ±Ø© (Ø£Ù‚Ù„ Ù…Ù† 5MB)
                    if (imageFile.size > 5 * 1024 * 1024) {
                        alert('Ø­Ø¬Ù… Ø§Ù„ØµÙˆØ±Ø© ÙƒØ¨ÙŠØ± Ø¬Ø¯Ø§Ù‹. ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± ØµÙˆØ±Ø© Ø£ØµØºØ± Ù…Ù† 5MB');
                        return;
                    }
                    
                    // Ø¶ØºØ· ÙˆØªØ­ÙˆÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø© Ø¥Ù„Ù‰ Base64
                    certificateData.imageBase64 = await compressImage(imageFile);
                }

                // Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Firestore
                await window.firebaseModules.addDoc(window.firebaseModules.collection(window.db, 'certificates'), certificateData);
                
                // Ø­ÙØ¸ Ù†Ø³Ø®Ø© Ù…Ø­Ù„ÙŠØ© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©
                const localCertificates = JSON.parse(localStorage.getItem('certificates') || '[]');
                localCertificates.push(certificateData);
                localStorage.setItem('certificates', JSON.stringify(localCertificates));
                
                alert('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø© Ø¨Ù†Ø¬Ø§Ø­!');
                this.reset();
                document.getElementById('imagePreview').style.display = 'none';
                loadCertificates();
                
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø©:', error);
                
                // ÙÙŠ Ø­Ø§Ù„Ø© ÙØ´Ù„ FirebaseØŒ Ø§Ø­ÙØ¸ Ù…Ø­Ù„ÙŠØ§Ù‹ ÙÙ‚Ø·
                const certificateData = {
                    amanah: document.getElementById('amanah').value,
                    municipality: document.getElementById('municipality').value,
                    fullName: document.getElementById('fullName').value,
                    idNumber: document.getElementById('idNumber').value,
                    gender: document.getElementById('gender').value,
                    nationality: document.getElementById('nationality').value,
                    certificateNumber: document.getElementById('certificateNumber').value,
                    profession: document.getElementById('profession').value,
                    issueDate: document.getElementById('issueDate').value,
                    expiryDate: document.getElementById('expiryDate').value,
                    certificateType: document.getElementById('certificateType').value,
                    programType: document.getElementById('programType').value,
                    licenseNumber: document.getElementById('licenseNumber').value,
                    facilityName: document.getElementById('facilityName').value,
                    facilityNumber: document.getElementById('facilityNumber').value,
                    issueDateHijri: document.getElementById('issueDateHijri').value,
                    expiryDateHijri: document.getElementById('expiryDateHijri').value,
                    educationalProgramExpiry: document.getElementById('educationalProgramExpiry').value,
                    createdAt: new Date().toISOString(),
                    uniqueId: generateUniqueId(),
                    id: 'local_' + Date.now()
                };

                const imageFile = document.getElementById('personImage').files[0];
                if (imageFile && imageFile.size <= 5 * 1024 * 1024) {
                    certificateData.imageBase64 = await compressImage(imageFile);
                }

                const localCertificates = JSON.parse(localStorage.getItem('certificates') || '[]');
                localCertificates.push(certificateData);
                localStorage.setItem('certificates', JSON.stringify(localCertificates));
                
                alert('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø© Ù…Ø­Ù„ÙŠØ§Ù‹ (Firebase ØºÙŠØ± Ù…ØªØ§Ø­ Ø­Ø§Ù„ÙŠØ§Ù‹)');
                this.reset();
                document.getElementById('imagePreview').style.display = 'none';
                loadCertificates();
            }
        });

        // ØªÙˆÙ„ÙŠØ¯ Ù…Ø¹Ø±Ù ÙØ±ÙŠØ¯
        function generateUniqueId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }

        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©
        function loadLocalCertificates() {
            try {
                console.log('ğŸ“ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø§Øª Ù…Ù† localStorage...');
                const localData = localStorage.getItem('certificates');
                if (localData) {
                    const allCertificates = JSON.parse(localData);
                    // ÙÙ„ØªØ±Ø© Ø§Ù„Ø´Ù‡Ø§Ø¯Ø§Øª ØºÙŠØ± Ø§Ù„Ù…Ø­Ø°ÙˆÙØ©
                    certificates = allCertificates.filter(cert => !cert.deleted);
                    console.log(`âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ ${certificates.length} Ø´Ù‡Ø§Ø¯Ø© Ù…Ù† localStorage`);
                } else {
                    certificates = [];
                    console.log('ğŸ“­ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø´Ù‡Ø§Ø¯Ø§Øª ÙÙŠ localStorage');
                }
                displayCertificates();
                updateStatistics(); // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©:', error);
                certificates = [];
                displayCertificates();
                updateStatistics(); // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø­ØªÙ‰ Ù„Ùˆ ÙƒØ§Ù†Øª ÙØ§Ø±ØºØ©
            }
        }
        
        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø¬Ø§Ø²Ø§Øª Ø§Ù„Ù…Ø±Ø¶ÙŠØ© Ø§Ù„Ù…Ø­Ù„ÙŠØ©
        function loadLocalMedicalLeaves() {
            try {
                console.log('ğŸ¥ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø¬Ø§Ø²Ø§Øª Ø§Ù„Ù…Ø±Ø¶ÙŠØ© Ù…Ù† localStorage...');
                medicalLeaves = [];
                
                // Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø¬Ù…ÙŠØ¹ Ù…ÙØ§ØªÙŠØ­ localStorage Ø¹Ù† Ø§Ù„Ø¥Ø¬Ø§Ø²Ø§Øª Ø§Ù„Ù…Ø±Ø¶ÙŠØ©
                const allKeys = Object.keys(localStorage);
                const medicalLeaveKeys = allKeys.filter(key => key.startsWith('medical-leave-'));
                
                medicalLeaveKeys.forEach(key => {
                    try {
                        const medicalLeaveData = localStorage.getItem(key);
                        if (medicalLeaveData) {
                            const medicalLeave = JSON.parse(medicalLeaveData);
                            // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¥Ø¬Ø§Ø²Ø§Øª ØºÙŠØ± Ø§Ù„Ù…Ø­Ø°ÙˆÙØ© ÙÙ‚Ø·
                            if (!medicalLeave.deleted) {
                                medicalLeaves.push(medicalLeave);
                            }
                        }
                    } catch (error) {
                        console.error(`Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø¬Ø§Ø²Ø© Ø§Ù„Ù…Ø±Ø¶ÙŠØ© ${key}:`, error);
                    }
                });
                
                console.log(`âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ ${medicalLeaves.length} Ø¥Ø¬Ø§Ø²Ø© Ù…Ø±Ø¶ÙŠØ© Ù…Ù† localStorage`);
                window.medicalLeaves = medicalLeaves; // Ø­ÙØ¸ ÙÙŠ Ø§Ù„Ù…ØªØºÙŠØ± Ø§Ù„Ø¹Ø§Ù…
                displayMedicalLeaves();
                updateMedicalLeavesStatistics(); // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø¬Ø§Ø²Ø§Øª Ø§Ù„Ù…Ø±Ø¶ÙŠØ© Ø§Ù„Ù…Ø­Ù„ÙŠØ©:', error);
                medicalLeaves = [];
                window.medicalLeaves = medicalLeaves;
                displayMedicalLeaves();
                updateMedicalLeavesStatistics(); // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø­ØªÙ‰ Ù„Ùˆ ÙƒØ§Ù†Øª ÙØ§Ø±ØºØ©
            }
        }
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©
        function updateLocalStatistics() {
            try {
                console.log('ğŸ“Š ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©...');
                
                const today = new Date().toDateString();
                let totalCertificates = 0;
                let todayCertificates = 0;
                let totalMedicalLeaves = 0;
                let todayMedicalLeaves = 0;
                
                // Ø­Ø³Ø§Ø¨ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø´Ù‡Ø§Ø¯Ø§Øª
                if (certificates && certificates.length > 0) {
                    totalCertificates = certificates.filter(cert => !cert.deleted).length;
                    todayCertificates = certificates.filter(cert => {
                        if (cert.deleted) return false;
                        const certDate = new Date(cert.createdAt || cert.created_at);
                        return certDate.toDateString() === today;
                    }).length;
                }
                
                // Ø­Ø³Ø§Ø¨ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¥Ø¬Ø§Ø²Ø§Øª Ø§Ù„Ù…Ø±Ø¶ÙŠØ©
                if (medicalLeaves && medicalLeaves.length > 0) {
                    totalMedicalLeaves = medicalLeaves.filter(leave => !leave.deleted).length;
                    todayMedicalLeaves = medicalLeaves.filter(leave => {
                        if (leave.deleted) return false;
                        const leaveDate = new Date(leave.created_at);
                        return leaveDate.toDateString() === today;
                    }).length;
                }
                
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø±Ø¶
                document.getElementById('totalCertificates').textContent = totalCertificates;
                document.getElementById('todayCertificates').textContent = todayCertificates;
                document.getElementById('totalMedicalLeaves').textContent = totalMedicalLeaves;
                document.getElementById('todayMedicalLeaves').textContent = todayMedicalLeaves;
                
                console.log(`ğŸ“ˆ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª: Ø´Ù‡Ø§Ø¯Ø§Øª (${totalCertificates}/${todayCertificates}) - Ø¥Ø¬Ø§Ø²Ø§Øª (${totalMedicalLeaves}/${todayMedicalLeaves})`);
                
            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©:', error);
            }
        }
        
        // ØªØ­Ø¯ÙŠØ« Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¥Ø¬Ø§Ø²Ø§Øª Ø§Ù„Ù…Ø±Ø¶ÙŠØ© Ù…Ù† localStorage
        function updateLocalMedicalLeavesStatistics() {
            try {
                console.log('ğŸ“Š Ø­Ø³Ø§Ø¨ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¥Ø¬Ø§Ø²Ø§Øª Ø§Ù„Ù…Ø±Ø¶ÙŠØ© Ù…Ù† localStorage...');
                
                const today = new Date().toDateString();
                let totalMedicalLeaves = 0;
                let todayMedicalLeaves = 0;
                
                // Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø¬Ù…ÙŠØ¹ Ù…ÙØ§ØªÙŠØ­ localStorage Ø¹Ù† Ø§Ù„Ø¥Ø¬Ø§Ø²Ø§Øª Ø§Ù„Ù…Ø±Ø¶ÙŠØ©
                const allKeys = Object.keys(localStorage);
                const medicalLeaveKeys = allKeys.filter(key => key.startsWith('medical-leave-'));
                
                medicalLeaveKeys.forEach(key => {
                    try {
                        const medicalLeaveData = localStorage.getItem(key);
                        if (medicalLeaveData) {
                            const medicalLeave = JSON.parse(medicalLeaveData);
                            // Ø¹Ø¯ Ø§Ù„Ø¥Ø¬Ø§Ø²Ø§Øª ØºÙŠØ± Ø§Ù„Ù…Ø­Ø°ÙˆÙØ© ÙÙ‚Ø·
                            if (!medicalLeave.deleted) {
                                totalMedicalLeaves++;
                                
                                // Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„ÙŠÙˆÙ…
                                const leaveDate = new Date(medicalLeave.created_at);
                                if (leaveDate.toDateString() === today) {
                                    todayMedicalLeaves++;
                                }
                            }
                        }
                    } catch (error) {
                        console.error(`Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¥Ø¬Ø§Ø²Ø© Ø§Ù„Ù…Ø±Ø¶ÙŠØ© ${key}:`, error);
                    }
                });
                
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø±Ø¶
                document.getElementById('totalMedicalLeaves').textContent = totalMedicalLeaves;
                document.getElementById('todayMedicalLeaves').textContent = todayMedicalLeaves;
                
                console.log(`âœ… Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¥Ø¬Ø§Ø²Ø§Øª Ø§Ù„Ù…Ø±Ø¶ÙŠØ© Ø§Ù„Ù…Ø­Ù„ÙŠØ©: Ø¥Ø¬Ù…Ø§Ù„ÙŠ ${totalMedicalLeaves} - Ø§Ù„ÙŠÙˆÙ… ${todayMedicalLeaves}`);
                
            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø­Ø³Ø§Ø¨ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¥Ø¬Ø§Ø²Ø§Øª Ø§Ù„Ù…Ø±Ø¶ÙŠØ© Ø§Ù„Ù…Ø­Ù„ÙŠØ©:', error);
                document.getElementById('totalMedicalLeaves').textContent = '0';
                document.getElementById('todayMedicalLeaves').textContent = '0';
            }
        }

        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø§Øª Ù…Ù† Firebase ÙÙ‚Ø· - Ø³Ø±ÙŠØ¹ Ø§Ù„Ø¨Ø±Ù‚!
        async function loadCertificatesFromFirebase() {
            try {
                console.log('ğŸ”¥ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø§Øª Ù…Ù† Firebase - Ø³Ø±ÙŠØ¹ Ø¬Ø¯Ø§Ù‹!');
                
                // timeout Ø³Ø±ÙŠØ¹ Ø¬Ø¯Ø§Ù‹ - 3 Ø«ÙˆØ§Ù† ÙÙ‚Ø·!
                const timeoutPromise = new Promise((_, reject) => 
                    setTimeout(() => reject(new Error('Firebase timeout')), 3000)
                );
                
                // Ø§Ø³ØªØ¹Ù„Ø§Ù… Ø³Ø±ÙŠØ¹ Ø¨Ø¯ÙˆÙ† ØªØ±ØªÙŠØ¨ - Ø£Ø³Ø±Ø¹ Ù…Ø§ ÙŠÙ…ÙƒÙ†!
                const queryPromise = window.firebaseModules.getDocs(
                    window.firebaseModules.collection(window.db, 'certificates')
                );
                
                const querySnapshot = await Promise.race([queryPromise, timeoutPromise]);
                
                const firebaseCertificates = [];
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    // ØªØ¬Ø§Ù‡Ù„ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø­Ø°ÙˆÙØ© ÙˆØªØ£ÙƒØ¯ Ø£Ù†Ù‡Ø§ Ø´Ù‡Ø§Ø¯Ø© ØµØ­ÙŠØ© ÙˆÙ„ÙŠØ³ Ø¥Ø¬Ø§Ø²Ø© Ù…Ø±Ø¶ÙŠØ©
                    const isHealthCertificate = data.amanah || data.uniqueId || (!data.idNumber && data.serviceCode);
                    const isMedicalLeave = data.serviceCode && data.idNumber && !data.amanah && !data.uniqueId;
                    
                    if (!data.deleted && isHealthCertificate && !isMedicalLeave) {
                        firebaseCertificates.push({ id: doc.id, ...data });
                    }
                });
                
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¯Ø§Ø¦Ù…Ø§Ù‹ - Firebase Ù‡Ùˆ Ø§Ù„Ù…ØµØ¯Ø± Ø§Ù„ÙˆØ­ÙŠØ¯!
                certificates = firebaseCertificates;
                displayCertificates();
                updateStatistics();
                console.log(`ğŸš€ ØªÙ… ØªØ­Ù…ÙŠÙ„ ${certificates.length} Ø´Ù‡Ø§Ø¯Ø© Ù…Ù† Firebase Ø¨Ø³Ø±Ø¹Ø© Ø§Ù„Ø¨Ø±Ù‚!`);
                
            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø´Ù‡Ø§Ø¯Ø§Øª Ù…Ù† Firebase:', error);
                
                // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø®Ø§ØµØ© Ù„Ø®Ø·Ø£ 400
                if (error.toString().includes('400') || error.message.includes('Bad Request')) {
                    console.log('ğŸš¨ Ø®Ø·Ø£ 400 ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø§Øª - Ø¥Ø¹Ø§Ø¯Ø© ØªÙ‡ÙŠØ¦Ø© Firebase...');
                    setTimeout(() => {
                        reinitializeFirebase();
                    }, 2000);
                }
            }
        }

        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø§Øª (Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ©)
        async function loadCertificates() {
            try {
                console.log('ğŸ”„ Ø¨Ø¯Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø§Øª...');
                
                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªÙˆÙØ± Firebase
                if (!window.firebaseModules || !window.db) {
                    console.log('âš ï¸ Firebase ØºÙŠØ± Ù…ØªØ§Ø­ØŒ Ø³ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ© ÙÙ‚Ø·');
                    loadLocalCertificates();
                    return;
                }
                
                // Ø¥Ø¶Ø§ÙØ© timeout Ù„Ù„Ø§Ø³ØªØ¹Ù„Ø§Ù…
                const timeoutPromise = new Promise((_, reject) => 
                    setTimeout(() => reject(new Error('Firebase timeout')), 10000)
                );
                
                const queryPromise = window.firebaseModules.getDocs(
                    window.firebaseModules.query(
                        window.firebaseModules.collection(window.db, 'certificates'),
                        window.firebaseModules.orderBy('createdAt', 'desc')
                    )
                );
                
                const querySnapshot = await Promise.race([queryPromise, timeoutPromise]);
                
                certificates = [];
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    // ØªØ¬Ø§Ù‡Ù„ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø­Ø°ÙˆÙØ©
                    if (!data.deleted) {
                        certificates.push({ id: doc.id, ...data });
                    }
                });
                
                console.log(`âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ ${certificates.length} Ø´Ù‡Ø§Ø¯Ø© Ù…Ù† Firebase`);
                displayCertificates();
                updateStatistics(); // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª ÙÙˆØ±Ø§Ù‹
                
            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø§Øª Ù…Ù† Firebase:', error);
                console.log('ğŸ”„ Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ© ÙƒØ¨Ø¯ÙŠÙ„...');
                // ÙÙŠ Ø­Ø§Ù„Ø© Ø¹Ø¯Ù… ØªÙˆÙØ± FirebaseØŒ Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©
                loadLocalCertificates();
            }
        }


        // Ø¹Ø±Ø¶ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø§Øª
        function displayCertificates(certsToDisplay = certificates) {
            const tbody = document.getElementById('certificatesTable');
            tbody.innerHTML = '';
            
            // ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø§Øª
            document.getElementById('certificatesCount').textContent = certificates.length;
            
            if (certsToDisplay.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" class="text-center text-muted py-4">
                            <i class="fas fa-search fa-2x mb-2"></i>
                            <div>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø´Ù‡Ø§Ø¯Ø§Øª ØªØ·Ø§Ø¨Ù‚ Ø§Ù„Ø¨Ø­Ø«</div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            certsToDisplay.forEach(cert => {
                const row = document.createElement('tr');
                const issueDate = cert.issueDate ? new Date(cert.issueDate).toLocaleDateString('ar-SA') : 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
                
                // Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¹Ø±Ù Ø¢Ù…Ù† Ù„Ù„Ø´Ù‡Ø§Ø¯Ø©
                const safeUniqueId = cert.uniqueId || cert.serviceCode || cert.id || `cert_${Date.now()}`;
                console.log('ğŸ” Ù…Ø¹Ø±Ù Ø§Ù„Ø´Ù‡Ø§Ø¯Ø©:', { uniqueId: cert.uniqueId, serviceCode: cert.serviceCode, id: cert.id, safeUniqueId });
                
                row.innerHTML = `
                    <td>
                        ${cert.imageBase64 ? 
                            `<img src="${cert.imageBase64}" class="certificate-image" alt="ØµÙˆØ±Ø©">` : 
                            cert.imageUrl ? 
                            `<img src="${cert.imageUrl}" class="certificate-image" alt="ØµÙˆØ±Ø©">` : 
                            '<i class="fas fa-user-circle fa-2x text-muted"></i>'
                        }
                    </td>
                    <td>
                        <div class="fw-bold">${cert.fullName || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</div>
                        <small class="text-muted">${cert.profession || ''}</small>
                    </td>
                    <td>
                        <span class="badge bg-primary">${cert.certificateNumber || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</span>
                    </td>
                    <td>
                        <small class="text-muted">${issueDate}</small>
                    </td>
                    <td>
                        <div class="btn-group" role="group">
                            <button class="btn btn-sm btn-outline-primary" onclick="viewCertificate('${safeUniqueId}')" title="Ø¹Ø±Ø¶ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø©">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-success" onclick="copyLink('${safeUniqueId}', this)" title="Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·">
                                <i class="fas fa-link"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteCertificate('${safeUniqueId}', '${cert.id || ''}')" title="Ø­Ø°Ù Ø§Ù„Ø´Ù‡Ø§Ø¯Ø©">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø§Øª
        function searchCertificates() {
            const searchInput = document.getElementById('searchInput');
            const searchTerm = searchInput.value.toLowerCase().trim();
            const searchResults = document.getElementById('searchResults');
            const filteredCount = document.getElementById('filteredCount');
            const clearButton = document.getElementById('clearSearch');
            
            // Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ Ø²Ø± Ø§Ù„Ù…Ø³Ø­
            if (searchTerm === '') {
                clearButton.style.display = 'none';
                // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø¨Ø­Ø« ÙØ§Ø±ØºØŒ Ø§Ø¹Ø±Ø¶ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø§Øª
                filteredCertificates = certificates;
                searchResults.style.display = 'none';
                displayCertificates(certificates);
            } else {
                clearButton.style.display = 'block';
                // ÙÙ„ØªØ±Ø© Ø§Ù„Ø´Ù‡Ø§Ø¯Ø§Øª Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø¨Ø­Ø«
                filteredCertificates = certificates.filter(cert => {
                    return (
                        (cert.fullName && cert.fullName.toLowerCase().includes(searchTerm)) ||
                        (cert.certificateNumber && cert.certificateNumber.toLowerCase().includes(searchTerm)) ||
                        (cert.idNumber && cert.idNumber.toLowerCase().includes(searchTerm)) ||
                        (cert.profession && cert.profession.toLowerCase().includes(searchTerm)) ||
                        (cert.amanah && cert.amanah.toLowerCase().includes(searchTerm)) ||
                        (cert.municipality && cert.municipality.toLowerCase().includes(searchTerm)) ||
                        (cert.nationality && cert.nationality.toLowerCase().includes(searchTerm)) ||
                        (cert.certificateType && cert.certificateType.toLowerCase().includes(searchTerm))
                    );
                });
                
                // Ø¹Ø±Ø¶ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø«
                filteredCount.textContent = filteredCertificates.length;
                searchResults.style.display = 'inline';
                displayCertificates(filteredCertificates);
            }
        }

        // Ù…Ø³Ø­ Ø§Ù„Ø¨Ø­Ø«
        function clearSearch() {
            const searchInput = document.getElementById('searchInput');
            const clearButton = document.getElementById('clearSearch');
            
            searchInput.value = '';
            clearButton.style.display = 'none';
            searchCertificates();
            searchInput.focus();
        }

        // Ø¹Ø±Ø¶ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø©
        function viewCertificate(uniqueId) {
            const url = `1.html?id=${uniqueId}`;
            window.open(url, '_blank');
        }

        // Ù†Ø³Ø® Ø±Ø§Ø¨Ø· Ø§Ù„Ø´Ù‡Ø§Ø¯Ø©
        function copyLink(uniqueId, buttonElement) {
            const url = `${window.location.origin}/1.html?id=${uniqueId}`;
            navigator.clipboard.writeText(url).then(() => {
                // Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© Ù†Ø¬Ø§Ø­
                const btn = buttonElement || event.target.closest('button');
                const originalIcon = btn.innerHTML;
                const originalClass = btn.className;
                
                btn.innerHTML = '<i class="fas fa-check"></i>';
                btn.className = 'btn btn-sm btn-success';
                
                setTimeout(() => {
                    btn.innerHTML = originalIcon;
                    btn.className = originalClass;
                }, 2000);
                
                // Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© Ù†Ø¬Ø§Ø­ Ù…Ø¤Ù‚ØªØ©
                const toast = document.createElement('div');
                toast.className = 'alert alert-success toast-notification';
                toast.innerHTML = '<i class="fas fa-check me-2"></i>ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø· Ø¨Ù†Ø¬Ø§Ø­!';
                document.body.appendChild(toast);
                
                setTimeout(() => {
                    if (document.body.contains(toast)) {
                        document.body.removeChild(toast);
                    }
                }, 3000);
                
            }).catch(err => {
                console.error('ÙØ´Ù„ ÙÙŠ Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·:', err);
                alert('ÙØ´Ù„ ÙÙŠ Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.');
            });
        }

        // Ø¥Ø®ÙØ§Ø¡ Ø´Ù‡Ø§Ø¯Ø© (soft delete)
        async function deleteCertificate(uniqueId, firebaseId = '') {
            console.log('ğŸ”¥ Ù…Ø­Ø§ÙˆÙ„Ø© Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø©:', { uniqueId, firebaseId });
            
            if (!uniqueId || uniqueId === 'undefined') {
                console.error('âŒ Ù…Ø¹Ø±Ù Ø§Ù„Ø´Ù‡Ø§Ø¯Ø© ØºÙŠØ± ØµØ­ÙŠØ­:', uniqueId);
                alert('Ø®Ø·Ø£: Ù…Ø¹Ø±Ù Ø§Ù„Ø´Ù‡Ø§Ø¯Ø© ØºÙŠØ± ØµØ­ÙŠØ­');
                return;
            }
            
            if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø®ÙØ§Ø¡ Ù‡Ø°Ù‡ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø©ØŸ (ÙŠÙ…ÙƒÙ† Ø§Ø³ØªØ¹Ø§Ø¯ØªÙ‡Ø§ Ù„Ø§Ø­Ù‚Ø§Ù‹)')) {
                try {
                    let updated = false;
                    
                    // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù„Ø¯ÙŠÙ†Ø§ Ù…Ø¹Ø±Ù FirebaseØŒ Ø­Ø¯Ø« Ù…Ø¨Ø§Ø´Ø±Ø©
                    if (firebaseId && firebaseId !== '' && !firebaseId.startsWith('local_') && !firebaseId.startsWith('cert_')) {
                        try {
                            console.log('ğŸ”¥ Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø¨Ù€ Firebase ID:', firebaseId);
                            
                            // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Firebase modules
                            if (!window.firebaseModules || !window.db) {
                                throw new Error('Firebase ØºÙŠØ± Ù…ØªØ§Ø­');
                            }
                            
                            const docRef = window.firebaseModules.doc(window.db, 'certificates', firebaseId);
                            
                            // Ø¥Ø¶Ø§ÙØ© timeout Ù„Ù„Ø¹Ù…Ù„ÙŠØ©
                            const updatePromise = window.firebaseModules.updateDoc(docRef, {
                                deleted: true,
                                deletedAt: new Date().toISOString()
                            });
                            
                            const timeoutPromise = new Promise((_, reject) => 
                                setTimeout(() => reject(new Error('Firebase update timeout')), 5000)
                            );
                            
                            await Promise.race([updatePromise, timeoutPromise]);
                            updated = true;
                            console.log('âœ… ØªÙ… Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø© ÙÙŠ Firebase Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø¨Ø§Ø´Ø±');
                        } catch (error) {
                            console.error('âŒ ÙØ´Ù„ Ø§Ù„Ø­Ø°Ù Ø¨Ø§Ù„Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø¨Ø§Ø´Ø±:', error);
                            console.log('ğŸ”„ Ø³Ø£Ø­Ø§ÙˆÙ„ Ø§Ù„Ø¨Ø­Ø« Ø¨Ù€ uniqueId...');
                        }
                    }
                    
                    // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙ†Ø¬Ø­ Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø¨Ø§Ø´Ø±ØŒ Ø§Ø¨Ø­Ø« Ø¨Ù€ uniqueId
                    if (!updated) {
                        console.log('ğŸ” Ø§Ù„Ø¨Ø­Ø« Ø¨Ù€ uniqueId:', uniqueId);
                        let q = window.firebaseModules.query(
                            window.firebaseModules.collection(window.db, 'certificates'),
                            window.firebaseModules.where('uniqueId', '==', uniqueId)
                        );
                        
                        // Ø¥Ø¶Ø§ÙØ© timeout Ù„Ù„Ø¨Ø­Ø«
                        const searchPromise = window.firebaseModules.getDocs(q);
                        const searchTimeout = new Promise((_, reject) => 
                            setTimeout(() => reject(new Error('Firebase search timeout')), 5000)
                        );
                        
                        let querySnapshot = await Promise.race([searchPromise, searchTimeout]);
                        
                        // Ø¥Ø°Ø§ Ù„Ù… ÙŠØ¬Ø¯ Ø¨Ù€ uniqueIdØŒ Ø¬Ø±Ø¨ Ø§Ù„Ø¨Ø­Ø« Ø¨Ù€ serviceCode (Ù„Ù„Ø´Ù‡Ø§Ø¯Ø§Øª ÙÙ‚Ø·)
                        if (querySnapshot.empty) {
                            console.log('ğŸ” Ø§Ù„Ø¨Ø­Ø« Ø¨Ù€ serviceCode Ù„Ù„Ø´Ù‡Ø§Ø¯Ø§Øª ÙÙ‚Ø·:', uniqueId);
                            q = window.firebaseModules.query(
                                window.firebaseModules.collection(window.db, 'certificates'),
                                window.firebaseModules.where('serviceCode', '==', uniqueId),
                                window.firebaseModules.where('amanah', '!=', null) // ÙÙ‚Ø· Ø§Ù„Ø´Ù‡Ø§Ø¯Ø§Øª Ø§Ù„ØµØ­ÙŠØ©
                            );
                            
                            const searchPromise2 = window.firebaseModules.getDocs(q);
                            const searchTimeout2 = new Promise((_, reject) => 
                                setTimeout(() => reject(new Error('Firebase search timeout')), 5000)
                            );
                            
                            querySnapshot = await Promise.race([searchPromise2, searchTimeout2]);
                        }
                        
                        if (!querySnapshot.empty) {
                            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ù‡Ø°Ø§ Ø´Ù‡Ø§Ø¯Ø© ØµØ­ÙŠØ© ÙˆÙ„ÙŠØ³ Ø¥Ø¬Ø§Ø²Ø© Ù…Ø±Ø¶ÙŠØ©
                            const docData = querySnapshot.docs[0].data();
                            const isHealthCertificate = docData.amanah || docData.uniqueId || !docData.idNumber;
                            
                            if (isHealthCertificate) {
                                const docRef = querySnapshot.docs[0].ref;
                                
                                console.log('âœ… ØªØ£ÙƒÙŠØ¯: Ù‡Ø°Ø§ Ø´Ù‡Ø§Ø¯Ø© ØµØ­ÙŠØ©ØŒ ÙŠÙ…ÙƒÙ† Ø­Ø°ÙÙ‡Ø§');
                                
                                // Ø¥Ø¶Ø§ÙØ© timeout Ù„Ù„ØªØ­Ø¯ÙŠØ«
                                const updatePromise = window.firebaseModules.updateDoc(docRef, {
                                    deleted: true,
                                    deletedAt: new Date().toISOString()
                                });
                                
                                const updateTimeout = new Promise((_, reject) => 
                                    setTimeout(() => reject(new Error('Firebase update timeout')), 5000)
                                );
                                
                                await Promise.race([updatePromise, updateTimeout]);
                                updated = true;
                                console.log('âœ… ØªÙ… Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø© Ø§Ù„ØµØ­ÙŠØ© ÙÙŠ Firebase Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¨Ø­Ø«');
                            } else {
                                console.log('âš ï¸ Ù‡Ø°Ø§ Ø¥Ø¬Ø§Ø²Ø© Ù…Ø±Ø¶ÙŠØ© ÙˆÙ„ÙŠØ³ Ø´Ù‡Ø§Ø¯Ø© ØµØ­ÙŠØ© - Ù„Ù† ÙŠØªÙ… Ø­Ø°ÙÙ‡Ø§');
                            }
                        } else {
                            console.log('âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø© ÙÙŠ Firebase');
                        }
                    }
                    
                    // Firebase ÙÙ‚Ø· - Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                    if (updated) {
                        console.log('ğŸ”¥ ØªÙ… Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø© Ù…Ù† Firebase Ø¨Ù†Ø¬Ø§Ø­!');
                        alert('ØªÙ… Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø© Ø¨Ù†Ø¬Ø§Ø­! ÙŠÙ…ÙƒÙ† Ø§Ø³ØªØ¹Ø§Ø¯ØªÙ‡Ø§ Ù…Ù† Ù‚Ø³Ù… Ø§Ù„Ù…Ø­Ø°ÙˆÙØ§Øª.');
                        
                        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Firebase (Ø§Ù„Ø´Ù‡Ø§Ø¯Ø§Øª ÙˆØ§Ù„Ø¥Ø¬Ø§Ø²Ø§Øª Ù…Ù†ÙØµÙ„Ø©)
                        loadCertificatesFromFirebase();
                        loadMedicalLeavesFromFirebase(); // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø¬Ø§Ø²Ø§Øª Ø£ÙŠØ¶Ø§Ù‹ Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø¹Ø¯Ø§Ø¯Ø§Øª
                        loadDeletedItems(); // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø­Ø°ÙˆÙØ§Øª
                    } else {
                        console.log('âŒ ÙØ´Ù„ ÙÙŠ Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø©');
                        alert('ÙØ´Ù„ ÙÙŠ Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø©. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.');
                    }
                    
                } catch (error) {
                    console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø©:', error);
                    
                    // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø®Ø§ØµØ© Ù„Ø£Ø®Ø·Ø§Ø¡ Firebase
                    let errorMessage = 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø©.';
                    
                    if (error.message.includes('timeout')) {
                        errorMessage = 'Ø§Ù†ØªÙ‡Øª Ù…Ù‡Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ Firebase. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.';
                    } else if (error.message.includes('400') || error.message.includes('Bad Request') || error.toString().includes('400')) {
                        errorMessage = 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ Firebase (400). Ø¬Ø§Ø±ÙŠ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©...';
                        console.log('ğŸ”„ Ø®Ø·Ø£ 400 - Ù…Ø­Ø§ÙˆÙ„Ø© Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ Firebase...');
                        
                        // Ø¥Ø¹Ø§Ø¯Ø© ØªÙ‡ÙŠØ¦Ø© Firebase
                        reinitializeFirebase();
                        
                        // Ù…Ø­Ø§ÙˆÙ„Ø© Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø¹Ø¯ ØªØ£Ø®ÙŠØ±
                        setTimeout(() => {
                            console.log('ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...');
                            loadCertificatesFromFirebase();
                        }, 3000);
                    } else if (error.message.includes('permission')) {
                        errorMessage = 'Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ù„ØªØ¹Ø¯ÙŠÙ„ Ù‡Ø°Ù‡ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø©.';
                    }
                    
                    alert(errorMessage);
                    
                    // ÙÙŠ Ø­Ø§Ù„Ø© ÙØ´Ù„ FirebaseØŒ Ù„Ø§ Ù†ÙØ¹Ù„ Ø´ÙŠØ¡ (Firebase ÙÙ‚Ø·)
                    console.log('ğŸ”¥ Firebase ÙÙ‚Ø· - Ù„Ø§ fallback Ø¥Ù„Ù‰ localStorage');
                }
            }
        }

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
        function updateStatistics() {
            try {
                console.log('ğŸ“Š ØªØ­Ø¯ÙŠØ« Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø´Ù‡Ø§Ø¯Ø§Øª...');
                
                const total = certificates ? certificates.length : 0;
                const today = new Date().toDateString();
                const todayCount = certificates ? certificates.filter(cert => {
                    const certDate = new Date(cert.createdAt || cert.created_at);
                    return certDate.toDateString() === today;
                }).length : 0;
                
                document.getElementById('totalCertificates').textContent = total;
                document.getElementById('todayCertificates').textContent = todayCount;
                
                console.log(`âœ… Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø´Ù‡Ø§Ø¯Ø§Øª: Ø¥Ø¬Ù…Ø§Ù„ÙŠ ${total} - Ø§Ù„ÙŠÙˆÙ… ${todayCount}`);
                
                // Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¥Ø¬Ø§Ø²Ø§Øª Ø§Ù„Ù…Ø±Ø¶ÙŠØ©
                updateMedicalLeavesStatistics();
                
            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø´Ù‡Ø§Ø¯Ø§Øª:', error);
                document.getElementById('totalCertificates').textContent = '0';
                document.getElementById('todayCertificates').textContent = '0';
            }
        }

        // ØªØ­Ø¯ÙŠØ« Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¥Ø¬Ø§Ø²Ø§Øª Ø§Ù„Ù…Ø±Ø¶ÙŠØ© Ù…Ù† Firebase
        async function updateMedicalLeavesStatistics() {
            try {
                console.log('ğŸ“Š ØªØ­Ø¯ÙŠØ« Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¥Ø¬Ø§Ø²Ø§Øª Ø§Ù„Ù…Ø±Ø¶ÙŠØ©...');
                
                // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…ØªØ§Ø­Ø© ÙÙŠ Ø§Ù„Ù…ØªØºÙŠØ± Ø§Ù„Ø¹Ø§Ù…ØŒ Ø§Ø³ØªØ®Ø¯Ù…Ù‡Ø§
                if (window.medicalLeaves && window.medicalLeaves.length > 0) {
                    const total = window.medicalLeaves.length;
                    const today = new Date().toDateString();
                    const todayCount = window.medicalLeaves.filter(leave => {
                        const leaveDate = new Date(leave.created_at);
                        return leaveDate.toDateString() === today;
                    }).length;
                    
                    document.getElementById('totalMedicalLeaves').textContent = total;
                    document.getElementById('todayMedicalLeaves').textContent = todayCount;
                    
                    console.log(`âœ… Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¥Ø¬Ø§Ø²Ø§Øª Ø§Ù„Ù…Ø±Ø¶ÙŠØ©: Ø¥Ø¬Ù…Ø§Ù„ÙŠ ${total} - Ø§Ù„ÙŠÙˆÙ… ${todayCount}`);
                    return;
                }
                
                if (!window.firebaseModules || !window.db) {
                    console.log('âš ï¸ Firebase ØºÙŠØ± Ù…ØªØ§Ø­ØŒ Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ù…Ù† localStorage...');
                    updateLocalMedicalLeavesStatistics();
                    return;
                }

                const { collection, getDocs } = window.firebaseModules;
                
                // Ø¬Ù„Ø¨ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Firebase
                const querySnapshot = await getDocs(collection(window.db, 'certificates'));
                let totalMedicalLeaves = 0;
                let todayMedicalLeaves = 0;
                const today = new Date().toDateString();
                
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    // Ø§Ù„ØªØ£ÙƒØ¯ Ø£Ù† Ù‡Ø°Ø§ Ø¥Ø¬Ø§Ø²Ø© Ù…Ø±Ø¶ÙŠØ© ÙˆÙ„ÙŠØ³ Ø´Ù‡Ø§Ø¯Ø© ØµØ­ÙŠØ© ÙˆØ£Ù†Ù‡Ø§ ØºÙŠØ± Ù…Ø­Ø°ÙˆÙØ©
                    if (data.serviceCode && data.idNumber && !data.amanah && !data.deleted) {
                        totalMedicalLeaves++;
                        
                        // Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„ÙŠÙˆÙ…
                        const leaveDate = new Date(data.created_at);
                        if (leaveDate.toDateString() === today) {
                            todayMedicalLeaves++;
                        }
                    }
                });
                
                document.getElementById('totalMedicalLeaves').textContent = totalMedicalLeaves;
                document.getElementById('todayMedicalLeaves').textContent = todayMedicalLeaves;
                
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¥Ø¬Ø§Ø²Ø§Øª Ø§Ù„Ù…Ø±Ø¶ÙŠØ©:', error);
                document.getElementById('totalMedicalLeaves').textContent = '0';
                document.getElementById('todayMedicalLeaves').textContent = '0';
            }
        }

        // Ø¯Ø§Ù„Ø© Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø¥Ø¬Ø§Ø²Ø© Ø§Ù„Ù…Ø±Ø¶ÙŠØ© (soft delete)
        async function deleteMedicalLeaveFromFirebase(docId, serviceCode, idNumber) {
            console.log('ğŸ”¥ Ù…Ø­Ø§ÙˆÙ„Ø© Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø¥Ø¬Ø§Ø²Ø© Ø§Ù„Ù…Ø±Ø¶ÙŠØ©:', { docId, serviceCode, idNumber });
            if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø®ÙØ§Ø¡ Ù‡Ø°Ù‡ Ø§Ù„Ø¥Ø¬Ø§Ø²Ø© Ø§Ù„Ù…Ø±Ø¶ÙŠØ©ØŸ (ÙŠÙ…ÙƒÙ† Ø§Ø³ØªØ¹Ø§Ø¯ØªÙ‡Ø§ Ù„Ø§Ø­Ù‚Ø§Ù‹)')) {
                try {
                    console.log('ğŸ” Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªÙ†Ø¯Ø§Øª Ù„Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø¥Ø¬Ø§Ø²Ø© Ø§Ù„Ù…Ø±Ø¶ÙŠØ©...');
                    
                    // Ø¬Ù„Ø¨ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªÙ†Ø¯Ø§Øª ÙˆØ§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø¥Ø¬Ø§Ø²Ø© Ø§Ù„Ù…Ø±Ø¶ÙŠØ©
                    const querySnapshot = await window.firebaseModules.getDocs(
                        window.firebaseModules.collection(window.db, 'certificates')
                    );
                    
                    let foundDoc = null;
                    let docToDelete = null;
                    
                    querySnapshot.forEach((doc) => {
                        const data = doc.data();
                        console.log('ğŸ“„ ÙØ­Øµ Ø§Ù„Ù…Ø³ØªÙ†Ø¯:', doc.id, data);
                        
                        // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø¥Ø¬Ø§Ø²Ø© Ø§Ù„Ù…Ø±Ø¶ÙŠØ© Ø¨Ø¹Ø¯Ø© Ø·Ø±Ù‚
                        if (
                            (data.serviceCode === serviceCode && data.idNumber === idNumber) ||
                            (data.serviceCode === serviceCode && data.medicalIdNumber === idNumber) ||
                            (doc.id === docId)
                        ) {
                            // Ø§Ù„ØªØ£ÙƒØ¯ Ø£Ù†Ù‡Ø§ Ø¥Ø¬Ø§Ø²Ø© Ù…Ø±Ø¶ÙŠØ© ÙˆÙ„ÙŠØ³ Ø´Ù‡Ø§Ø¯Ø© ØµØ­ÙŠØ©
                            if (data.serviceCode && !data.amanah && !data.municipality) {
                                foundDoc = data;
                                docToDelete = doc;
                                console.log('âœ… ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø¥Ø¬Ø§Ø²Ø© Ø§Ù„Ù…Ø±Ø¶ÙŠØ©:', doc.id);
                            }
                        }
                    });
                    
                    if (docToDelete) {
                        console.log('ğŸ—‘ï¸ Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø¥Ø¬Ø§Ø²Ø© Ø§Ù„Ù…Ø±Ø¶ÙŠØ© ÙÙŠ Firebase...');
                        await window.firebaseModules.updateDoc(docToDelete.ref, {
                            deleted: true,
                            deletedAt: new Date().toISOString()
                        });
                        console.log('âœ… ØªÙ… Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø¥Ø¬Ø§Ø²Ø© Ø§Ù„Ù…Ø±Ø¶ÙŠØ© ÙÙŠ Firebase Ø¨Ù†Ø¬Ø§Ø­!');
                        
                        // ØªØ­Ø¯ÙŠØ« localStorage
                        const localKey = `medical-leave-${serviceCode}-${idNumber}`;
                        const localData = localStorage.getItem(localKey);
                        if (localData) {
                            const medicalLeave = JSON.parse(localData);
                            medicalLeave.deleted = true;
                            medicalLeave.deletedAt = new Date().toISOString();
                            localStorage.setItem(localKey, JSON.stringify(medicalLeave));
                        }
                        
                        // ØªØ­Ø¯ÙŠØ« ÙÙˆØ±ÙŠ Ù„Ù„Ù‚ÙˆØ§Ø¦Ù…
                        setTimeout(async () => {
                            await loadMedicalLeaves();
                            await updateStatistics();
                        }, 1000);
                        
                        alert('ØªÙ… Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø¥Ø¬Ø§Ø²Ø© Ø§Ù„Ù…Ø±Ø¶ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­! ÙŠÙ…ÙƒÙ† Ø§Ø³ØªØ¹Ø§Ø¯ØªÙ‡Ø§ Ù…Ù† Ù‚Ø³Ù… Ø§Ù„Ù…Ø­Ø°ÙˆÙØ§Øª.');
                        
                    } else {
                        console.log('âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø¥Ø¬Ø§Ø²Ø© Ø§Ù„Ù…Ø±Ø¶ÙŠØ© ÙÙŠ Firebase');
                        
                        // Ø¥Ø®ÙØ§Ø¡ Ù…Ù† localStorage Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„
                        const localKey = `medical-leave-${serviceCode}-${idNumber}`;
                        const localData = localStorage.getItem(localKey);
                        if (localData) {
                            const medicalLeave = JSON.parse(localData);
                            medicalLeave.deleted = true;
                            medicalLeave.deletedAt = new Date().toISOString();
                            localStorage.setItem(localKey, JSON.stringify(medicalLeave));
                        }
                        
                        loadMedicalLeaves();
                        updateStatistics();
                        
                        alert('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø¥Ø¬Ø§Ø²Ø© Ø§Ù„Ù…Ø±Ø¶ÙŠØ© ÙÙŠ FirebaseØŒ ØªÙ… Ø§Ù„Ø¥Ø®ÙØ§Ø¡ Ù…Ø­Ù„ÙŠØ§Ù‹');
                    }
                    
                } catch (error) {
                    console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ø¥Ø¬Ø§Ø²Ø© Ø§Ù„Ù…Ø±Ø¶ÙŠØ©:', error);
                    alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ø¥Ø¬Ø§Ø²Ø© Ø§Ù„Ù…Ø±Ø¶ÙŠØ©: ' + error.message);
                }
            }
        }

        // Ø¥Ø¶Ø§ÙØ© Ø¥Ø¬Ø§Ø²Ø© Ù…Ø±Ø¶ÙŠØ© Ø¬Ø¯ÙŠØ¯Ø©
        document.getElementById('medicalLeaveForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const serviceCode = document.getElementById('serviceCode').value.trim();
            const idNumber = document.getElementById('medicalIdNumber').value.trim();
            const name = document.getElementById('patientName').value.trim();
            const reportIssueDate = document.getElementById('reportIssueDate').value;
            const leaveStart = document.getElementById('leaveStart').value;
            const leaveEnd = document.getElementById('leaveEnd').value;
            const leaveDuration = document.getElementById('leaveDuration').value;
            const doctorName = document.getElementById('doctorName').value.trim();
            const jobTitle = document.getElementById('jobTitle').value.trim();
            
            if (!serviceCode || !idNumber || !name || !reportIssueDate || !leaveStart || !leaveEnd || !leaveDuration || !doctorName || !jobTitle) {
                alert('ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©');
                return;
            }
            
            const medicalLeaveData = {
                name: name,
                report_issue_date: reportIssueDate,
                leave_start: leaveStart,
                leave_end: leaveEnd,
                time: leaveDuration,
                doctor_name: doctorName,
                role: jobTitle,
                created_at: new Date().toISOString()
            };
            
            try {
                // Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ø±Ù ÙØ±ÙŠØ¯ Ù„Ù„Ø¥Ø¬Ø§Ø²Ø© Ø§Ù„Ù…Ø±Ø¶ÙŠØ©
                medicalLeaveData.id = `${serviceCode}_${idNumber}`;
                medicalLeaveData.serviceCode = serviceCode;
                medicalLeaveData.idNumber = idNumber;
                
                // Ø§Ù„Ø­ÙØ¸ ÙÙŠ Firebase Ø£ÙˆÙ„Ø§Ù‹ (Ù…Ø«Ù„ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø§Øª ØªÙ…Ø§Ù…Ø§Ù‹)
                try {
                    const { collection, addDoc } = window.firebaseModules;
                    const docRef = await addDoc(collection(window.db, 'certificates'), medicalLeaveData);
                    console.log('âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¥Ø¬Ø§Ø²Ø© Ø§Ù„Ù…Ø±Ø¶ÙŠØ© ÙÙŠ Firebase Ø¨Ù†Ø¬Ø§Ø­:', docRef.id);
                    
                    // Ø­ÙØ¸ Ù…Ø­Ù„ÙŠ Ù„Ù„Ø³Ø±Ø¹Ø© ÙÙ‚Ø·
                    const localKey = `medical-leave-${serviceCode}-${idNumber}`;
                    localStorage.setItem(localKey, JSON.stringify(medicalLeaveData));
                    
                } catch (error) {
                    console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Firebase:', error);
                    throw error; // Ø±Ù…ÙŠ Ø§Ù„Ø®Ø·Ø£ Ù„Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø¹Ù…Ù„ÙŠØ©
                }
                
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… ÙˆØ§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
                loadMedicalLeaves();
                updateStatistics();
                
                // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
                document.getElementById('medicalLeaveForm').reset();
                
                alert('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¥Ø¬Ø§Ø²Ø© Ø§Ù„Ù…Ø±Ø¶ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­!');
                
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¥Ø¬Ø§Ø²Ø© Ø§Ù„Ù…Ø±Ø¶ÙŠØ©:', error);
                alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¥Ø¬Ø§Ø²Ø© Ø§Ù„Ù…Ø±Ø¶ÙŠØ©');
            }
        });

        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø¬Ø§Ø²Ø§Øª Ø§Ù„Ù…Ø±Ø¶ÙŠØ© Ù…Ù† Firebase ÙÙ‚Ø· - Ø³Ø±ÙŠØ¹ Ø§Ù„Ø¨Ø±Ù‚!
        async function loadMedicalLeavesFromFirebase() {
            try {
                console.log('ğŸ”¥ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø¬Ø§Ø²Ø§Øª Ø§Ù„Ù…Ø±Ø¶ÙŠØ© Ù…Ù† Firebase - Ø³Ø±ÙŠØ¹ Ø¬Ø¯Ø§Ù‹!');
                
                const { collection, getDocs, orderBy, query } = window.firebaseModules;
                
                // timeout Ø³Ø±ÙŠØ¹ Ø¬Ø¯Ø§Ù‹ - 3 Ø«ÙˆØ§Ù† ÙÙ‚Ø·!
                const timeoutPromise = new Promise((_, reject) => 
                    setTimeout(() => reject(new Error('Firebase timeout')), 3000)
                );
                
                // Ø§Ø³ØªØ¹Ù„Ø§Ù… Ø³Ø±ÙŠØ¹ Ø¨Ø¯ÙˆÙ† ØªØ±ØªÙŠØ¨ - Ø£Ø³Ø±Ø¹ Ù…Ø§ ÙŠÙ…ÙƒÙ†!
                const queryPromise = getDocs(collection(window.db, 'certificates'));
                const querySnapshot = await Promise.race([queryPromise, timeoutPromise]);
                const firebaseMedicalLeaves = [];
                
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    // Ø§Ù„ØªØ£ÙƒØ¯ Ø£Ù† Ù‡Ø°Ø§ Ø¥Ø¬Ø§Ø²Ø© Ù…Ø±Ø¶ÙŠØ© ÙˆÙ„ÙŠØ³ Ø´Ù‡Ø§Ø¯Ø© ØµØ­ÙŠØ© ÙˆØ£Ù†Ù‡Ø§ ØºÙŠØ± Ù…Ø­Ø°ÙˆÙØ©
                    const isHealthCertificate = data.amanah || data.uniqueId || (!data.idNumber && data.serviceCode);
                    const isMedicalLeave = data.serviceCode && data.idNumber && !data.amanah && !data.uniqueId;
                    
                    if (!data.deleted && isMedicalLeave && !isHealthCertificate) {
                        firebaseMedicalLeaves.push({
                            id: doc.id,
                            ...data
                        });
                    }
                });

                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¯Ø§Ø¦Ù…Ø§Ù‹ - Firebase Ù‡Ùˆ Ø§Ù„Ù…ØµØ¯Ø± Ø§Ù„ÙˆØ­ÙŠØ¯!
                window.medicalLeaves = firebaseMedicalLeaves;
                displayMedicalLeaves();
                updateMedicalLeavesStatistics();
                console.log(`ğŸš€ ØªÙ… ØªØ­Ù…ÙŠÙ„ ${firebaseMedicalLeaves.length} Ø¥Ø¬Ø§Ø²Ø© Ù…Ø±Ø¶ÙŠØ© Ù…Ù† Firebase Ø¨Ø³Ø±Ø¹Ø© Ø§Ù„Ø¨Ø±Ù‚!`);
                
            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø¬Ø§Ø²Ø§Øª Ø§Ù„Ù…Ø±Ø¶ÙŠØ© Ù…Ù† Firebase:', error);
                
                // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø®Ø§ØµØ© Ù„Ø®Ø·Ø£ 400
                if (error.toString().includes('400') || error.message.includes('Bad Request')) {
                    console.log('ğŸš¨ Ø®Ø·Ø£ 400 ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø¬Ø§Ø²Ø§Øª Ø§Ù„Ù…Ø±Ø¶ÙŠØ© - Ø¥Ø¹Ø§Ø¯Ø© ØªÙ‡ÙŠØ¦Ø© Firebase...');
                    setTimeout(() => {
                        reinitializeFirebase();
                    }, 2000);
                }
            }
        }

        // Ø¯Ø§Ù„Ø© ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¥Ø¬Ø§Ø²Ø§Øª Ø§Ù„Ù…Ø±Ø¶ÙŠØ© Ù…Ù† Firebase (Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ©)
        async function loadMedicalLeaves() {
            const medicalLeavesList = document.getElementById('medicalLeavesList');
            
            try {
                console.log('ğŸ”„ Ø¨Ø¯Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø¬Ø§Ø²Ø§Øª Ø§Ù„Ù…Ø±Ø¶ÙŠØ©...');
                
                if (!window.firebaseModules || !window.db) {
                    console.log('âš ï¸ Firebase ØºÙŠØ± Ù…ØªØ§Ø­ØŒ Ø³ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ© ÙÙ‚Ø·');
                    loadLocalMedicalLeaves();
                    return;
                }

                const { collection, getDocs, orderBy, query } = window.firebaseModules;
                
                // Ø¥Ø¶Ø§ÙØ© timeout Ù„Ù„Ø§Ø³ØªØ¹Ù„Ø§Ù…
                const timeoutPromise = new Promise((_, reject) => 
                    setTimeout(() => reject(new Error('Firebase timeout')), 10000)
                );
                
                // Ø¬Ù„Ø¨ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Firebase (Ø¨Ø¯ÙˆÙ† ÙÙ„ØªØ±Ø© Ù…Ø¹Ù‚Ø¯Ø©)
                const q = query(
                    collection(window.db, 'certificates'),
                    orderBy('created_at', 'desc')
                );
                
                const queryPromise = getDocs(q);
                const querySnapshot = await Promise.race([queryPromise, timeoutPromise]);
                const medicalLeaves = [];
                
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    // Ø§Ù„ØªØ£ÙƒØ¯ Ø£Ù† Ù‡Ø°Ø§ Ø¥Ø¬Ø§Ø²Ø© Ù…Ø±Ø¶ÙŠØ© ÙˆÙ„ÙŠØ³ Ø´Ù‡Ø§Ø¯Ø© ØµØ­ÙŠØ© ÙˆØ£Ù†Ù‡Ø§ ØºÙŠØ± Ù…Ø­Ø°ÙˆÙØ©
                    if (data.serviceCode && data.idNumber && !data.amanah && !data.deleted) {
                        medicalLeaves.push({
                            id: doc.id,
                            ...data
                        });
                    }
                });

                console.log(`âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ ${medicalLeaves.length} Ø¥Ø¬Ø§Ø²Ø© Ù…Ø±Ø¶ÙŠØ© Ù…Ù† Firebase`);
                
                // Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ø§Ù„Ù…ØªØºÙŠØ± Ø§Ù„Ø¹Ø§Ù…
                window.medicalLeaves = medicalLeaves;
                displayMedicalLeaves();
                updateMedicalLeavesStatistics(); // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª ÙÙˆØ±Ø§Ù‹
                
            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø¬Ø§Ø²Ø§Øª Ø§Ù„Ù…Ø±Ø¶ÙŠØ© Ù…Ù† Firebase:', error);
                console.log('ğŸ”„ Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ© ÙƒØ¨Ø¯ÙŠÙ„...');
                // ÙÙŠ Ø­Ø§Ù„Ø© Ø¹Ø¯Ù… ØªÙˆÙØ± FirebaseØŒ Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©
                loadLocalMedicalLeaves();
            }
        }
        
        // Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø¬Ø§Ø²Ø§Øª Ø§Ù„Ù…Ø±Ø¶ÙŠØ©
        function displayMedicalLeaves() {
            const medicalLeavesList = document.getElementById('medicalLeavesList');
            const medicalLeavesToDisplay = window.medicalLeaves || [];
            
            if (medicalLeavesToDisplay.length === 0) {
                medicalLeavesList.innerHTML = `
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-calendar-alt fa-3x mb-3"></i>
                        <p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø¬Ø§Ø²Ø§Øª Ù…Ø±Ø¶ÙŠØ© Ù…Ø­ÙÙˆØ¸Ø©</p>
                    </div>
                `;
                return;
            }

            let html = '<div class="table-responsive"><table class="table table-striped"><thead><tr><th>Ø±Ù…Ø² Ø§Ù„Ø®Ø¯Ù…Ø©</th><th>Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ©</th><th>Ø§Ù„Ø§Ø³Ù…</th><th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø­ÙØ¸</th><th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th></tr></thead><tbody>';
            
            medicalLeavesToDisplay.forEach(leave => {
                const date = new Date(leave.created_at).toLocaleDateString('ar-SA');
                
                html += `
                    <tr>
                        <td>${leave.serviceCode}</td>
                        <td>${leave.idNumber}</td>
                        <td>${leave.name || leave.fullName || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</td>
                        <td>${date}</td>
                        <td>
                            <button class="btn btn-danger btn-sm" onclick="deleteMedicalLeaveFromFirebase('${leave.id}', '${leave.serviceCode}', '${leave.idNumber}')" title="Ø­Ø°Ù Ø§Ù„Ø¥Ø¬Ø§Ø²Ø© Ø§Ù„Ù…Ø±Ø¶ÙŠØ©">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            html += '</tbody></table></div>';
            medicalLeavesList.innerHTML = html;
        }

        // Ø¯Ø§Ù„Ø© Ø­Ø°Ù Ø§Ù„Ø¥Ø¬Ø§Ø²Ø© Ø§Ù„Ù…Ø±Ø¶ÙŠØ©
        function deleteMedicalLeave(serviceCode, idNumber) {
            if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø¥Ø¬Ø§Ø²Ø© Ø§Ù„Ù…Ø±Ø¶ÙŠØ©ØŸ')) {
                // Ø­Ø°Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                const localKey = `medical-leave-${serviceCode}-${idNumber}`;
                localStorage.removeItem(localKey);
                
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙÙ‡Ø±Ø³
                const medicalLeavesIndex = JSON.parse(localStorage.getItem('medical-leaves-index') || '[]');
                const updatedIndex = medicalLeavesIndex.filter(item => 
                    !(item.serviceCode === serviceCode && item.idNumber === idNumber)
                );
                localStorage.setItem('medical-leaves-index', JSON.stringify(updatedIndex));
                
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
                loadMedicalLeaves();
                
                alert('ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¥Ø¬Ø§Ø²Ø© Ø§Ù„Ù…Ø±Ø¶ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­!');
            }
        }

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø¯Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„ØªÙˆØ§Ø±ÙŠØ®
        document.getElementById('leaveStart').addEventListener('change', calculateLeaveDuration);
        document.getElementById('leaveEnd').addEventListener('change', calculateLeaveDuration);

        function calculateLeaveDuration() {
            const startDate = document.getElementById('leaveStart').value;
            const endDate = document.getElementById('leaveEnd').value;
            
            if (startDate && endDate) {
                const start = new Date(startDate);
                const end = new Date(endDate);
                
                // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„ØªÙˆØ§Ø±ÙŠØ® ØµØ­ÙŠØ­Ø©
                if (isNaN(start.getTime()) || isNaN(end.getTime())) {
                    document.getElementById('leaveDuration').value = '';
                    return;
                }
                
                const timeDiff = end.getTime() - start.getTime();
                const daysDiff = Math.floor(timeDiff / (1000 * 3600 * 24)) + 1; // +1 Ù„ØªØ¶Ù…ÙŠÙ† Ø§Ù„ÙŠÙˆÙ… Ø§Ù„Ø£ÙˆÙ„
                
                if (daysDiff >= 1) {
                    document.getElementById('leaveDuration').value = daysDiff;
                } else {
                    document.getElementById('leaveDuration').value = '';
                }
            }
        }

        // Ø¯Ø§Ù„Ø© Ø­Ø³Ø§Ø¨ ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ (+1 Ø³Ù†Ø©)
        function calculateExpiryDate() {
            const issueDateInput = document.getElementById('issueDate');
            const expiryDateInput = document.getElementById('expiryDate');
            
            if (issueDateInput.value) {
                try {
                    // ØªØ­ÙˆÙŠÙ„ Ø§Ù„ØªØ§Ø±ÙŠØ® Ù…Ù† ØµÙŠØºØ© YYYY/MM/DD Ø£Ùˆ YYYY-MM-DD
                    let dateStr = issueDateInput.value.replace(/\//g, '-');
                    let issueDate = new Date(dateStr);
                    
                    // Ø¥Ø¶Ø§ÙØ© Ø³Ù†Ø© ÙˆØ§Ø­Ø¯Ø©
                    let expiryDate = new Date(issueDate);
                    expiryDate.setFullYear(expiryDate.getFullYear() + 1);
                    
                    // ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ØªØ§Ø±ÙŠØ® Ø¨ØµÙŠØºØ© YYYY/MM/DD
                    let year = expiryDate.getFullYear();
                    let month = String(expiryDate.getMonth() + 1).padStart(2, '0');
                    let day = String(expiryDate.getDate()).padStart(2, '0');
                    
                    expiryDateInput.value = `${year}/${month}/${day}`;
                } catch (error) {
                    console.log('Ø®Ø·Ø£ ÙÙŠ Ø­Ø³Ø§Ø¨ ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡:', error);
                }
            }
        }

        // Ù…ØªØºÙŠØ± Ù„ØªØªØ¨Ø¹ Ù…Ø­Ø§ÙˆÙ„Ø§Øª Ø§Ù„ØªØ­Ù…ÙŠÙ„
        let initializationAttempts = 0;
        const MAX_ATTEMPTS = 3; // Ø£Ù‚ØµÙ‰ 3 Ù…Ø­Ø§ÙˆÙ„Ø§Øª (3 Ø«ÙˆØ§Ù†) - Ø£Ø³Ø±Ø¹
        let dataLoaded = false; // Ù„ØªØ¬Ù†Ø¨ Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ØªÙƒØ±Ø±
        
        // Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„
        function showLoadingMessage() {
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¨Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„
            document.getElementById('totalCertificates').textContent = '...';
            document.getElementById('todayCertificates').textContent = '...';
            document.getElementById('totalMedicalLeaves').textContent = '...';
            document.getElementById('todayMedicalLeaves').textContent = '...';
        }
        
        // Ø¥Ø®ÙØ§Ø¡ Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„
        function hideLoadingMessage() {
            // Ø³ÙŠØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¨Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„ÙØ¹Ù„ÙŠØ© ÙÙŠ Ø¯ÙˆØ§Ù„ Ø§Ù„ØªØ­Ø¯ÙŠØ«
        }
        
        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø§Øª ÙˆØ§Ù„Ø¥Ø¬Ø§Ø²Ø§Øª Ø§Ù„Ù…Ø±Ø¶ÙŠØ© Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© - Firebase ÙÙ‚Ø·!
        function initializeData() {
            if (dataLoaded) {
                console.log('âœ… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ù…Ù„Ø© Ø¨Ø§Ù„ÙØ¹Ù„');
                return;
            }
            
            console.log(`ğŸ”¥ Firebase ONLY - Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø±Ù‚Ù… ${initializationAttempts + 1}`);
            
            // ØªØ¹ÙŠÙŠÙ† Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„ØªØ§Ø±ÙŠØ® (ÙŠØ¹Ù…Ù„ Ø¯Ø§Ø¦Ù…Ø§Ù‹)
            setDefaultDates();
            
            // Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹Ø§Øª Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø¯Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ (ÙŠØ¹Ù…Ù„ Ø¯Ø§Ø¦Ù…Ø§Ù‹)
            setupDateCalculation();
            
            // Firebase ÙÙ‚Ø· - Ø¨Ø³Ø±Ø¹Ø© Ø§Ù„Ø¨Ø±Ù‚! ØªØ­Ù…ÙŠÙ„ Ù…ØªÙˆØ§Ø²ÙŠ
            if (window.firebaseModules && window.db) {
                console.log('ğŸš€ Firebase Ù…ØªØ§Ø­ - ØªØ­Ù…ÙŠÙ„ Ù…ØªÙˆØ§Ø²ÙŠ Ø³Ø±ÙŠØ¹ Ø¬Ø¯Ø§Ù‹!');
                
                // ØªØ­Ù…ÙŠÙ„ Ù…ØªÙˆØ§Ø²ÙŠ - ÙƒÙ„ Ø´ÙŠØ¡ ÙÙŠ Ù†ÙØ³ Ø§Ù„ÙˆÙ‚Øª!
                Promise.all([
                    loadCertificatesFromFirebase(),
                    loadMedicalLeavesFromFirebase(),
                    loadDeletedItems()
                ]).then(() => {
                    console.log('ğŸ”¥ ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Firebase Ø¨Ø³Ø±Ø¹Ø© Ø§Ù„Ø¨Ø±Ù‚!');
                }).catch(error => {
                    console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ØªÙˆØ§Ø²ÙŠ:', error);
                });
                
                dataLoaded = true;
            } else {
                initializationAttempts++;
                
                if (initializationAttempts < MAX_ATTEMPTS) {
                    console.log(`â³ Ø§Ù†ØªØ¸Ø§Ø± Firebase... (${initializationAttempts}/${MAX_ATTEMPTS})`);
                    setTimeout(initializeData, 200); // Ù…Ø­Ø§ÙˆÙ„Ø© ÙƒÙ„ 0.2 Ø«Ø§Ù†ÙŠØ© - Ø³Ø±ÙŠØ¹ Ø¬Ø¯Ø§Ù‹!
                } else {
                    console.log('âŒ Firebase ØºÙŠØ± Ù…ØªØ§Ø­ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹');
                    // Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ø®Ø·Ø£
                    document.getElementById('totalCertificates').textContent = 'Ø®Ø·Ø£';
                    document.getElementById('todayCertificates').textContent = 'Ø®Ø·Ø£';
                    document.getElementById('totalMedicalLeaves').textContent = 'Ø®Ø·Ø£';
                    document.getElementById('todayMedicalLeaves').textContent = 'Ø®Ø·Ø£';
                }
            }
        }
        
        // ØªØ¹ÙŠÙŠÙ† Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ
        function setDefaultDates() {
            const today = new Date().toISOString().split('T')[0]; // ØªÙ†Ø³ÙŠÙ‚ YYYY-MM-DD
            
            // ØªØ¹ÙŠÙŠÙ† ØªØ§Ø±ÙŠØ® Ø§Ù„ÙŠÙˆÙ… ÙƒØ§ÙØªØ±Ø§Ø¶ÙŠ Ù„ØªØ§Ø±ÙŠØ® Ø¥ØµØ¯Ø§Ø± Ø§Ù„ØªÙ‚Ø±ÙŠØ±
            const reportIssueDateField = document.getElementById('reportIssueDate');
            if (reportIssueDateField && !reportIssueDateField.value) {
                reportIssueDateField.value = today;
            }
        }
        
        // Ø¥Ø¹Ø¯Ø§Ø¯ Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø¯Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
        function setupDateCalculation() {
            const leaveStartField = document.getElementById('leaveStart');
            const leaveEndField = document.getElementById('leaveEnd');
            const leaveDurationField = document.getElementById('leaveDuration');
            
            function calculateDuration() {
                const startDate = leaveStartField.value;
                const endDate = leaveEndField.value;
                
                if (startDate && endDate) {
                    const start = new Date(startDate);
                    const end = new Date(endDate);
                    
                    if (end >= start) {
                        const diffTime = Math.abs(end - start);
                        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1; // +1 Ù„ØªØ¶Ù…ÙŠÙ† ÙŠÙˆÙ… Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©
                        leaveDurationField.value = diffDays;
                    } else {
                        leaveDurationField.value = '';
                        alert('ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ© ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø¨Ø¹Ø¯ ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©');
                    }
                }
            }
            
            if (leaveStartField && leaveEndField && leaveDurationField) {
                leaveStartField.addEventListener('change', calculateDuration);
                leaveEndField.addEventListener('change', calculateDuration);
            }
        }
        
        // ØªØ­Ù…ÙŠÙ„ ÙÙˆØ±ÙŠ Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸ“„ Ø§Ù„ØµÙØ­Ø© Ø¬Ø§Ù‡Ø²Ø©ØŒ Ø¨Ø¯Ø¡ Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙÙˆØ±ÙŠ...');
            initializeData();
        });
        
        // ØªØ­Ù…ÙŠÙ„ Ø§Ø­ØªÙŠØ§Ø·ÙŠ Ø¥Ø°Ø§ Ù„Ù… ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ DOMContentLoaded
        if (document.readyState === 'loading') {
            // Ø§Ù„ØµÙØ­Ø© Ù„Ø§ ØªØ²Ø§Ù„ ØªØ­Ù…Ù„
            document.addEventListener('DOMContentLoaded', initializeData);
        } else {
            // Ø§Ù„ØµÙØ­Ø© Ù…Ø­Ù…Ù„Ø© Ø¨Ø§Ù„ÙØ¹Ù„
            console.log('ğŸ“„ Ø§Ù„ØµÙØ­Ø© Ù…Ø­Ù…Ù„Ø© Ø¨Ø§Ù„ÙØ¹Ù„ØŒ Ø¨Ø¯Ø¡ Ø§Ù„ØªØ­Ù…ÙŠÙ„...');
            initializeData();
        }
        
        // Firebase ÙÙ‚Ø· - Ù„Ø§ Ø­Ø§Ø¬Ø© Ù„Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¯ÙˆØ±ÙŠ!
        console.log('ğŸ”¥ Firebase ONLY - Ù„Ø§ ØªØ­Ø¯ÙŠØ« Ø¯ÙˆØ±ÙŠØŒ Firebase Ù‡Ùˆ Ø§Ù„Ù…ØµØ¯Ø± Ø§Ù„ÙˆØ­ÙŠØ¯!');
        
        // Ø¯Ø§Ù„Ø© Ù„Ø¥Ø¹Ø§Ø¯Ø© ØªÙ‡ÙŠØ¦Ø© Firebase ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„Ø£Ø®Ø·Ø§Ø¡
        function reinitializeFirebase() {
            console.log('ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© ØªÙ‡ÙŠØ¦Ø© Firebase...');
            
            // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ù…ØªØºÙŠØ± Ø§Ù„ØªØ­Ù…ÙŠÙ„
            dataLoaded = false;
            initializationAttempts = 0;
            
            // Ù…Ø­Ø§ÙˆÙ„Ø© Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„
            setTimeout(() => {
                initializeData();
            }, 1000);
        }
        
        // Ù…Ø±Ø§Ù‚Ø¨Ø© Ø£Ø®Ø·Ø§Ø¡ Firebase
        window.addEventListener('error', function(event) {
            if (event.message && event.message.includes('firestore')) {
                console.log('ğŸš¨ ØªÙ… Ø§ÙƒØªØ´Ø§Ù Ø®Ø·Ø£ FirebaseØŒ Ù…Ø­Ø§ÙˆÙ„Ø© Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªÙ‡ÙŠØ¦Ø©...');
                reinitializeFirebase();
            }
        });

        // ØªÙ†Ø¸ÙŠÙ localStorage Ù…Ù† Ø§Ù„Ø´Ù‡Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø­Ø°ÙˆÙØ©
        async function cleanupLocalStorage() {
            try {
                const localData = localStorage.getItem('certificates');
                if (!localData) return;

                const localCertificates = JSON.parse(localData);
                const validCertificates = [];

                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙƒÙ„ Ø´Ù‡Ø§Ø¯Ø© ÙÙŠ localStorage
                for (const cert of localCertificates) {
                    try {
                        const q = window.firebaseModules.query(
                            window.firebaseModules.collection(window.db, 'certificates'),
                            window.firebaseModules.where('uniqueId', '==', cert.uniqueId)
                        );
                        
                        const querySnapshot = await window.firebaseModules.getDocs(q);
                        
                        // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø´Ù‡Ø§Ø¯Ø© Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ FirebaseØŒ Ø§Ø­ØªÙØ¸ Ø¨Ù‡Ø§
                        if (!querySnapshot.empty) {
                            validCertificates.push(cert);
                        }
                    } catch (error) {
                        // ÙÙŠ Ø­Ø§Ù„Ø© Ø®Ø·Ø£ØŒ Ø§Ø­ØªÙØ¸ Ø¨Ø§Ù„Ø´Ù‡Ø§Ø¯Ø©
                        validCertificates.push(cert);
                    }
                }

                // ØªØ­Ø¯ÙŠØ« localStorage Ø¨Ø§Ù„Ø´Ù‡Ø§Ø¯Ø§Øª Ø§Ù„ØµØ§Ù„Ø­Ø© ÙÙ‚Ø·
                localStorage.setItem('certificates', JSON.stringify(validCertificates));
                
                console.log(`ØªÙ… ØªÙ†Ø¸ÙŠÙ localStorage: ${localCertificates.length - validCertificates.length} Ø´Ù‡Ø§Ø¯Ø© Ù…Ø­Ø°ÙˆÙØ©`);
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ ØªÙ†Ø¸ÙŠÙ localStorage:', error);
            }
        }

        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù…Ø­Ø°ÙˆÙØ©
        async function loadDeletedItems() {
            console.log('ğŸ”„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù…Ø­Ø°ÙˆÙØ©...');
            const deletedItems = [];
            
            try {
                // ØªØ­Ù…ÙŠÙ„ Ù…Ù† Firebase
                if (window.firebaseModules && window.db) {
                    console.log('ğŸ“¡ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Firebase...');
                    const querySnapshot = await window.firebaseModules.getDocs(
                        window.firebaseModules.collection(window.db, 'certificates')
                    );
                    
                    querySnapshot.forEach((doc) => {
                        const data = doc.data();
                        // Ø¬Ù„Ø¨ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù…Ø­Ø°ÙˆÙØ© ÙÙ‚Ø·
                        if (data.deleted) {
                            deletedItems.push({ id: doc.id, ...data });
                            console.log('ğŸ—‘ï¸ Ø¹Ù†ØµØ± Ù…Ø­Ø°ÙˆÙ:', data.name || data.fullName);
                        }
                    });
                } else {
                    console.log('âš ï¸ Firebase ØºÙŠØ± Ù…ØªØ§Ø­ØŒ Ø¬Ù„Ø¨ Ù…Ù† localStorage...');
                }

                // ØªØ­Ù…ÙŠÙ„ Ù…Ù† localStorage ÙƒØ¨Ø¯ÙŠÙ„
                const localData = localStorage.getItem('certificates');
                if (localData) {
                    const localCertificates = JSON.parse(localData);
                    localCertificates.forEach(cert => {
                        if (cert.deleted) {
                            // ØªØ¬Ù†Ø¨ Ø§Ù„ØªÙƒØ±Ø§Ø±
                            const exists = deletedItems.find(item => 
                                (item.uniqueId && item.uniqueId === cert.uniqueId) ||
                                (item.serviceCode && item.serviceCode === cert.serviceCode)
                            );
                            if (!exists) {
                                deletedItems.push(cert);
                                console.log('ğŸ—‘ï¸ Ø¹Ù†ØµØ± Ù…Ø­Ø°ÙˆÙ Ù…Ø­Ù„ÙŠ:', cert.name || cert.fullName);
                            }
                        }
                    });
                }

                // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø¬Ø§Ø²Ø§Øª Ø§Ù„Ù…Ø±Ø¶ÙŠØ© Ø§Ù„Ù…Ø­Ø°ÙˆÙØ© Ù…Ù† localStorage Ø§Ù„Ù…Ù†ÙØµÙ„
                const allKeys = Object.keys(localStorage);
                const medicalLeaveKeys = allKeys.filter(key => key.startsWith('medical-leave-'));
                
                medicalLeaveKeys.forEach(key => {
                    const medicalLeaveData = localStorage.getItem(key);
                    if (medicalLeaveData) {
                        const medicalLeave = JSON.parse(medicalLeaveData);
                        if (medicalLeave.deleted) {
                            // ØªØ¬Ù†Ø¨ Ø§Ù„ØªÙƒØ±Ø§Ø±
                            const exists = deletedItems.find(item => 
                                item.serviceCode === medicalLeave.serviceCode
                            );
                            if (!exists) {
                                deletedItems.push(medicalLeave);
                                console.log('ğŸ—‘ï¸ Ø¥Ø¬Ø§Ø²Ø© Ù…Ø±Ø¶ÙŠØ© Ù…Ø­Ø°ÙˆÙØ© Ù…Ø­Ù„ÙŠØ©:', medicalLeave.fullName);
                            }
                        }
                    }
                });

                console.log(`ğŸ“Š Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù…Ø­Ø°ÙˆÙØ©: ${deletedItems.length}`);
                displayDeletedItems(deletedItems);
                
            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù…Ø­Ø°ÙˆÙØ©:', error);
                displayDeletedItems([]);
            }
        }

        // Ø¹Ø±Ø¶ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù…Ø­Ø°ÙˆÙØ©
        function displayDeletedItems(items) {
            console.log('ğŸ“‹ Ø¹Ø±Ø¶ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù…Ø­Ø°ÙˆÙØ©:', items);
            const tbody = document.getElementById('deletedItemsTable');
            
            if (!tbody) {
                console.error('âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø­Ø°ÙˆÙØ§Øª');
                return;
            }
            
            tbody.innerHTML = '';
            
            if (items.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center text-muted py-4">
                            <i class="fas fa-inbox fa-3x mb-3"></i>
                            <br>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù†Ø§ØµØ± Ù…Ø­Ø°ÙˆÙØ©
                        </td>
                    </tr>
                `;
                console.log('ğŸ“­ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù†Ø§ØµØ± Ù…Ø­Ø°ÙˆÙØ© Ù„Ù„Ø¹Ø±Ø¶');
                return;
            }

            console.log(`ğŸ“Š Ø¹Ø±Ø¶ ${items.length} Ø¹Ù†ØµØ± Ù…Ø­Ø°ÙˆÙ`);
            items.forEach((item, index) => {
                // ØªØ­Ø¯ÙŠØ¯ Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù†ØµØ± Ø¨Ø¯Ù‚Ø© Ø£ÙƒØ¨Ø±
                const isHealthCertificate = item.amanah || item.uniqueId || (!item.idNumber && item.serviceCode);
                const isMedicalLeave = item.serviceCode && item.idNumber && !item.amanah && !item.uniqueId;
                
                const itemType = isMedicalLeave ? 'Ø¥Ø¬Ø§Ø²Ø© Ù…Ø±Ø¶ÙŠØ©' : 'Ø´Ù‡Ø§Ø¯Ø© ØµØ­ÙŠØ©';
                const itemName = item.name || item.fullName || '-';
                const itemId = isMedicalLeave ? item.idNumber : (item.medicalIdNumber || item.idNumber || '-');
                const deletedDate = item.deletedAt ? new Date(item.deletedAt).toLocaleDateString('ar-SA') : '-';
                const uniqueIdentifier = item.uniqueId || item.serviceCode;
                
                console.log(`ğŸ“„ Ø¹Ù†ØµØ± ${index + 1}: ${itemName} (${itemType}) - Ù…Ø¹Ø±Ù: ${uniqueIdentifier}`, {
                    isHealthCertificate,
                    isMedicalLeave,
                    hasAmanah: !!item.amanah,
                    hasUniqueId: !!item.uniqueId,
                    hasIdNumber: !!item.idNumber,
                    hasServiceCode: !!item.serviceCode
                });
                
                const row = `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${itemName}</td>
                        <td>${itemId}</td>
                        <td>
                            <span class="badge ${isMedicalLeave ? 'bg-warning' : 'bg-info'}">
                                ${itemType}
                            </span>
                        </td>
                        <td>${deletedDate}</td>
                        <td>
                            <button class="btn btn-sm btn-success" onclick="restoreItem('${uniqueIdentifier}', '${item.id || ''}')" title="Ø§Ø³ØªØ¹Ø§Ø¯Ø©">
                                <i class="fas fa-undo"></i> Ø§Ø³ØªØ¹Ø§Ø¯Ø©
                            </button>
                            <button class="btn btn-sm btn-danger ms-2" onclick="permanentDelete('${uniqueIdentifier}', '${item.id || ''}')" title="Ø­Ø°Ù Ù†Ù‡Ø§Ø¦ÙŠ">
                                <i class="fas fa-trash"></i> Ø­Ø°Ù Ù†Ù‡Ø§Ø¦ÙŠ
                            </button>
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }

        // Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø¹Ù†ØµØ±
        async function restoreItem(uniqueId, firebaseId) {
            console.log('ğŸ”„ Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¹Ù†ØµØ±:', { uniqueId, firebaseId });
            if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù†ØµØ±ØŸ')) {
                try {
                    let restored = false;
                    
                    // Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ù…Ù† Firebase
                    if (window.firebaseModules && window.db) {
                        try {
                            console.log('ğŸ“¡ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø¹Ù†ØµØ± ÙÙŠ Firebase...', uniqueId);
                            
                            // Ø¬Ø±Ø¨ Ø§Ù„Ø¨Ø­Ø« Ø¨Ù€ uniqueId Ø£ÙˆÙ„Ø§Ù‹ (Ù„Ù„Ø´Ù‡Ø§Ø¯Ø§Øª)
                            let q = window.firebaseModules.query(
                                window.firebaseModules.collection(window.db, 'certificates'),
                                window.firebaseModules.where('uniqueId', '==', uniqueId)
                            );
                            
                            let querySnapshot = await window.firebaseModules.getDocs(q);
                            
                            // Ø¥Ø°Ø§ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„ÙŠÙ‡ØŒ Ø¬Ø±Ø¨ Ø§Ù„Ø¨Ø­Ø« Ø¨Ù€ serviceCode
                            if (querySnapshot.empty) {
                                console.log('ğŸ”„ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¨Ù€ uniqueIdØŒ Ø¬Ø±Ø¨ serviceCode...');
                                q = window.firebaseModules.query(
                                    window.firebaseModules.collection(window.db, 'certificates'),
                                    window.firebaseModules.where('serviceCode', '==', uniqueId)
                                );
                                querySnapshot = await window.firebaseModules.getDocs(q);
                            }
                            
                            if (!querySnapshot.empty) {
                                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù†ØµØ± Ù‚Ø¨Ù„ Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø©
                                const docData = querySnapshot.docs[0].data();
                                const docRef = querySnapshot.docs[0].ref;
                                
                                // ØªØ­Ø¯ÙŠØ¯ Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù†ØµØ±
                                const isHealthCertificate = docData.amanah || docData.uniqueId || !docData.idNumber;
                                const isMedicalLeave = docData.serviceCode && docData.idNumber && !docData.amanah;
                                
                                console.log('ğŸ” Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù†ØµØ±:', { 
                                    isHealthCertificate, 
                                    isMedicalLeave, 
                                    hasAmanah: !!docData.amanah,
                                    hasUniqueId: !!docData.uniqueId,
                                    hasIdNumber: !!docData.idNumber 
                                });
                                
                                await window.firebaseModules.updateDoc(docRef, {
                                    deleted: false,
                                    deletedAt: null,
                                    restoredAt: new Date().toISOString()
                                });
                                restored = true;
                                
                                if (isHealthCertificate) {
                                    console.log('âœ… ØªÙ… Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø´Ù‡Ø§Ø¯Ø© Ø§Ù„ØµØ­ÙŠØ© ÙÙŠ Firebase');
                                    // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø§Øª ÙÙ‚Ø·
                                    setTimeout(() => loadCertificatesFromFirebase(), 500);
                                } else if (isMedicalLeave) {
                                    console.log('âœ… ØªÙ… Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¥Ø¬Ø§Ø²Ø© Ø§Ù„Ù…Ø±Ø¶ÙŠØ© ÙÙŠ Firebase');
                                    // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø¬Ø§Ø²Ø§Øª Ø§Ù„Ù…Ø±Ø¶ÙŠØ© ÙÙ‚Ø·
                                    setTimeout(() => loadMedicalLeavesFromFirebase(), 500);
                                } else {
                                    console.log('âœ… ØªÙ… Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¹Ù†ØµØ± ÙÙŠ Firebase');
                                    // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ ÙƒÙ„ Ø´ÙŠØ¡
                                    setTimeout(() => {
                                        loadCertificatesFromFirebase();
                                        loadMedicalLeavesFromFirebase();
                                    }, 500);
                                }
                            } else {
                                console.log('âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ù†ØµØ± ÙÙŠ Firebase');
                            }
                        } catch (error) {
                            console.error('âŒ ÙØ´Ù„ ÙÙŠ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¹Ù†ØµØ± Ù…Ù† Firebase:', error);
                        }
                    }
                    
                    // Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ù…Ù† localStorage
                    console.log('ğŸ’¾ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ù…Ù† localStorage...');
                    const localData = localStorage.getItem('certificates');
                    if (localData) {
                        const certificates = JSON.parse(localData);
                        let foundInCertificates = false;
                        const updatedCertificates = certificates.map(cert => {
                            if (cert.uniqueId === uniqueId || cert.serviceCode === uniqueId) {
                                foundInCertificates = true;
                                console.log('âœ… ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø© ÙÙŠ localStorage:', cert.name || cert.fullName);
                                return { 
                                    ...cert, 
                                    deleted: false, 
                                    deletedAt: null,
                                    restoredAt: new Date().toISOString()
                                };
                            }
                            return cert;
                        });
                        localStorage.setItem('certificates', JSON.stringify(updatedCertificates));
                        if (foundInCertificates) {
                            console.log('âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø´Ù‡Ø§Ø¯Ø© ÙÙŠ localStorage');
                        }
                    }
                    
                    // Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¥Ø¬Ø§Ø²Ø§Øª Ø§Ù„Ù…Ø±Ø¶ÙŠØ© Ù…Ù† localStorage Ø§Ù„Ù…Ù†ÙØµÙ„
                    console.log('ğŸ¥ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø¥Ø¬Ø§Ø²Ø§Øª Ø§Ù„Ù…Ø±Ø¶ÙŠØ© ÙÙŠ localStorage...');
                    const allKeys = Object.keys(localStorage);
                    const medicalLeaveKeys = allKeys.filter(key => key.startsWith('medical-leave-'));
                    console.log(`ğŸ” ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ${medicalLeaveKeys.length} Ø¥Ø¬Ø§Ø²Ø© Ù…Ø±Ø¶ÙŠØ© ÙÙŠ localStorage`);
                    
                    let foundMedicalLeave = false;
                    medicalLeaveKeys.forEach(key => {
                        const medicalLeaveData = localStorage.getItem(key);
                        if (medicalLeaveData) {
                            const medicalLeave = JSON.parse(medicalLeaveData);
                            console.log(`ğŸ” ÙØ­Øµ Ø§Ù„Ø¥Ø¬Ø§Ø²Ø© Ø§Ù„Ù…Ø±Ø¶ÙŠØ©: ${key} - serviceCode: ${medicalLeave.serviceCode} - deleted: ${medicalLeave.deleted}`);
                            if (medicalLeave.serviceCode === uniqueId && medicalLeave.deleted) {
                                foundMedicalLeave = true;
                                medicalLeave.deleted = false;
                                medicalLeave.deletedAt = null;
                                medicalLeave.restoredAt = new Date().toISOString();
                                localStorage.setItem(key, JSON.stringify(medicalLeave));
                                console.log('âœ… ØªÙ… Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¥Ø¬Ø§Ø²Ø© Ø§Ù„Ù…Ø±Ø¶ÙŠØ© Ù…Ù† localStorage:', key);
                            }
                        }
                    });
                    
                    if (!foundMedicalLeave) {
                        console.log('âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¥Ø¬Ø§Ø²Ø© Ù…Ø±Ø¶ÙŠØ© Ù…Ø­Ø°ÙˆÙØ© Ø¨Ù‡Ø°Ø§ Ø§Ù„Ù…Ø¹Ø±Ù');
                    }
                    
                    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø±Ø¶ - Ø§Ù„Ù…Ø­Ø°ÙˆÙØ§Øª ÙÙ‚Ø· (Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø®Ø±Ù‰ ØªØªØ­Ø¯Ø« ÙÙŠ Firebase)
                    loadDeletedItems();
                    
                    alert('ØªÙ… Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¹Ù†ØµØ± Ø¨Ù†Ø¬Ø§Ø­!');
                    
                } catch (error) {
                    console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¹Ù†ØµØ±:', error);
                    alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¹Ù†ØµØ±.');
                }
            }
        }

        // Ø­Ø°Ù Ù†Ù‡Ø§Ø¦ÙŠ
        async function permanentDelete(uniqueId, firebaseId) {
            if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø­Ø°Ù Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØŸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡!')) {
                try {
                    let deleted = false;
                    
                    // Ø­Ø°Ù Ù…Ù† Firebase
                    if (window.firebaseModules && window.db) {
                        try {
                            console.log('ğŸ“¡ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø¹Ù†ØµØ± ÙÙŠ Firebase Ù„Ù„Ø­Ø°Ù Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ...', uniqueId);
                            
                            // Ø¬Ø±Ø¨ Ø§Ù„Ø¨Ø­Ø« Ø¨Ù€ uniqueId Ø£ÙˆÙ„Ø§Ù‹ (Ù„Ù„Ø´Ù‡Ø§Ø¯Ø§Øª)
                            let q = window.firebaseModules.query(
                                window.firebaseModules.collection(window.db, 'certificates'),
                                window.firebaseModules.where('uniqueId', '==', uniqueId)
                            );
                            
                            let querySnapshot = await window.firebaseModules.getDocs(q);
                            
                            // Ø¥Ø°Ø§ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„ÙŠÙ‡ØŒ Ø¬Ø±Ø¨ Ø§Ù„Ø¨Ø­Ø« Ø¨Ù€ serviceCode (Ù„Ù„Ø¥Ø¬Ø§Ø²Ø§Øª Ø§Ù„Ù…Ø±Ø¶ÙŠØ©)
                            if (querySnapshot.empty) {
                                console.log('ğŸ”„ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¨Ù€ uniqueIdØŒ Ø¬Ø±Ø¨ serviceCode...');
                                q = window.firebaseModules.query(
                                    window.firebaseModules.collection(window.db, 'certificates'),
                                    window.firebaseModules.where('serviceCode', '==', uniqueId)
                                );
                                querySnapshot = await window.firebaseModules.getDocs(q);
                            }
                            
                            if (!querySnapshot.empty) {
                                const docRef = querySnapshot.docs[0].ref;
                                await window.firebaseModules.deleteDoc(docRef);
                                deleted = true;
                                console.log('âœ… ØªÙ… Ø§Ù„Ø­Ø°Ù Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ Ù…Ù† Firebase');
                            } else {
                                console.log('âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ù†ØµØ± ÙÙŠ Firebase');
                            }
                        } catch (error) {
                            console.error('âŒ ÙØ´Ù„ ÙÙŠ Ø§Ù„Ø­Ø°Ù Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ Ù…Ù† Firebase:', error);
                        }
                    }
                    
                    // Ø­Ø°Ù Ù…Ù† localStorage
                    const localData = localStorage.getItem('certificates');
                    if (localData) {
                        const certificates = JSON.parse(localData);
                        const updatedCertificates = certificates.filter(cert => 
                            cert.uniqueId !== uniqueId && cert.serviceCode !== uniqueId
                        );
                        localStorage.setItem('certificates', JSON.stringify(updatedCertificates));
                    }
                    
                    // Ø­Ø°Ù Ø§Ù„Ø¥Ø¬Ø§Ø²Ø§Øª Ø§Ù„Ù…Ø±Ø¶ÙŠØ© Ù…Ù† localStorage Ø§Ù„Ù…Ù†ÙØµÙ„
                    const allKeys = Object.keys(localStorage);
                    const medicalLeaveKeys = allKeys.filter(key => key.startsWith('medical-leave-'));
                    
                    medicalLeaveKeys.forEach(key => {
                        const medicalLeaveData = localStorage.getItem(key);
                        if (medicalLeaveData) {
                            const medicalLeave = JSON.parse(medicalLeaveData);
                            if (medicalLeave.serviceCode === uniqueId) {
                                localStorage.removeItem(key);
                                console.log('âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¥Ø¬Ø§Ø²Ø© Ø§Ù„Ù…Ø±Ø¶ÙŠØ© Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ Ù…Ù† localStorage:', key);
                            }
                        }
                    });
                    
                    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø±Ø¶
                    loadDeletedItems();
                    
                    alert('ØªÙ… Ø§Ù„Ø­Ø°Ù Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ Ø¨Ù†Ø¬Ø§Ø­!');
                    
                } catch (error) {
                    console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­Ø°Ù Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ:', error);
                    alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­Ø°Ù Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ.');
                }
            }
        }
    </script>
</body>
</html>
